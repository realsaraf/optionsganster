<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionsGanster - VPA Analysis</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100vh;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            display: flex;
            flex-direction: column;
        }
        
        /* ===== WATCHLIST SIDEBAR (LEFT) ===== */
        .watchlist-sidebar {
            width: 220px;
            background: #1e222d;
            border-right: 1px solid #2a2e39;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .watchlist-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .watchlist-header h2 {
            font-size: 13px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .watchlist-add-btn {
            background: transparent;
            border: none;
            color: #2962ff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .watchlist-add-btn:hover {
            background: rgba(41, 98, 255, 0.1);
        }
        
        .watchlist-search {
            padding: 8px 12px;
            border-bottom: 1px solid #2a2e39;
        }
        
        .watchlist-search input {
            width: 100%;
            background: #131722;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 8px 12px;
            color: #d1d4dc;
            font-size: 13px;
        }
        
        .watchlist-search input:focus {
            outline: none;
            border-color: #2962ff;
        }
        
        .watchlist-search input::placeholder {
            color: #787b86;
        }
        
        .watchlist-items {
            flex: 1;
            overflow-y: auto;
        }
        
        .watchlist-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #2a2e39;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .watchlist-item:hover {
            background: #2a2e39;
        }
        
        .watchlist-item.selected {
            background: #2962ff20;
            border-left: 3px solid #2962ff;
        }
        
        .watchlist-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .watchlist-symbol {
            font-size: 14px;
            font-weight: 600;
            color: #d1d4dc;
        }
        
        .watchlist-name {
            font-size: 11px;
            color: #787b86;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .watchlist-price-info {
            text-align: right;
        }
        
        .watchlist-price {
            font-size: 14px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .watchlist-change {
            font-size: 11px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .watchlist-change.positive {
            color: #26a69a;
        }
        
        .watchlist-change.negative {
            color: #ef5350;
        }
        
        .price-flash {
            animation: flash 0.3s ease-out;
        }
        
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .price-up {
            color: #26a69a !important;
        }
        
        .price-down {
            color: #ef5350 !important;
        }
        
        /* ===== MAIN LAYOUT ===== */
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: 100vh;
        }
        
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;
            overflow: hidden;
        }
        
        /* ===== HEADER ===== */
        .header {
            background: #1e222d;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-logo h1 {
            font-size: 18px;
            font-weight: 700;
            color: #2962ff;
        }
        
        .header-logo h1 span {
            color: #ef5350;
        }
        
        .header-contract {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
            background: #131722;
            border-radius: 6px;
        }
        
        .contract-symbol {
            font-size: 16px;
            font-weight: 700;
            color: #d1d4dc;
        }
        
        .contract-details {
            font-size: 12px;
            color: #787b86;
        }
        
        .contract-price {
            font-size: 18px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .contract-change {
            font-size: 13px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .contract-change.positive { color: #26a69a; }
        .contract-change.negative { color: #ef5350; }
        
        .logout-btn {
            margin-left: auto;
            color: #787b86;
            text-decoration: none;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 4px;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .logout-btn:hover {
            color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
        }
        
        /* ===== CONTROLS BAR ===== */
        .controls-bar {
            background: #1e222d;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .control-group label {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
        }
        
        .control-group select,
        .control-group input {
            background: #131722;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 6px 10px;
            color: #d1d4dc;
            font-size: 13px;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #2962ff;
        }
        
        .interval-buttons {
            display: flex;
            gap: 2px;
            background: #131722;
            padding: 2px;
            border-radius: 4px;
        }
        
        .interval-btn {
            background: transparent;
            border: none;
            color: #787b86;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.15s;
        }
        
        .interval-btn:hover {
            color: #d1d4dc;
        }
        
        .interval-btn.active {
            background: #2962ff;
            color: white;
        }
        
        .analyze-btn {
            background: #2962ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .analyze-btn:hover {
            background: #1e53e4;
        }
        
        .analyze-btn:disabled {
            background: #363a45;
            cursor: not-allowed;
        }
        
        /* ===== LIVE BUTTON ===== */
        .live-btn {
            background: #363a45;
            color: #787b86;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        
        .live-btn:hover {
            background: #4a4e59;
            color: #d1d4dc;
        }
        
        .live-btn.active {
            background: #ef5350;
            color: white;
            animation: live-pulse 2s ease-in-out infinite;
        }
        
        @keyframes live-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(239, 83, 80, 0);
            }
        }
        
        /* ===== CONTROLS SUMMARY (Mobile only) ===== */
        .controls-summary {
            display: none;
            background: #1e222d;
            padding: 4px 8px;
            border-bottom: 1px solid #2a2e39;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
            height: 32px;
            overflow: hidden;
        }
        
        .summary-text {
            font-size: 11px;
            color: #d1d4dc;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }
        
        .summary-intervals {
            display: none; /* Hidden on mobile collapsed mode */
        }
        
        .summary-interval-btn {
            padding: 4px 8px;
            font-size: 10px;
        }
        
        .summary-analyze-btn {
            padding: 4px 8px;
            font-size: 14px;
            min-width: 28px;
            background: transparent;
            border: 1px solid #2a2e39;
        }
        
        .summary-analyze-btn:hover {
            background: rgba(41, 98, 255, 0.1);
            border-color: #2962ff;
        }
        
        .summary-live-btn {
            display: none; /* Hidden on mobile collapsed mode */
        }
        
        .summary-live-indicator {
            font-size: 10px;
            color: #787b86;
            white-space: nowrap;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(120, 123, 134, 0.1);
        }
        
        .summary-live-indicator.active {
            color: #ef5350;
            background: rgba(239, 83, 80, 0.15);
        }
        
        .controls-chevron {
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 14px;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        
        .controls-chevron:hover {
            background: rgba(120, 123, 134, 0.1);
            color: #d1d4dc;
        }
        
        .controls-bar.collapsed {
            display: none;
        }
        
        /* ===== SIGNAL PEEK (Mobile only) ===== */
        .signal-peek {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to right, rgba(38, 166, 154, 0.15), #1e222d);
            border-top: 3px solid #26a69a;
            padding: 12px 16px;
            z-index: 998;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            cursor: pointer;
            min-height: 68px;
        }
        
        .signal-peek.visible {
            transform: translateY(0);
        }
        
        .signal-peek.bearish {
            border-top-color: #ef5350;
            background: linear-gradient(to right, rgba(239, 83, 80, 0.15), #1e222d);
        }
        
        .signal-peek-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .signal-peek-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .signal-peek-name {
            font-size: 14px;
            font-weight: 700;
            color: #d1d4dc;
            flex: 1;
        }
        
        .signal-peek-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .signal-peek-badge.bullish {
            background: rgba(38, 166, 154, 0.2);
            color: #26a69a;
        }
        
        .signal-peek-badge.bearish {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }
        
        .signal-peek-details {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        
        .signal-peek-description {
            font-size: 11px;
            color: #9ca3af;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .signal-peek-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .signal-peek-confidence {
            color: #2962ff;
            font-weight: 600;
        }
        
        .signal-peek-time {
            font-size: 10px;
            color: #787b86;
        }
        
        .signal-peek-price {
            font-size: 13px;
            font-weight: 600;
            color: #2962ff;
        }
        
        .live-refreshing {
            position: relative;
        }
        
        .live-refreshing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #2962ff, transparent);
            animation: live-refresh-slide 1.5s ease-in-out infinite;
        }
        
        @keyframes live-refresh-slide {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* ===== CHART AREA ===== */
        .chart-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        
        .charts-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #131722;
            min-height: 0;
            min-width: 0;
        }
        
        #price-chart {
            flex: 3;
            min-height: 0;
        }
        
        #volume-chart {
            flex: 1;
            border-top: 1px solid #2a2e39;
            min-height: 0;
        }
        
        .chart-legend {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(30, 34, 45, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
        }
        
        .chart-legend .ohlc {
            display: flex;
            gap: 16px;
        }
        
        .chart-legend .ohlc span {
            color: #787b86;
        }
        
        .chart-legend .ohlc span strong {
            color: #d1d4dc;
            font-weight: 600;
        }
        
        /* ===== ANALYSIS SIDEBAR (RIGHT) ===== */
        .analysis-sidebar {
            width: 320px;
            background: #1e222d;
            border-left: 1px solid #2a2e39;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            min-height: 0;
            overflow: hidden;
        }
        
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #2a2e39;
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }
        
        .sidebar-tab:hover {
            color: #d1d4dc;
        }
        
        .sidebar-tab.active {
            color: #2962ff;
            border-bottom-color: #2962ff;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        /* Bias Indicator */
        .bias-card {
            background: #131722;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .bias-card h4 {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .bias-indicator {
            text-align: center;
            padding: 16px;
            border-radius: 6px;
        }
        
        .bias-indicator.bullish {
            background: rgba(38, 166, 154, 0.1);
            border: 1px solid #26a69a;
        }
        
        .bias-indicator.bearish {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid #ef5350;
        }
        
        .bias-indicator.neutral {
            background: rgba(120, 123, 134, 0.1);
            border: 1px solid #787b86;
        }
        
        .bias-label {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .bias-indicator.bullish .bias-label { color: #26a69a; }
        .bias-indicator.bearish .bias-label { color: #ef5350; }
        .bias-indicator.neutral .bias-label { color: #787b86; }
        
        .bias-strength {
            font-size: 13px;
            color: #787b86;
            margin-top: 8px;
        }
        
        .bias-reason {
            font-size: 12px;
            color: #5d606b;
            margin-top: 4px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            background: #131722;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #d1d4dc;
        }
        
        .stat-label {
            font-size: 11px;
            color: #787b86;
            margin-top: 4px;
        }
        
        /* Signals List */
        .signals-header {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .signal-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .signal-item {
            background: #131722;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid;
        }
        
        .signal-item.bullish { border-color: #26a69a; }
        .signal-item.bearish { border-color: #ef5350; }
        
        .signal-time {
            font-size: 11px;
            color: #5d606b;
        }
        
        .signal-name {
            font-size: 13px;
            font-weight: 600;
            color: #d1d4dc;
            margin: 4px 0;
        }
        
        .signal-desc {
            font-size: 12px;
            color: #787b86;
        }
        
        .signal-meta {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 11px;
            color: #5d606b;
        }
        
        /* Loading & Error States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #787b86;
        }
        
        .error-message {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid #ef5350;
            color: #ef5350;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        /* ===== SIGNAL FILTER TOGGLES ===== */
        .filter-bar {
            background: #1e222d;
            padding: 6px 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #2a2e39;
        }

        .filter-bar .filter-label {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-right: 2px;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-group .toggle-text {
            font-size: 11px;
            color: #5d606b;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: color 0.2s;
        }

        .toggle-group .toggle-text.active {
            color: #d1d4dc;
        }

        .toggle-switch {
            position: relative;
            width: 30px;
            height: 16px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #363a45;
            border-radius: 16px;
            transition: background 0.2s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 10px;
            width: 10px;
            left: 3px;
            bottom: 3px;
            background: #787b86;
            border-radius: 50%;
            transition: transform 0.2s, background 0.2s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #2962ff;
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(14px);
            background: #fff;
        }

        .toggle-group.bullish-color .toggle-switch input:checked + .toggle-slider {
            background: #26a69a;
        }

        .toggle-group.bearish-color .toggle-switch input:checked + .toggle-slider {
            background: #ef5350;
        }

        .toggle-group.neutral-color .toggle-switch input:checked + .toggle-slider {
            background: #5d606b;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #131722;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #363a45;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4e59;
        }

        /* ===== MOBILE TOGGLE BUTTONS ===== */
        .mobile-menu-toggle,
        .mobile-analysis-toggle {
            display: none;
            position: fixed;
            z-index: 1001;
            background: #2962ff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .mobile-menu-toggle {
            top: 12px;
            left: 12px;
        }

        .mobile-analysis-toggle {
            bottom: 20px;
            right: 20px;
        }

        .mobile-menu-toggle:active,
        .mobile-analysis-toggle:active {
            transform: scale(0.95);
        }

        .mobile-close-btn {
            display: none;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .mobile-close-btn:hover {
            background: rgba(120, 123, 134, 0.1);
            color: #d1d4dc;
        }

        .backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }

        .backdrop.active {
            display: block;
        }

        /* ===== MOBILE RESPONSIVE (‚â§768px) ===== */
        @media (max-width: 768px) {
            /* Allow scrolling on mobile */
            html, body {
                overflow: auto;
            }

            .main-panel {
                overflow: visible;
            }

            /* Show mobile toggle buttons */
            .mobile-menu-toggle,
            .mobile-analysis-toggle {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            /* Watchlist Sidebar - Hidden by default, overlay when open */
            .watchlist-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 280px;
                max-width: 85vw;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                z-index: 1000;
            }

            .watchlist-sidebar.mobile-open {
                transform: translateX(0);
            }

            /* Show close button in watchlist header on mobile */
            .watchlist-sidebar .mobile-close-btn {
                display: block;
            }

            /* Analysis Sidebar - Hidden by default, overlay when open */
            .analysis-sidebar {
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 90vw;
                max-width: 400px;
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 1000;
            }

            .analysis-sidebar.mobile-open {
                transform: translateX(0);
            }

            /* Header - Stack vertically */
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                padding: 60px 16px 12px 16px; /* Extra top padding for mobile menu button */
            }

            .header-logo h1 {
                font-size: 16px;
            }

            .header-contract {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .contract-symbol {
                font-size: 14px;
            }

            .contract-details {
                font-size: 11px;
            }

            .contract-price {
                font-size: 16px;
            }

            .logout-btn {
                position: absolute;
                top: 12px;
                right: 12px;
                margin-left: 0;
                font-size: 11px;
                padding: 8px 12px;
                z-index: 100;
            }

            .contract-change {
                font-size: 12px;
            }

            /* Controls Bar - Responsive layout */
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 12px;
            }

            .control-group {
                width: 100%;
            }

            .control-group select,
            .control-group input {
                flex: 1;
                width: 100%;
                min-width: 0;
                padding: 10px 12px; /* Larger for touch */
            }

            .control-group label {
                min-width: 50px;
            }

            /* Interval buttons - Make touch-friendly */
            .interval-buttons {
                width: 100%;
                justify-content: space-between;
            }

            .interval-btn {
                flex: 1;
                padding: 12px 8px; /* Larger for touch */
                min-height: 44px; /* Touch-friendly */
            }

            .analyze-btn {
                width: 100%;
                padding: 14px 20px; /* Larger for touch */
                min-height: 44px; /* Touch-friendly */
                font-size: 14px;
            }
            
            .live-btn {
                width: 100%;
                padding: 12px 20px;
                min-height: 44px;
                font-size: 13px;
            }
            
            /* Controls Summary - Hidden by default, shown after first analyze */
            .controls-summary {
                display: none;
            }
            
            .controls-summary.active {
                display: flex;
            }
            
            /* Signal Peek - Show on mobile only */
            .signal-peek {
                display: block;
            }
            
            /* Adjust mobile-analysis-toggle to not overlap peek */
            .mobile-analysis-toggle {
                bottom: 80px;
            }

            /* Chart Area - Allow scrolling */
            .chart-area {
                flex-direction: column;
                overflow: visible;
                min-height: 500px;
            }

            .charts-container {
                min-height: 400px;
            }

            /* Watchlist search - Larger for mobile */
            .watchlist-search input {
                padding: 12px 14px;
                font-size: 14px;
            }

            /* Watchlist items - Larger tap targets */
            .watchlist-item {
                padding: 14px 16px;
            }

            .watchlist-symbol {
                font-size: 15px;
            }

            .watchlist-name {
                font-size: 12px;
            }
        }

        /* ===== LANDSCAPE MOBILE RESPONSIVE (‚â§1024px width AND ‚â§500px height) ===== */
        @media (max-width: 1024px) and (max-height: 500px) {
            /* Allow scrolling on mobile */
            html, body {
                overflow: auto;
            }

            .main-panel {
                overflow: visible;
            }

            /* Show mobile toggle buttons */
            .mobile-menu-toggle,
            .mobile-analysis-toggle {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            /* Watchlist as overlay */
            .watchlist-sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                bottom: 0;
                width: 220px;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .watchlist-sidebar.mobile-open {
                left: 0;
            }

            /* Analysis sidebar as overlay */
            .analysis-sidebar {
                position: fixed;
                right: -280px;
                top: 0;
                bottom: 0;
                width: 260px;
                z-index: 1000;
                transition: right 0.3s ease;
                overflow-y: auto;
            }

            .analysis-sidebar.mobile-open {
                right: 0;
            }

            /* Show mobile close buttons */
            .mobile-close-btn {
                display: block;
            }

            /* Main panel takes full width */
            .main-panel {
                flex: 1;
                width: 100%;
            }

            /* Header adjustments for mobile buttons */
            .header {
                padding-top: 60px;
            }

            .logout-btn {
                position: absolute;
                top: 12px;
                right: 12px;
                margin-left: 0;
                font-size: 11px;
                padding: 8px 12px;
                z-index: 100;
            }

            /* Controls Summary - Hidden by default, shown after first analyze */
            .controls-summary {
                display: none;
            }
            
            .controls-summary.active {
                display: flex;
            }
            
            /* Signal Peek - Show on mobile only */
            .signal-peek {
                display: block;
            }
            
            /* Adjust mobile-analysis-toggle to not overlap peek */
            .mobile-analysis-toggle {
                bottom: 80px;
            }

            /* Chart Area - Allow scrolling */
            .chart-area {
                flex-direction: column;
                overflow: visible;
                min-height: 500px;
            }

            .charts-container {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle Watchlist">
        ‚ò∞ <span>Watchlist</span>
    </button>

    <!-- Mobile Analysis Toggle Button -->
    <button class="mobile-analysis-toggle" id="mobile-analysis-toggle" aria-label="Toggle Analysis">
        üìä <span>Analysis</span>
    </button>

    <!-- Backdrop for mobile overlays -->
    <div class="backdrop" id="backdrop"></div>

    <div class="app-container">
        <!-- LEFT: Watchlist Sidebar -->
        <div class="watchlist-sidebar" id="watchlist-sidebar">
            <div class="watchlist-header">
                <h2>Watchlist</h2>
                <button class="mobile-close-btn" id="watchlist-close-btn" aria-label="Close Watchlist">√ó</button>
                <button class="watchlist-add-btn" title="Add Symbol">+</button>
            </div>
            <div class="watchlist-search">
                <input type="text" id="watchlist-search" placeholder="Search symbols...">
            </div>
            <div class="watchlist-items" id="watchlist-container">
                <!-- Watchlist items will be populated here -->
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- MAIN: Chart & Controls -->
        <div class="main-panel">
            <div class="header">
                <div class="header-logo">
                    <h1>Options<span>Ganster</span></h1>
                </div>
                <div class="header-contract" id="contract-info">
                    <div>
                        <div class="contract-symbol" id="contract-symbol">-</div>
                        <div class="contract-details" id="contract-details">Select a symbol</div>
                    </div>
                    <div>
                        <div class="contract-price" id="contract-price">-</div>
                        <div class="contract-change" id="contract-change">-</div>
                    </div>
                </div>
                <a href="/api/logout" class="logout-btn" title="Sign Out">‚èª Logout</a>
            </div>
            
            <!-- Controls Summary Bar (Mobile only, shown after first analyze) -->
            <div class="controls-summary" id="controls-summary">
                <button class="analyze-btn summary-analyze-btn" id="summary-analyze-btn">‚ñ∂</button>
                <span class="summary-text" id="summary-text">SPY $500C 5m</span>
                <span class="summary-live-indicator" id="summary-live-indicator"></span>
                <button class="controls-chevron" id="controls-chevron">‚ñº</button>
            </div>
            
            <div class="controls-bar" id="controls-bar">
                <div class="control-group">
                    <label>Exp</label>
                    <select id="expiration" style="min-width: 140px;">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Strike</label>
                    <select id="strike" style="min-width: 100px;">
                        <option value="">-</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Type</label>
                    <select id="right" style="min-width: 70px;">
                        <option value="C">Call</option>
                        <option value="P">Put</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>From</label>
                    <input type="date" id="start-date" style="width: 130px;">
                </div>
                
                <div class="control-group">
                    <label>To</label>
                    <input type="date" id="end-date" style="width: 130px;">
                </div>
                
                <div class="interval-buttons">
                    <button class="interval-btn" data-interval="1">1m</button>
                    <button class="interval-btn active" data-interval="5">5m</button>
                    <button class="interval-btn" data-interval="15">15m</button>
                    <button class="interval-btn" data-interval="60">1H</button>
                </div>
                
                <button class="analyze-btn" id="analyze-btn">‚ñ∂ Analyze</button>
                <button class="live-btn" id="live-btn">‚ö™ LIVE</button>
            </div>

            <div class="filter-bar" id="filter-bar">
                <span class="filter-label">Signals:</span>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-strong_bullish" checked><span class="toggle-slider"></span></label>
                    <span class="toggle-text active" data-for="filter-strong_bullish">Strong Bullish</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-strong_bearish" checked><span class="toggle-slider"></span></label>
                    <span class="toggle-text active" data-for="filter-strong_bearish">Strong Bearish</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-accumulation"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-accumulation">Accumulation</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-distribution"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-distribution">Distribution</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-test_support"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-test_support">Test Support</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-test_resistance"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-test_resistance">Test Resistance</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-climax_bottom"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-climax_bottom">Climax Bottom</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-climax_top"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-climax_top">Climax Top</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-weak_down"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-weak_down">Weak Down</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-weak_up"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-weak_up">Weak Up</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-no_supply"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-no_supply">No Supply</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-no_demand"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-no_demand">No Demand</span>
                </div>

                <div class="toggle-group neutral-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-neutral"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-neutral">Neutral</span>
                </div>
            </div>
            
            <div class="chart-area">
                <div class="charts-container">
                    <div id="price-chart"></div>
                    <div id="volume-chart"></div>
                </div>
                
                <!-- RIGHT: Analysis Sidebar -->
                <div class="analysis-sidebar" id="analysis-sidebar">
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" data-tab="analysis">Analysis</button>
                        <button class="sidebar-tab" data-tab="signals">Signals</button>
                        <button class="mobile-close-btn" id="analysis-close-btn" aria-label="Close Analysis">√ó</button>
                    </div>
                    
                    <div class="sidebar-content" id="sidebar-content">
                        <div class="bias-card">
                            <h4>Market Bias</h4>
                            <div id="bias-container" class="bias-indicator neutral">
                                <div class="bias-label">-</div>
                                <div class="bias-strength">Load data to analyze</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid" id="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bars">-</div>
                                <div class="stat-label">Bars</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-signals">-</div>
                                <div class="stat-label">Signals</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bullish">-</div>
                                <div class="stat-label">Bullish</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bearish">-</div>
                                <div class="stat-label">Bearish</div>
                            </div>
                        </div>
                        
                        <div class="signals-header">Recent Signals</div>
                        <div id="signals-container" class="signal-list">
                            <div class="loading">No signals yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Signal Peek Banner (Mobile only) -->
    <div class="signal-peek" id="signal-peek">
        <div class="signal-peek-content">
            <div class="signal-peek-header">
                <span class="signal-peek-name" id="signal-peek-name">-</span>
                <span class="signal-peek-badge bullish" id="signal-peek-badge">BULLISH</span>
            </div>
            <div class="signal-peek-details">
                <span class="signal-peek-description" id="signal-peek-description">-</span>
                <div class="signal-peek-meta">
                    <span class="signal-peek-confidence" id="signal-peek-confidence">-</span>
                    <span class="signal-peek-time" id="signal-peek-time">-</span>
                    <span class="signal-peek-price" id="signal-peek-price">-</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ===== STATE =====
        let priceChart = null;
        let volumeChart = null;
        let candlestickSeries = null;
        let volumeSeries = null;
        let currentInterval = 5;
        let currentSymbol = 'SPY';
        let watchlistData = {};
        let priceUpdateInterval = null;
        
        // Live mode state
        let liveMode = false;
        let liveInterval = null;
        let liveCountdown = 10;
        let liveCountdownInterval = null;
        
        // Controls collapse state
        let controlsCollapsed = false;
        let hasAnalyzed = false;
        
        // Signal peek state
        let latestSignalData = null;

        // Last analysis data for re-filtering
        let lastAnalysisData = null;

        // ===== TIMEZONE HELPER =====
        // Convert a UTC datetime string to a Unix timestamp in US/Eastern
        // lightweight-charts treats timestamps as UTC, so we shift by the ET offset
        function toEasternUnix(datetimeStr) {
            const d = new Date(datetimeStr);
            // Format in America/New_York to get the ET offset
            const eastern = new Date(d.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            // Difference = how far ET is from UTC (in seconds)
            // We return eastern time as if it were UTC so the chart axis shows ET
            return Math.floor(eastern.getTime() / 1000);
        }

        function toEasternString(datetimeStr) {
            return new Date(datetimeStr).toLocaleString('en-US', { timeZone: 'America/New_York' });
        }

        // ===== SIGNAL FILTER HELPERS =====
        function getEnabledSignals() {
            const enabled = new Set();
            document.querySelectorAll('.filter-bar input[type=checkbox]').forEach(cb => {
                if (cb.checked) enabled.add(cb.id.replace('filter-', ''));
            });
            return enabled;
        }

        function filterSignals(signals) {
            const enabled = getEnabledSignals();
            return signals.filter(s => enabled.has(s.signal));
        }

        function updateFilteredMarkers(signals) {
            if (!candlestickSeries) return;
            const filtered = filterSignals(signals);
            const markers = filtered.map(signal => {
                const isBullish = BULLISH_SIGNALS.includes(signal.signal);
                return {
                    time: toEasternUnix(signal.datetime),
                    position: isBullish ? 'belowBar' : 'aboveBar',
                    color: isBullish ? '#26a69a' : '#ef5350',
                    shape: isBullish ? 'arrowUp' : 'arrowDown',
                    text: signal.signal.replace('_', ' '),
                };
            });
            markers.sort((a, b) => a.time - b.time);
            candlestickSeries.setMarkers(markers);
        }
        
        // Chart data tracking for incremental updates
        let currentBarTimestamps = new Set();
        
        // Mobile responsiveness breakpoints
        // Portrait mobile: width <= 768px (standard mobile breakpoint)
        // Landscape mobile: width <= 1024px AND height <= 500px
        // This ensures phones in landscape (e.g., iPhone X: 812x375) are detected as mobile
        // while tablets in landscape (typically height > 500px) are treated as desktop
        const MOBILE_MAX_WIDTH = 768;
        const LANDSCAPE_MAX_WIDTH = 1024;
        const LANDSCAPE_MAX_HEIGHT = 500;
        
        // Wire up filter toggle events
        document.querySelectorAll('.filter-bar input[type=checkbox]').forEach(cb => {
            cb.addEventListener('change', () => {
                const label = document.querySelector(`[data-for="${cb.id}"]`);
                if (label) label.classList.toggle('active', cb.checked);
                if (lastAnalysisData) {
                    updateFilteredMarkers(lastAnalysisData.signals || []);
                    updateAnalysis(lastAnalysisData);
                }
            });
        });
        document.querySelectorAll('.filter-bar .toggle-text').forEach(label => {
            label.addEventListener('click', () => {
                const cb = document.getElementById(label.dataset.for);
                if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
            });
        });

        // Signal type constants
        const BULLISH_SIGNALS = [
            'strong_bullish', 'accumulation', 'test_support', 'climax_bottom', 
            'weak_down', 'no_supply', 'pin_bar_bull', 'confirmed_reversal_up'
        ];
        const BEARISH_SIGNALS = [
            'strong_bearish', 'distribution', 'test_resistance', 'climax_top', 
            'no_demand', 'pin_bar_bear', 'confirmed_reversal_down'
        ];
        
        // Default watchlist symbols with metadata
        const defaultWatchlist = [
            { symbol: 'SPY', name: 'S&P 500 ETF' },
            { symbol: 'QQQ', name: 'Nasdaq 100 ETF' },
            { symbol: 'IWM', name: 'Russell 2000 ETF' },
            { symbol: 'AAPL', name: 'Apple Inc' },
            { symbol: 'MSFT', name: 'Microsoft Corp' },
            { symbol: 'NVDA', name: 'NVIDIA Corp' },
            { symbol: 'TSLA', name: 'Tesla Inc' },
            { symbol: 'AMD', name: 'AMD Inc' },
            { symbol: 'AMZN', name: 'Amazon.com' },
            { symbol: 'META', name: 'Meta Platforms' },
            { symbol: 'GOOGL', name: 'Alphabet Inc' }
        ];

        // ===== AUTH HELPER =====
        async function authFetch(url, options) {
            const res = await fetch(url, options);
            if (res.status === 401) {
                window.location.href = '/login';
                throw new Error('Session expired');
            }
            return res;
        }

        // ===== MOBILE FUNCTIONS =====
        function isMobile() {
            // Check for portrait mobile or landscape mobile
            return window.innerWidth <= MOBILE_MAX_WIDTH || 
                   (window.innerWidth <= LANDSCAPE_MAX_WIDTH && window.innerHeight <= LANDSCAPE_MAX_HEIGHT);
        }

        function openWatchlist() {
            if (isMobile()) {
                document.getElementById('watchlist-sidebar').classList.add('mobile-open');
                document.getElementById('backdrop').classList.add('active');
            }
        }

        function closeWatchlist() {
            if (isMobile()) {
                document.getElementById('watchlist-sidebar').classList.remove('mobile-open');
                document.getElementById('backdrop').classList.remove('active');
            }
        }

        function toggleWatchlist() {
            const sidebar = document.getElementById('watchlist-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeWatchlist();
            } else {
                openWatchlist();
                // Close analysis if open
                closeAnalysis();
            }
        }

        function openAnalysis() {
            if (isMobile()) {
                document.getElementById('analysis-sidebar').classList.add('mobile-open');
                document.getElementById('backdrop').classList.add('active');
                // Hide signal peek when analysis is open
                document.getElementById('signal-peek').classList.remove('visible');
            }
        }

        function closeAnalysis() {
            if (isMobile()) {
                document.getElementById('analysis-sidebar').classList.remove('mobile-open');
                document.getElementById('backdrop').classList.remove('active');
                // Show signal peek when analysis closes (if data exists)
                if (latestSignalData) {
                    document.getElementById('signal-peek').classList.add('visible');
                }
            }
        }

        function toggleAnalysis() {
            const sidebar = document.getElementById('analysis-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeAnalysis();
            } else {
                openAnalysis();
                // Close watchlist if open
                closeWatchlist();
            }
        }

        function closeAllMobilePanels() {
            closeWatchlist();
            closeAnalysis();
        }

        function handleResize() {
            // Handle mobile controls visibility and state
            if (isMobile()) {
                // Cache DOM references
                const controlsSummary = document.getElementById('controls-summary');
                
                // Ensure controls-summary is active on mobile
                if (controlsSummary && !controlsSummary.classList.contains('active')) {
                    controlsSummary.classList.add('active');
                    collapseControls();
                }
            } else {
                // Reset mobile panels when switching to desktop
                closeAllMobilePanels();
                
                // Cache DOM references
                const controlsSummary = document.getElementById('controls-summary');
                const controlsBar = document.getElementById('controls-bar');
                
                // Reset controls state on desktop
                if (controlsSummary && controlsBar && controlsSummary.classList.contains('active')) {
                    controlsSummary.classList.remove('active');
                    controlsBar.classList.remove('collapsed');
                    controlsCollapsed = false;
                }
            }
            // Trigger chart resize
            if (priceChart && volumeChart) {
                setTimeout(() => {
                    priceChart.resize(
                        document.getElementById('price-chart').clientWidth,
                        document.getElementById('price-chart').clientHeight
                    );
                    volumeChart.resize(
                        document.getElementById('volume-chart').clientWidth,
                        document.getElementById('volume-chart').clientHeight
                    );
                }, 100);
            }
        }
        
        // ===== CONTROLS COLLAPSE FUNCTIONS =====
        function collapseControls() {
            if (isMobile()) {
                document.getElementById('controls-bar').classList.add('collapsed');
                document.getElementById('controls-summary').classList.add('active');
                document.getElementById('controls-chevron').textContent = '‚ñ≤';
                controlsCollapsed = true;
            }
        }
        
        function expandControls() {
            if (isMobile()) {
                document.getElementById('controls-bar').classList.remove('collapsed');
                document.getElementById('controls-chevron').textContent = '‚ñº';
                controlsCollapsed = false;
            }
        }
        
        function toggleControls() {
            if (controlsCollapsed) {
                expandControls();
            } else {
                collapseControls();
            }
        }
        
        function updateSummaryText() {
            const symbol = currentSymbol;
            const strike = document.getElementById('strike').value;
            const right = document.getElementById('right').value;
            const intervalText = currentInterval === 1 ? '1m' : currentInterval === 5 ? '5m' : currentInterval === 15 ? '15m' : '1H';
            
            if (strike) {
                const rightText = right === 'C' ? 'C' : 'P';
                document.getElementById('summary-text').textContent = `${symbol} $${strike}${rightText} ${intervalText}`;
            }
        }
        
        // ===== SIGNAL PEEK FUNCTIONS =====
        function updateSignalPeek(signals) {
            if (!signals || signals.length === 0) {
                latestSignalData = null;
                document.getElementById('signal-peek').classList.remove('visible');
                return;
            }
            
            const latestSignal = signals[signals.length - 1];
            latestSignalData = latestSignal;
            
            const isBullish = BULLISH_SIGNALS.includes(latestSignal.signal);
            
            const peek = document.getElementById('signal-peek');
            peek.className = `signal-peek ${isBullish ? '' : 'bearish'}`;
            
            document.getElementById('signal-peek-name').textContent = latestSignal.signal.replace(/_/g, ' ').toUpperCase();
            document.getElementById('signal-peek-description').textContent = latestSignal.description || '';
            document.getElementById('signal-peek-confidence').textContent = `${Math.round(latestSignal.confidence * 100)}%`;
            document.getElementById('signal-peek-time').textContent = new Date(latestSignal.datetime).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            document.getElementById('signal-peek-price').textContent = `$${latestSignal.price.toFixed(2)}`;
            
            // Update badge
            const badge = document.getElementById('signal-peek-badge');
            badge.textContent = isBullish ? 'BULLISH' : 'BEARISH';
            badge.className = `signal-peek-badge ${isBullish ? 'bullish' : 'bearish'}`;
            
            // Only show if analysis sidebar is not open
            if (isMobile() && !document.getElementById('analysis-sidebar').classList.contains('mobile-open')) {
                peek.classList.add('visible');
            }
        }
        
        // ===== LIVE MODE FUNCTIONS =====
        function updateLiveButton() {
            const desktopBtn = document.getElementById('live-btn');
            const summaryIndicator = document.getElementById('summary-live-indicator');
            
            if (liveMode) {
                const text = `üî¥ LIVE ${liveCountdown}s`;
                desktopBtn.textContent = text;
                summaryIndicator.textContent = `üî¥ ${liveCountdown}s`;
                summaryIndicator.classList.add('active');
            } else {
                desktopBtn.textContent = '‚ö™ LIVE';
                summaryIndicator.textContent = '';
                summaryIndicator.classList.remove('active');
            }
        }
        
        function toggleLiveMode() {
            if (liveMode) {
                stopLiveMode();
            } else {
                // Start live mode
                liveMode = true;
                liveCountdown = 10;
                
                // Add active class to button
                document.getElementById('live-btn').classList.add('active');
                
                // Start countdown
                updateLiveButton();
                liveCountdownInterval = setInterval(() => {
                    liveCountdown--;
                    if (liveCountdown <= 0) {
                        liveCountdown = 10;
                    }
                    updateLiveButton();
                }, 1000);
                
                // Start auto-refresh
                liveInterval = setInterval(() => {
                    analyze();
                }, 10000);
            }
        }
        
        function stopLiveMode() {
            if (liveMode) {
                liveMode = false;
                
                // Clear intervals
                if (liveInterval) {
                    clearInterval(liveInterval);
                    liveInterval = null;
                }
                if (liveCountdownInterval) {
                    clearInterval(liveCountdownInterval);
                    liveCountdownInterval = null;
                }
                
                // Remove active class from button
                document.getElementById('live-btn').classList.remove('active');
                
                // Reset button text
                updateLiveButton();
            }
        }
        
        // ===== WATCHLIST FUNCTIONS =====
        async function loadWatchlistPrices() {
            try {
                const symbols = defaultWatchlist.map(w => w.symbol).join(',');
                const res = await authFetch(`/api/watchlist/prices?symbols=${symbols}`);
                if (!res.ok) throw new Error('Failed to fetch prices');
                
                const data = await res.json();
                data.prices.forEach(price => {
                    const prevPrice = watchlistData[price.symbol]?.price;
                    watchlistData[price.symbol] = {
                        ...price,
                        prevPrice: prevPrice || price.price,
                        direction: prevPrice ? (price.price > prevPrice ? 'up' : price.price < prevPrice ? 'down' : null) : null
                    };
                });
                
                renderWatchlist();
            } catch (e) {
                console.error('Error loading watchlist:', e);
            }
        }
        
        function renderWatchlist() {
            const container = document.getElementById('watchlist-container');
            const searchTerm = document.getElementById('watchlist-search').value.toLowerCase();
            
            const filteredList = defaultWatchlist.filter(item => 
                item.symbol.toLowerCase().includes(searchTerm) ||
                item.name.toLowerCase().includes(searchTerm)
            );
            
            container.innerHTML = filteredList.map(item => {
                const data = watchlistData[item.symbol] || {};
                const isSelected = item.symbol === currentSymbol;
                const changeClass = data.changePct >= 0 ? 'positive' : 'negative';
                const changeSign = data.changePct >= 0 ? '+' : '';
                const priceClass = data.direction === 'up' ? 'price-up' : data.direction === 'down' ? 'price-down' : '';
                const flashClass = data.direction ? 'price-flash' : '';
                
                return `
                    <div class="watchlist-item ${isSelected ? 'selected' : ''}" data-symbol="${item.symbol}">
                        <div class="watchlist-item-info">
                            <div class="watchlist-symbol">${item.symbol}</div>
                            <div class="watchlist-name">${item.name}</div>
                        </div>
                        <div class="watchlist-price-info">
                            <div class="watchlist-price ${priceClass} ${flashClass}">${data.price ? data.price.toFixed(2) : '-'}</div>
                            <div class="watchlist-change ${changeClass}">${data.changePct ? `${changeSign}${data.changePct.toFixed(2)}%` : '-'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            container.querySelectorAll('.watchlist-item').forEach(item => {
                item.addEventListener('click', () => selectSymbol(item.dataset.symbol));
            });
            
            // Clear direction flags after render
            Object.keys(watchlistData).forEach(sym => {
                watchlistData[sym].direction = null;
            });
        }
        
        function selectSymbol(symbol) {
            currentSymbol = symbol;
            renderWatchlist();
            loadExpirations(symbol);
            
            // Stop live mode when symbol changes
            stopLiveMode();
            
            // Update contract info
            const data = watchlistData[symbol] || {};
            document.getElementById('contract-symbol').textContent = symbol;
            document.getElementById('contract-details').textContent = 'Select expiration & strike';
            
            // Auto-close watchlist on mobile when symbol is selected
            if (isMobile()) {
                closeWatchlist();
            }
        }
        
        // ===== EXPIRATIONS & STRIKES =====
        async function loadExpirations(symbol) {
            const select = document.getElementById('expiration');
            select.innerHTML = '<option value="">Loading...</option>';
            
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const res = await authFetch(`/api/expirations/${symbol}`);
                    if (res.status === 429) {
                        select.innerHTML = '<option value="">Rate limited, retrying...</option>';
                        await new Promise(r => setTimeout(r, (attempt + 1) * 5000));
                        continue;
                    }
                    if (!res.ok) throw new Error('Failed to load');
                    
                    const data = await res.json();
                    const today = new Date();
                    
                    select.innerHTML = data.expirations.map(exp => {
                        const expDate = new Date(exp + 'T00:00:00');
                        const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                        const label = diffDays === 0 ? '0DTE' : diffDays === 1 ? '1DTE' : `${diffDays}d`;
                        const dateStr = expDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        return `<option value="${exp}">${dateStr} (${label})</option>`;
                    }).join('');
                    
                    if (data.expirations.length > 0) {
                        loadStrikes(symbol, data.expirations[0]);
                    }
                    return;  // success
                } catch (e) {
                    if (attempt === maxRetries - 1) {
                        select.innerHTML = '<option value="">Error loading</option>';
                        // Show retry button next to expiration dropdown
                        showRetryButton(symbol);
                    }
                }
            }
        }

        function showRetryButton(symbol) {
            // Remove existing retry button if any
            const existing = document.getElementById('retry-exp-btn');
            if (existing) existing.remove();

            const btn = document.createElement('button');
            btn.id = 'retry-exp-btn';
            btn.textContent = '‚Üª Retry';
            btn.style.cssText = 'margin-left:6px;padding:4px 10px;background:#2962ff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;';
            btn.addEventListener('click', () => {
                btn.remove();
                loadExpirations(symbol);
            });
            document.getElementById('expiration').parentNode.appendChild(btn);
        }
        
        async function loadStrikes(symbol, expiration) {
            const select = document.getElementById('strike');
            select.innerHTML = '<option value="">Loading...</option>';
            
            try {
                // Use watchlistData price if available (no extra API call)
                let underlyingPrice = watchlistData[symbol]?.price || 0;
                
                // If no cached price, try API as fallback
                if (!underlyingPrice) {
                    try {
                        const priceRes = await authFetch(`/api/underlying/${symbol}`);
                        const priceData = await priceRes.json();
                        underlyingPrice = priceData.price || 0;
                    } catch (e) {
                        console.warn('Could not fetch underlying price');
                    }
                }
                
                const res = await authFetch(`/api/strikes/${symbol}/${expiration}`);
                if (!res.ok) throw new Error('Failed to load');
                
                const data = await res.json();
                
                // Find ATM strike
                let atmStrike = data.strikes.reduce((prev, curr) => 
                    Math.abs(curr - underlyingPrice) < Math.abs(prev - underlyingPrice) ? curr : prev
                );
                
                select.innerHTML = data.strikes.map(strike => {
                    const isATM = strike === atmStrike;
                    return `<option value="${strike}" ${isATM ? 'selected' : ''}>${strike}${isATM ? ' (ATM)' : ''}</option>`;
                }).join('');
                
            } catch (e) {
                select.innerHTML = '<option value="">Error</option>';
            }
        }
        
        // ===== CHART FUNCTIONS =====
        function initCharts() {
            const priceContainer = document.getElementById('price-chart');
            const volumeContainer = document.getElementById('volume-chart');
            
            priceChart = LightweightCharts.createChart(priceContainer, {
                layout: {
                    background: { color: '#131722' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: { color: '#758696', width: 1, style: 2 },
                    horzLine: { color: '#758696', width: 1, style: 2 },
                },
                rightPriceScale: { borderColor: '#2a2e39' },
                timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
            });
            
            candlestickSeries = priceChart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderUpColor: '#26a69a',
                borderDownColor: '#ef5350',
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });
            
            volumeChart = LightweightCharts.createChart(volumeContainer, {
                layout: {
                    background: { color: '#131722' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                rightPriceScale: { borderColor: '#2a2e39' },
                timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
            });
            
            volumeSeries = volumeChart.addHistogramSeries({
                priceFormat: { type: 'volume' },
                priceScaleId: '',
            });
            
            // Sync timescales using logical range (bar-index based) for pixel-perfect alignment
            window._chartDataLoading = false;
            let _syncingChart = false;
            priceChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
                if (window._chartDataLoading || _syncingChart) return;
                if (range) {
                    _syncingChart = true;
                    try { volumeChart.timeScale().setVisibleLogicalRange(range); } catch(_) {}
                    _syncingChart = false;
                }
            });
            volumeChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
                if (window._chartDataLoading || _syncingChart) return;
                if (range) {
                    _syncingChart = true;
                    try { priceChart.timeScale().setVisibleLogicalRange(range); } catch(_) {}
                    _syncingChart = false;
                }
            });
            
            // Resize handler
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const { width, height } = entry.contentRect;
                    if (width === 0 || height === 0) continue;
                    if (entry.target === priceContainer) {
                        priceChart.applyOptions({ width, height });
                    } else if (entry.target === volumeContainer) {
                        volumeChart.applyOptions({ width, height });
                    }
                }
            });
            resizeObserver.observe(priceContainer);
            resizeObserver.observe(volumeContainer);
        }
        
        // ===== ANALYSIS =====
        async function analyze() {
            const expiration = document.getElementById('expiration').value;
            const strike = document.getElementById('strike').value;
            const right = document.getElementById('right').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!currentSymbol || !expiration || !strike) {
                alert('Please select expiration and strike');
                return;
            }
            
            const btn = document.getElementById('analyze-btn');
            
            // In live mode, don't disable button, just show visual feedback
            if (liveMode) {
                const chartsContainer = document.querySelector('.charts-container');
                chartsContainer.classList.add('live-refreshing');
            } else {
                btn.disabled = true;
                btn.textContent = 'Loading...';
            }
            
            try {
                let url = `/api/analyze?symbol=${currentSymbol}&expiration=${expiration}&strike=${strike}&right=${right}&interval=${currentInterval}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
                if (liveMode) url += `&nocache=true`;  // Bypass cache in live mode
                
                const res = await authFetch(url);
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Analysis failed');
                }
                
                const data = await res.json();
                
                // Update contract header
                document.getElementById('contract-symbol').textContent = `${currentSymbol} $${strike} ${right === 'C' ? 'Call' : 'Put'}`;
                document.getElementById('contract-details').textContent = `Exp: ${expiration}`;
                
                if (data.bars.length > 0) {
                    const lastBar = data.bars[data.bars.length - 1];
                    const firstBar = data.bars[0];
                    const change = lastBar.close - firstBar.open;
                    const changePct = (change / firstBar.open * 100);
                    
                    document.getElementById('contract-price').textContent = `$${lastBar.close.toFixed(2)}`;
                    document.getElementById('contract-change').textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%)`;
                    document.getElementById('contract-change').className = `contract-change ${change >= 0 ? 'positive' : 'negative'}`;
                }
                
                // Use incremental updates in live mode, full redraw otherwise
                if (liveMode && currentBarTimestamps.size > 0) {
                    updateChartsIncremental(data);
                } else {
                    updateCharts(data);
                }
                updateAnalysis(data);
                
                // Update summary text after analyze
                updateSummaryText();
                if (isMobile() && !hasAnalyzed) {
                    hasAnalyzed = true;
                }
                
            } catch (e) {
                document.getElementById('signals-container').innerHTML = `<div class="error-message">${e.message}</div>`;
            } finally {
                if (liveMode) {
                    const chartsContainer = document.querySelector('.charts-container');
                    chartsContainer.classList.remove('live-refreshing');
                    // Reset countdown to keep in sync with refresh interval
                    liveCountdown = 10;
                    updateLiveButton();
                } else {
                    btn.disabled = false;
                    btn.textContent = '‚ñ∂ Analyze';
                }
            }
        }
        
        function updateCharts(data) {
          try {
            const candleData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                open: bar.open,
                high: bar.high,
                low: bar.low,
                close: bar.close,
            }));
            
            const volumeData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                value: bar.volume,
                color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)',
            }));
            
            // Suppress timescale sync during bulk data load
            window._chartDataLoading = true;
            volumeSeries.setData(volumeData);
            candlestickSeries.setData(candleData);
            window._chartDataLoading = false;
            
            // Store for re-filtering and update markers
            lastAnalysisData = data;
            updateFilteredMarkers(data.signals || []);
            
            // Scroll to recent ‚Äì use fitContent first, then try setVisibleRange
            if (candleData.length > 0) {
                priceChart.timeScale().fitContent();
                volumeChart.timeScale().fitContent();
                try {
                    const barsToShow = Math.min(100, candleData.length);
                    const fromIndex = Math.max(0, candleData.length - barsToShow);
                    priceChart.timeScale().setVisibleRange({
                        from: candleData[fromIndex].time,
                        to: candleData[candleData.length - 1].time
                    });
                } catch (_) { /* chart not ready yet ‚Äì fitContent already handled it */ }
            }
          } catch(chartErr) { console.warn('Chart update warning:', chartErr.message); }
        }
        
        function updateChartsIncremental(data) {
          try {
            const candleData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                open: bar.open,
                high: bar.high,
                low: bar.low,
                close: bar.close,
            }));
            
            const volumeData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                value: bar.volume,
                color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)',
            }));
            
            // Build new set of timestamps
            const newTimestamps = new Set(candleData.map(d => d.time));
            
            // Suppress timescale sync during updates
            window._chartDataLoading = true;
            
            // Update bars (lightweight-charts update() handles both existing and new bars)
            for (let i = 0; i < candleData.length; i++) {
                candlestickSeries.update(candleData[i]);
                volumeSeries.update(volumeData[i]);
            }
            
            window._chartDataLoading = false;
            
            // Update tracked timestamps
            currentBarTimestamps = newTimestamps;
            
            // Store for re-filtering and update markers
            lastAnalysisData = data;
            updateFilteredMarkers(data.signals || []);
            
          } catch(chartErr) { console.warn('Chart incremental update warning:', chartErr.message); }
        }
        
        function updateAnalysis(data) {
            // Bias - with null check
            const biasContainer = document.getElementById('bias-container');
            if (data.bias && data.bias.bias) {
                biasContainer.className = `bias-indicator ${data.bias.bias}`;
                biasContainer.innerHTML = `
                    <div class="bias-label">${data.bias.bias}</div>
                    <div class="bias-strength">Strength: ${Math.round((data.bias.strength || 0) * 100)}%</div>
                    <div class="bias-reason">${data.bias.reason || ''}</div>
                `;
            } else {
                biasContainer.className = 'bias-indicator neutral';
                biasContainer.innerHTML = `
                    <div class="bias-label">neutral</div>
                    <div class="bias-strength">Not enough data</div>
                `;
            }
            
            // Stats
            const signals = data.signals || [];
            const bullishSignals = signals.filter(s => BULLISH_SIGNALS.includes(s.signal));
            const bearishSignals = signals.filter(s => BEARISH_SIGNALS.includes(s.signal));
            
            document.getElementById('stat-bars').textContent = (data.bars || []).length;
            document.getElementById('stat-signals').textContent = signals.length;
            document.getElementById('stat-bullish').textContent = bullishSignals.length;
            document.getElementById('stat-bearish').textContent = bearishSignals.length;
            
            // Signals list
            const signalsContainer = document.getElementById('signals-container');
            if (signals.length === 0) {
                signalsContainer.innerHTML = '<div class="loading">No significant signals</div>';
                return;
            }
            
            const filteredSignals = filterSignals(signals);
            if (filteredSignals.length === 0) {
                signalsContainer.innerHTML = '<div class="loading">No signals match active filters</div>';
                // still update stats with unfiltered counts
            } else {
            signalsContainer.innerHTML = [...filteredSignals]
                .reverse()
                .slice(0, 30)
                .map(signal => {
                    const isBullish = BULLISH_SIGNALS.includes(signal.signal);
                    return `
                        <div class="signal-item ${isBullish ? 'bullish' : 'bearish'}">
                            <div class="signal-time">${toEasternString(signal.datetime)} ET</div>
                            <div class="signal-name">${signal.signal.replace(/_/g, ' ').toUpperCase()}</div>
                            <div class="signal-desc">${signal.description}</div>
                            <div class="signal-meta">
                                <span>$${signal.price.toFixed(2)}</span>
                                <span>Vol: ${signal.volume.toLocaleString()}</span>
                                <span>${signal.volume_ratio}x avg</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Update signal peek
            updateSignalPeek(signals);
        }
        
        // ===== EVENT LISTENERS =====
        document.getElementById('expiration').addEventListener('change', (e) => {
            if (currentSymbol && e.target.value) {
                loadStrikes(currentSymbol, e.target.value);
            }
            // Stop live mode when expiration changes
            stopLiveMode();
        });
        
        document.getElementById('strike').addEventListener('change', () => {
            // Stop live mode when strike changes
            stopLiveMode();
        });
        
        document.getElementById('analyze-btn').addEventListener('click', analyze);
        document.getElementById('summary-analyze-btn').addEventListener('click', analyze);
        
        // Live mode button
        document.getElementById('live-btn').addEventListener('click', toggleLiveMode);
        
        // Controls chevron
        document.getElementById('controls-chevron').addEventListener('click', toggleControls);
        
        // Interval buttons - Handle both main and summary interval buttons
        document.querySelectorAll('.interval-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update all interval buttons (both main and summary)
                document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
                currentInterval = parseInt(btn.dataset.interval);
                // Set active on all buttons with same interval
                document.querySelectorAll(`.interval-btn[data-interval="${currentInterval}"]`).forEach(b => b.classList.add('active'));
            });
        });
        
        // Signal peek click handler
        document.getElementById('signal-peek').addEventListener('click', () => {
            if (isMobile()) {
                openAnalysis();
            }
        });
        
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });
        
        document.getElementById('watchlist-search').addEventListener('input', renderWatchlist);

        // ===== MOBILE EVENT LISTENERS =====
        // Mobile toggle buttons
        document.getElementById('mobile-menu-toggle').addEventListener('click', toggleWatchlist);
        document.getElementById('mobile-analysis-toggle').addEventListener('click', toggleAnalysis);

        // Mobile close buttons
        document.getElementById('watchlist-close-btn').addEventListener('click', closeWatchlist);
        document.getElementById('analysis-close-btn').addEventListener('click', closeAnalysis);

        // Backdrop click to close
        document.getElementById('backdrop').addEventListener('click', closeAllMobilePanels);

        // Window resize handler
        window.addEventListener('resize', handleResize);
        
        // ===== INITIALIZATION =====
        async function init() {
            // Set default dates
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('start-date').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            
            // Init charts
            initCharts();
            
            // Initialize mobile controls visibility and state
            if (isMobile()) {
                const controlsSummary = document.getElementById('controls-summary');
                // Show controls-summary immediately on mobile
                if (controlsSummary) {
                    controlsSummary.classList.add('active');
                    // Start with controls collapsed on mobile to maximize chart space
                    collapseControls();
                }
            }
            
            // Load watchlist prices FIRST (needed for ATM calculation)
            await loadWatchlistPrices();
            
            // Select default symbol (will now have price data for ATM)
            selectSymbol('SPY');
            
            // Start price updates (every 15 seconds for real-time feel)
            priceUpdateInterval = setInterval(loadWatchlistPrices, 15000);
        }
        
        init();
    </script>
</body>
</html>
