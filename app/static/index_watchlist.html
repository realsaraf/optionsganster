<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionsGanster - AI Options Signals</title>
    <meta name="description" content="AI-driven options signals. One actionable BUY, SELL, or HOLD verdict with a confidence score. Free to use.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://optionsganster.com">
    <meta property="og:title" content="OptionsGanster – AI-Powered Options Signals">
    <meta property="og:description" content="Stop guessing. Our AI analyzes multiple market dimensions in real time and delivers one clear verdict with a confidence score. Free.">
    <meta property="og:image" content="https://optionsganster.com/static/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="OptionsGanster – AI-Powered Options Signals">
    <meta name="twitter:description" content="Stop guessing. Our AI analyzes multiple market dimensions in real time and delivers one clear verdict with a confidence score.">
    <meta name="twitter:image" content="https://optionsganster.com/static/og-image.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32.png">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon-180.png">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100vh;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            display: flex;
            flex-direction: column;
        }
        
        /* ===== WATCHLIST SIDEBAR (LEFT) ===== */
        .watchlist-sidebar {
            width: 220px;
            background: #1e222d;
            border-right: 1px solid #2a2e39;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .watchlist-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .watchlist-header h2 {
            font-size: 13px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .watchlist-add-btn {
            background: transparent;
            border: none;
            color: #2962ff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .watchlist-add-btn:hover {
            background: rgba(41, 98, 255, 0.1);
        }
        
        .watchlist-search {
            padding: 8px 12px;
            border-bottom: 1px solid #2a2e39;
        }
        
        .watchlist-search input {
            width: 100%;
            background: #131722;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 8px 12px;
            color: #d1d4dc;
            font-size: 13px;
        }
        
        .watchlist-search input:focus {
            outline: none;
            border-color: #2962ff;
        }
        
        .watchlist-search input::placeholder {
            color: #787b86;
        }
        
        .watchlist-items {
            flex: 1;
            overflow-y: auto;
        }
        
        .watchlist-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #2a2e39;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .watchlist-item:hover {
            background: #2a2e39;
        }
        
        .watchlist-item.selected {
            background: #2962ff20;
            border-left: 3px solid #2962ff;
        }
        
        .watchlist-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .watchlist-symbol {
            font-size: 14px;
            font-weight: 600;
            color: #d1d4dc;
        }
        
        .watchlist-name {
            font-size: 11px;
            color: #787b86;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .watchlist-price-info {
            text-align: right;
        }
        
        .watchlist-price {
            font-size: 14px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .watchlist-change {
            font-size: 11px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .watchlist-change.positive {
            color: #26a69a;
        }
        
        .watchlist-change.negative {
            color: #ef5350;
        }
        
        .price-flash {
            animation: flash 0.3s ease-out;
        }
        
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .price-up {
            color: #26a69a !important;
        }
        
        .price-down {
            color: #ef5350 !important;
        }
        
        /* ===== MAIN LAYOUT ===== */
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: 100vh;
        }
        
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;
            overflow: hidden;
        }
        
        /* ===== HEADER ===== */
        .header {
            background: #1e222d;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-logo h1 {
            font-size: 18px;
            font-weight: 700;
            color: #2962ff;
        }
        
        .header-logo h1 span {
            color: #ef5350;
        }
        
        .header-contract {
            display: flex;
            align-items: baseline;
            gap: 10px;
            padding: 6px 12px;
            background: #131722;
            border-radius: 6px;
        }
        
        .contract-symbol {
            font-size: 16px;
            font-weight: 700;
            color: #d1d4dc;
        }
        
        .contract-details {
            font-size: 12px;
            color: #787b86;
        }
        
        .contract-price {
            font-size: 16px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .contract-change {
            font-size: 12px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .contract-change.positive { color: #26a69a; }
        .contract-change.negative { color: #ef5350; }
        
        .logout-btn {
            margin-left: auto;
            color: #787b86;
            text-decoration: none;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 4px;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .logout-btn:hover {
            color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
        }
        
        /* ===== CONTROLS BAR ===== */
        /* Hide old dropdowns replaced by toggle buttons */
        #type-group, #from-group, #to-group {
            display: none;
        }

        .controls-bar {
            background: #1e222d;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .control-group label {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
        }
        
        .control-group select,
        .control-group input {
            background: #131722;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 6px 10px;
            color: #d1d4dc;
            font-size: 13px;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #2962ff;
        }
        
        .interval-buttons {
            display: flex;
            gap: 2px;
            background: #131722;
            padding: 2px;
            border-radius: 4px;
        }
        
        .interval-btn {
            background: transparent;
            border: none;
            color: #787b86;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.15s;
        }
        
        .interval-btn:hover {
            color: #d1d4dc;
        }
        
        .interval-btn.active {
            background: #2962ff;
            color: white;
        }
        
        .analyze-btn {
            background: #2962ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .analyze-btn:hover {
            background: #1e53e4;
        }
        
        .analyze-btn:disabled {
            background: #363a45;
            cursor: not-allowed;
        }
        
        /* ===== LIVE BUTTON ===== */
        .live-btn {
            background: #363a45;
            color: #787b86;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        
        .live-btn:hover {
            background: #4a4e59;
            color: #d1d4dc;
        }
        
        .live-btn.active {
            background: #ef5350;
            color: white;
            animation: live-pulse 2s ease-in-out infinite;
        }
        
        @keyframes live-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(239, 83, 80, 0);
            }
        }
        
        /* ===== CONTROLS SUMMARY (Mobile only) ===== */
        .controls-summary {
            display: none;
            background: #131722;
            padding: 6px 12px;
            border-bottom: 1px solid #2a2e39;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
            height: 40px;
            overflow: hidden;
        }
        
        .summary-text {
            font-size: 12px;
            color: #d1d4dc;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }
        
        .summary-intervals {
            display: none;
        }
        
        .summary-interval-btn {
            padding: 4px 8px;
            font-size: 10px;
        }
        
        .summary-analyze-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 700;
            min-width: 0;
            background: #2962ff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .summary-analyze-btn:active {
            background: #1e4fd6;
        }
        
        .summary-live-btn {
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            background: #2a2e39;
            color: #787b86;
            border: 1px solid #363a45;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .summary-live-btn.active {
            background: rgba(239, 83, 80, 0.15);
            color: #ef5350;
            border-color: #ef5350;
        }
        
        .controls-chevron {
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        
        .controls-chevron:hover {
            background: rgba(120, 123, 134, 0.1);
            color: #d1d4dc;
        }
        
        .controls-bar.collapsed {
            display: none;
        }
        
        /* ===== SIGNAL PEEK (Mobile only) ===== */
        .signal-peek {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to right, rgba(38, 166, 154, 0.15), #1e222d);
            border-top: 3px solid #26a69a;
            padding: 12px 16px;
            z-index: 998;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            cursor: pointer;
            min-height: 68px;
        }
        
        .signal-peek.visible {
            transform: translateY(0);
        }
        
        .signal-peek.bearish {
            border-top-color: #ef5350;
            background: linear-gradient(to right, rgba(239, 83, 80, 0.15), #1e222d);
        }
        
        .signal-peek-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .signal-peek-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .signal-peek-name {
            font-size: 14px;
            font-weight: 700;
            color: #d1d4dc;
            flex: 1;
        }
        
        .signal-peek-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .signal-peek-badge.bullish {
            background: rgba(38, 166, 154, 0.2);
            color: #26a69a;
        }
        
        .signal-peek-badge.bearish {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }
        
        .signal-peek-details {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        
        .signal-peek-description {
            font-size: 11px;
            color: #9ca3af;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .signal-peek-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .signal-peek-confidence {
            color: #2962ff;
            font-weight: 600;
        }
        
        .signal-peek-time {
            font-size: 10px;
            color: #787b86;
        }
        
        .signal-peek-price {
            font-size: 13px;
            font-weight: 600;
            color: #2962ff;
        }
        
        .live-refreshing {
            position: relative;
        }
        
        .live-refreshing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #2962ff, transparent);
            animation: live-refresh-slide 1.5s ease-in-out infinite;
        }
        
        @keyframes live-refresh-slide {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* ===== CHART AREA ===== */
        .chart-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        
        .charts-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #131722;
            min-height: 0;
            min-width: 0;
        }
        
        #price-chart {
            flex: 3;
            min-height: 0;
        }
        
        #volume-chart {
            flex: 1;
            border-top: 1px solid #2a2e39;
            min-height: 0;
        }
        
        .chart-legend {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(30, 34, 45, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
        }
        
        .chart-legend .ohlc {
            display: flex;
            gap: 16px;
        }
        
        .chart-legend .ohlc span {
            color: #787b86;
        }
        
        .chart-legend .ohlc span strong {
            color: #d1d4dc;
            font-weight: 600;
        }
        
        /* ===== ANALYSIS SIDEBAR (RIGHT) ===== */
        .analysis-sidebar {
            width: 320px;
            background: #1e222d;
            border-left: 1px solid #2a2e39;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            min-height: 0;
            overflow: hidden;
        }
        
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #2a2e39;
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }
        
        .sidebar-tab:hover {
            color: #d1d4dc;
        }
        
        .sidebar-tab.active {
            color: #2962ff;
            border-bottom-color: #2962ff;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        /* Bias Indicator */
        .bias-card {
            background: #131722;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .bias-card h4 {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .bias-indicator {
            text-align: center;
            padding: 16px;
            border-radius: 6px;
        }
        
        .bias-indicator.bullish {
            background: rgba(38, 166, 154, 0.1);
            border: 1px solid #26a69a;
        }
        
        .bias-indicator.bearish {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid #ef5350;
        }
        
        .bias-indicator.neutral {
            background: rgba(120, 123, 134, 0.1);
            border: 1px solid #787b86;
        }
        
        .bias-label {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .bias-indicator.bullish .bias-label { color: #26a69a; }
        .bias-indicator.bearish .bias-label { color: #ef5350; }
        .bias-indicator.neutral .bias-label { color: #787b86; }
        
        .bias-strength {
            font-size: 13px;
            color: #787b86;
            margin-top: 8px;
        }
        
        .bias-reason {
            font-size: 12px;
            color: #5d606b;
            margin-top: 4px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            background: #131722;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #d1d4dc;
        }
        
        .stat-label {
            font-size: 11px;
            color: #787b86;
            margin-top: 4px;
        }
        
        /* Signals List */
        .signals-header {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .signal-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .signal-item {
            background: #131722;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid;
        }
        
        .signal-item.bullish { border-color: #26a69a; }
        .signal-item.bearish { border-color: #ef5350; }
        
        .signal-time {
            font-size: 11px;
            color: #5d606b;
        }
        
        .signal-name {
            font-size: 13px;
            font-weight: 600;
            color: #d1d4dc;
            margin: 4px 0;
        }
        
        .signal-desc {
            font-size: 12px;
            color: #787b86;
        }
        
        .signal-meta {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 11px;
            color: #5d606b;
        }
        
        /* Loading & Error States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #787b86;
        }
        
        .error-message {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid #ef5350;
            color: #ef5350;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
        }

        /* ===== COMPOSITE SIGNAL PANEL ===== */
        .composite-card {
            background: #131722;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .composite-card h4 {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .composite-signal-gauge {
            text-align: center;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .composite-signal-gauge.strong_buy,
        .composite-signal-gauge.buy { background: rgba(38,166,154,0.12); border: 1px solid #26a69a; }
        .composite-signal-gauge.lean_bullish { background: rgba(38,166,154,0.06); border: 1px solid rgba(38,166,154,0.4); }
        .composite-signal-gauge.neutral { background: rgba(120,123,134,0.08); border: 1px solid #787b86; }
        .composite-signal-gauge.lean_bearish { background: rgba(239,83,80,0.06); border: 1px solid rgba(239,83,80,0.4); }
        .composite-signal-gauge.sell,
        .composite-signal-gauge.strong_sell { background: rgba(239,83,80,0.12); border: 1px solid #ef5350; }

        .composite-action-label {
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .composite-signal-gauge.strong_buy .composite-action-label,
        .composite-signal-gauge.buy .composite-action-label,
        .composite-signal-gauge.lean_bullish .composite-action-label { color: #26a69a; }
        .composite-signal-gauge.neutral .composite-action-label { color: #787b86; }
        .composite-signal-gauge.lean_bearish .composite-action-label,
        .composite-signal-gauge.sell .composite-action-label,
        .composite-signal-gauge.strong_sell .composite-action-label { color: #ef5350; }

        .composite-signal-sub {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .composite-meta {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 6px;
            font-size: 12px;
            color: #787b86;
        }

        .composite-meta span strong {
            color: #d1d4dc;
        }

        .archetype-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(41,98,255,0.15);
            color: #5b8af5;
            margin-top: 8px;
        }

        .archetype-desc {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 6px;
            line-height: 1.5;
        }

        .recommendation-box {
            background: #0d1117;
            border: 1px solid #2a2e39;
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            color: #b0b3bc;
            line-height: 1.6;
            margin-top: 8px;
        }

        /* Greeks grid */
        .greeks-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 4px;
        }

        .greek-item {
            background: #0d1117;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .greek-value {
            font-size: 18px;
            font-weight: 700;
            font-family: 'SF Mono','Monaco',monospace;
        }

        .greek-value.positive { color: #26a69a; }
        .greek-value.negative { color: #ef5350; }
        .greek-value.neutral-val { color: #d1d4dc; }

        .greek-label {
            font-size: 10px;
            color: #787b86;
            text-transform: uppercase;
            margin-top: 2px;
            letter-spacing: 0.5px;
        }

        /* Factor bars */
        .factor-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .factor-item {
            background: #0d1117;
            padding: 10px 12px;
            border-radius: 6px;
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .factor-name {
            font-size: 12px;
            font-weight: 600;
            color: #d1d4dc;
        }

        .factor-score-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SF Mono','Monaco',monospace;
        }

        .factor-score-badge.positive { background: rgba(38,166,154,0.15); color: #26a69a; }
        .factor-score-badge.negative { background: rgba(239,83,80,0.15); color: #ef5350; }
        .factor-score-badge.zero { background: rgba(120,123,134,0.15); color: #787b86; }

        .factor-bar-bg {
            height: 4px;
            background: #1e222d;
            border-radius: 2px;
            position: relative;
            margin: 6px 0 4px;
        }

        .factor-bar-fill {
            position: absolute;
            top: 0;
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .factor-bar-fill.positive { background: #26a69a; }
        .factor-bar-fill.negative { background: #ef5350; }

        .factor-detail {
            font-size: 11px;
            color: #787b86;
            line-height: 1.4;
        }

        /* Chain metrics mini-grid */
        .chain-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .chain-item {
            background: #0d1117;
            padding: 8px 6px;
            border-radius: 6px;
            text-align: center;
        }

        .chain-value {
            font-size: 14px;
            font-weight: 700;
            color: #d1d4dc;
            font-family: 'SF Mono','Monaco',monospace;
        }

        .chain-label {
            font-size: 9px;
            color: #787b86;
            text-transform: uppercase;
            margin-top: 2px;
            letter-spacing: 0.3px;
        }

        .uoa-alert {
            background: rgba(255, 193, 7, 0.08);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            padding: 10px 12px;
            margin-top: 8px;
        }

        .uoa-alert-header {
            font-size: 12px;
            font-weight: 700;
            color: #ffc107;
            margin-bottom: 6px;
        }

        .uoa-strike {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #b0b3bc;
            padding: 2px 0;
        }

        .uoa-strike .uoa-ratio {
            font-weight: 600;
            color: #ffc107;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ===== SIGNAL FILTER TOGGLES ===== */
        .filter-bar {
            background: #1e222d;
            padding: 6px 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #2a2e39;
        }

        .filter-bar .filter-label {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-right: 2px;
        }

        /* ── Stock Underlay Toggle (compact, inline in filter bar) ── */
        .underlay-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-right: 10px;
            border-right: 1px solid #2a2e39;
            margin-right: 2px;
        }
        .underlay-toggle .underlay-label {
            font-size: 10px;
            color: #787b86;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .underlay-btn-group {
            display: flex;
            gap: 1px;
            background: #131722;
            padding: 2px;
            border-radius: 4px;
        }
        .underlay-btn {
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 10px;
            padding: 3px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 600;
            line-height: 1;
        }
        .underlay-btn:hover {
            color: #d1d4dc;
        }
        .underlay-btn.active {
            background: #2962ff;
            color: #fff;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-group .toggle-text {
            font-size: 11px;
            color: #5d606b;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: color 0.2s;
        }

        .toggle-group .toggle-text.active {
            color: #d1d4dc;
        }

        .toggle-switch {
            position: relative;
            width: 30px;
            height: 16px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #363a45;
            border-radius: 16px;
            transition: background 0.2s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 10px;
            width: 10px;
            left: 3px;
            bottom: 3px;
            background: #787b86;
            border-radius: 50%;
            transition: transform 0.2s, background 0.2s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #2962ff;
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(14px);
            background: #fff;
        }

        .toggle-group.bullish-color .toggle-switch input:checked + .toggle-slider {
            background: #26a69a;
        }

        .toggle-group.bearish-color .toggle-switch input:checked + .toggle-slider {
            background: #ef5350;
        }

        .toggle-group.neutral-color .toggle-switch input:checked + .toggle-slider {
            background: #5d606b;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #131722;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #363a45;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4e59;
        }

        /* ===== MOBILE TOGGLE BUTTONS ===== */
        .mobile-menu-toggle,
        .mobile-analysis-toggle {
            display: none;
            position: fixed;
            z-index: 1001;
            background: #2962ff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .mobile-menu-toggle {
            top: 12px;
            left: 12px;
        }

        .mobile-analysis-toggle {
            bottom: 20px;
            right: 20px;
        }

        .mobile-menu-toggle:active,
        .mobile-analysis-toggle:active {
            transform: scale(0.95);
        }

        .mobile-close-btn {
            display: none;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .mobile-close-btn:hover {
            background: rgba(120, 123, 134, 0.1);
            color: #d1d4dc;
        }

        .backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }

        .backdrop.active {
            display: block;
        }

        /* ===== MOBILE BOTTOM NAV ===== */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #1e222d;
            border-top: 1px solid #2a2e39;
            z-index: 1100;
            justify-content: space-around;
            align-items: center;
            padding: 0 4px;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 12px;
            background: none;
            border: none;
            color: #787b86;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s;
            min-width: 56px;
            position: relative;
        }

        .mobile-nav-item .nav-icon {
            font-size: 20px;
            line-height: 1;
        }

        .mobile-nav-item.active {
            color: #2962ff;
        }

        .mobile-nav-item .nav-badge {
            position: absolute;
            top: 2px;
            right: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: none;
        }

        .mobile-nav-item .nav-badge.visible {
            display: block;
        }

        /* ===== DATE RANGE BUTTONS ===== */
        .mobile-date-range {
            display: none; /* shown on mobile via controls-bar grid */
        }

        /* Desktop date range (always visible) */
        .desktop-date-range {
            display: flex;
            gap: 2px;
            background: #131722;
            padding: 2px;
            border-radius: 4px;
        }
        .desktop-date-range .date-range-btn {
            flex: none;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 500;
            background: transparent;
            color: #787b86;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .desktop-date-range .date-range-btn:hover {
            color: #d1d4dc;
        }
        .desktop-date-range .date-range-btn.active {
            background: #2962ff;
            color: white;
        }

        .date-range-group {
            display: flex;
            gap: 4px;
            width: 100%;
        }

        .date-range-btn {
            flex: 1;
            padding: 8px 4px;
            font-size: 12px;
            font-weight: 700;
            background: #2a2e39;
            color: #787b86;
            border: 1px solid #363a45;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
        }

        .date-range-btn.active {
            background: #2962ff;
            color: #fff;
            border-color: #2962ff;
        }

        .date-range-btn:not(.active):active {
            background: #363a45;
        }

        /* ===== CALL/PUT SWITCH ===== */
        .mobile-cp-switch {
            display: none; /* shown on mobile via controls-bar grid */
        }

        /* Desktop Call/Put Toggle (always visible) */
        .desktop-cp-toggle {
            display: flex;
            background: #131722;
            border-radius: 4px;
            overflow: hidden;
            padding: 2px;
            gap: 2px;
        }
        .desktop-cp-toggle .cp-opt {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            background: transparent;
            color: #787b86;
            transition: all 0.15s;
        }
        .desktop-cp-toggle .cp-opt:hover {
            color: #d1d4dc;
        }
        .desktop-cp-toggle .cp-opt.call-active {
            background: #26a69a;
            color: #fff;
        }
        .desktop-cp-toggle .cp-opt.put-active {
            background: #ef5350;
            color: #fff;
        }

        .cp-toggle {
            display: flex;
            background: #1e222d;
            border-radius: 8px;
            border: 1px solid #363a45;
            overflow: hidden;
            height: 40px;
        }

        .cp-toggle-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #787b86;
            padding: 0 12px;
        }

        .cp-toggle-option.active {
            color: #fff;
        }

        .cp-toggle-option.call-active {
            background: #26a69a;
            color: #fff;
        }

        .cp-toggle-option.put-active {
            background: #ef5350;
            color: #fff;
        }

        /* ===== MOBILE ACTION BANNER ===== */
        .mobile-action-banner {
            display: none;
            position: fixed;
            bottom: 56px;
            left: 0;
            right: 0;
            padding: 10px 16px;
            z-index: 1099;
            cursor: pointer;
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(100%);
            opacity: 0;
        }

        .mobile-action-banner.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .mobile-action-banner.buy {
            background: #0d2b26;
            border-top: 3px solid #26a69a;
        }

        .mobile-action-banner.sell {
            background: #2b1215;
            border-top: 3px solid #ef5350;
        }

        .mobile-action-banner.hold {
            background: #1e222d;
            border-top: 3px solid #787b86;
        }

        .mobile-action-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-action-label {
            font-size: 20px;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .mobile-action-banner.buy .mobile-action-label { color: #26a69a; }
        .mobile-action-banner.sell .mobile-action-label { color: #ef5350; }
        .mobile-action-banner.hold .mobile-action-label { color: #787b86; }

        .mobile-action-meta {
            text-align: right;
            font-size: 11px;
            color: #787b86;
        }

        .mobile-action-meta strong {
            color: #d1d4dc;
        }

        /* ===== MOBILE RESPONSIVE (≤768px) ===== */
        @media (max-width: 768px) {
            html, body {
                overflow: hidden;
                height: 100%;
                height: -webkit-fill-available;
            }

            .app-container {
                height: 100%;
                height: -webkit-fill-available;
            }

            .main-panel {
                overflow: hidden;
                padding-bottom: 56px; /* space for bottom nav */
            }

            /* Show bottom nav + action banner */
            .mobile-bottom-nav {
                display: flex;
            }

            .mobile-action-banner {
                display: block;
            }

            /* Hide old floating toggle buttons */
            .mobile-menu-toggle,
            .mobile-analysis-toggle {
                display: none !important;
            }

            /* Hide old signal-peek (replaced by action banner) */
            .signal-peek {
                display: none !important;
            }

            /* ---- Watchlist sidebar overlay ---- */
            .watchlist-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 300px;
                max-width: 85vw;
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 1002;
            }

            .watchlist-sidebar.mobile-open {
                transform: translateX(0);
            }

            .watchlist-sidebar .mobile-close-btn {
                display: block;
            }

            /* ---- Analysis sidebar: bottom sheet ---- */
            .analysis-sidebar {
                position: fixed;
                top: 10vh;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
                transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 1002;
                border-left: none;
                border-top: 1px solid #2a2e39;
            }

            .analysis-sidebar.mobile-open {
                transform: translateY(0);
            }

            .analysis-sidebar .mobile-close-btn {
                display: block;
            }

            /* Bottom sheet drag handle */
            .analysis-sidebar::before {
                content: '';
                display: block;
                width: 36px;
                height: 4px;
                background: #4a4e59;
                border-radius: 2px;
                margin: 8px auto 4px;
            }

            /* ---- Compact header ---- */
            .header {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                padding: 8px 12px;
                min-height: 48px;
            }

            .header-logo {
                display: none;
            }

            .header-contract {
                flex: 1;
                flex-direction: row;
                align-items: baseline;
                gap: 8px;
                padding: 4px 0;
                background: transparent;
                border-radius: 0;
            }

            .contract-symbol {
                font-size: 15px;
                font-weight: 800;
            }

            .contract-details {
                display: none;
            }

            .contract-price {
                font-size: 14px;
            }

            .contract-change {
                font-size: 11px;
            }

            .logout-btn {
                position: static;
                margin-left: auto;
                font-size: 11px;
                padding: 6px 8px;
                z-index: auto;
            }

            /* ---- Controls Summary ---- */
            .controls-summary {
                display: none;
                padding: 6px 12px;
                height: 40px;
            }

            .controls-summary.active {
                display: flex;
            }

            /* ---- Controls Bar: 2-column grid ---- */
            .controls-bar {
                padding: 10px 12px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .controls-bar.collapsed {
                display: none;
            }

            /* Hide desktop From/To/Type/desktop toggles on mobile */
            #from-group, #to-group, #type-group,
            .desktop-cp-toggle, .desktop-date-range {
                display: none !important;
            }

            /* Show mobile replacements */
            .mobile-cp-switch {
                display: block !important;
                grid-column: 1 / -1;
            }

            .mobile-date-range {
                display: block !important;
                grid-column: 1 / -1;
            }

            .control-group {
                width: 100%;
            }

            .control-group select,
            .control-group input {
                flex: 1;
                width: 100%;
                min-width: 0;
                padding: 10px 8px;
                font-size: 13px;
            }

            .control-group label {
                min-width: 36px;
                font-size: 10px;
            }

            .interval-buttons {
                grid-column: 1 / -1;
                width: 100%;
                justify-content: space-between;
            }

            .interval-btn {
                flex: 1;
                padding: 10px 6px;
                min-height: 40px;
                font-size: 13px;
            }

            .analyze-btn {
                grid-column: 1 / -1;
                width: 100%;
                padding: 12px 20px;
                min-height: 44px;
                font-size: 14px;
            }

            .live-btn {
                grid-column: 1 / -1;
                width: 100%;
                padding: 10px 16px;
                min-height: 40px;
                font-size: 13px;
            }

            /* ---- Filter bar: wrap on mobile ---- */
            .filter-bar {
                flex-wrap: wrap;
                overflow-x: visible;
                padding: 6px 12px;
                gap: 8px;
            }

            .filter-bar::-webkit-scrollbar {
                display: none;
            }

            .filter-bar .filter-label {
                display: none;
            }

            .toggle-group {
                flex-shrink: 0;
            }

            /* ---- Stock toggle: hide with collapsed controls on mobile ---- */
            .underlay-toggle {
                border-right: none;
                padding-right: 0;
                margin-right: 0;
                flex-shrink: 0;
            }

            /* ---- Chart: fill available space ---- */
            .chart-area {
                flex: 1;
                flex-direction: column;
                overflow: hidden;
                min-height: 0;
            }

            .charts-container {
                flex: 1;
                min-height: 0;
            }

            #price-chart {
                flex: 3;
                min-height: 0;
            }

            #volume-chart {
                flex: 1;
                min-height: 0;
            }

            /* ---- Watchlist mobile styling ---- */
            .watchlist-search input {
                padding: 12px 14px;
                font-size: 14px;
            }

            .watchlist-item {
                padding: 14px 16px;
            }

            .watchlist-symbol {
                font-size: 15px;
            }

            /* ---- Analysis sidebar content mobile ---- */
            .sidebar-content {
                padding: 12px;
            }

            .composite-card {
                padding: 12px;
                margin-bottom: 10px;
            }

            .composite-action-label {
                font-size: 24px;
            }

            .greeks-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }

            .greek-item {
                padding: 8px 4px;
            }

            .greek-value {
                font-size: 14px;
            }

            .greek-label {
                font-size: 9px;
            }

            .chain-grid {
                gap: 4px;
            }

            .chain-item {
                padding: 6px 4px;
            }

            .chain-value {
                font-size: 12px;
            }

            .chain-label {
                font-size: 8px;
            }

            .recommendation-box {
                font-size: 12px;
                padding: 10px;
            }

            /* Stats grid mobile */
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }

            .stat-item {
                padding: 8px 4px;
            }

            .stat-value {
                font-size: 16px;
            }

            .stat-label {
                font-size: 9px;
            }
        }

        /* ===== LANDSCAPE MOBILE RESPONSIVE (≤1024px width AND ≤500px height) ===== */
        @media (max-width: 1024px) and (max-height: 500px) {
            html, body {
                overflow: auto;
            }

            .main-panel {
                overflow: visible;
            }

            .mobile-menu-toggle,
            .mobile-analysis-toggle {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .mobile-bottom-nav {
                display: none;
            }

            .watchlist-sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                bottom: 0;
                width: 220px;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .watchlist-sidebar.mobile-open {
                left: 0;
            }

            .analysis-sidebar {
                position: fixed;
                right: -280px;
                top: 0;
                bottom: 0;
                width: 260px;
                z-index: 1000;
                transition: right 0.3s ease;
                overflow-y: auto;
            }

            .analysis-sidebar.mobile-open {
                right: 0;
            }

            .mobile-close-btn {
                display: block;
            }

            .main-panel {
                flex: 1;
                width: 100%;
            }

            .header {
                padding-top: 60px;
            }

            .logout-btn {
                position: absolute;
                top: 12px;
                right: 12px;
                margin-left: 0;
                font-size: 11px;
                padding: 8px 12px;
                z-index: 100;
            }

            .controls-summary {
                display: none;
            }

            .controls-summary.active {
                display: flex;
            }

            .signal-peek {
                display: block;
            }

            .mobile-analysis-toggle {
                bottom: 80px;
            }

            .chart-area {
                flex-direction: column;
                overflow: visible;
                min-height: 500px;
            }

            .charts-container {
                min-height: 400px;
            }
        }

        /* ── Toast notifications ── */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,.5);
            animation: toastIn .35s ease-out;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,.12);
            cursor: pointer;
            max-width: 360px;
        }
        .toast.fade-out { animation: toastOut .3s ease-in forwards; }
        .toast.buy   { background: linear-gradient(135deg, #1b5e20cc, #2e7d32cc); }
        .toast.sell  { background: linear-gradient(135deg, #b71c1ccc, #c62828cc); }
        .toast.hold  { background: linear-gradient(135deg, #37474fcc, #455a64cc); }
        .toast-icon  { font-size: 20px; flex-shrink: 0; }
        .toast-body  { display: flex; flex-direction: column; gap: 2px; }
        .toast-title  { font-size: 14px; font-weight: 700; letter-spacing: .3px; }
        .toast-detail { font-size: 12px; opacity: .85; font-weight: 400; }
        @keyframes toastIn  { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }

        /* ── Connection-limit modal ── */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.65);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: #161b22;
            border: 1px solid #f85149;
            border-radius: 12px;
            padding: 28px 32px;
            max-width: 460px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,.5);
        }
        .modal-box .modal-icon { font-size: 40px; margin-bottom: 12px; }
        .modal-box h2 { color: #f85149; font-size: 18px; margin-bottom: 8px; }
        .modal-box p  { color: #8b949e; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .modal-box .modal-btn {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px 28px;
            font-size: 14px;
            cursor: pointer;
            transition: background .2s;
        }
        .modal-box .modal-btn:hover { background: #30363d; }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Connection-limit modal -->
    <div class="modal-overlay" id="conn-limit-modal">
        <div class="modal-box">
            <div class="modal-icon">⚠️</div>
            <h2>Connection Limit Reached</h2>
            <p id="conn-limit-msg">Polygon’s WebSocket connection limit has been exceeded. The server is backing off and will retry automatically. Please wait ~30 seconds before trying live mode again.</p>
            <button class="modal-btn" id="conn-limit-ok">OK</button>
        </div>
    </div>

    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle Watchlist">
        ☰ <span>Watchlist</span>
    </button>

    <!-- Mobile Analysis Toggle Button -->
    <button class="mobile-analysis-toggle" id="mobile-analysis-toggle" aria-label="Toggle Analysis">
        📊 <span>Analysis</span>
    </button>

    <!-- Backdrop for mobile overlays -->
    <div class="backdrop" id="backdrop"></div>

    <div class="app-container">
        <!-- LEFT: Watchlist Sidebar -->
        <div class="watchlist-sidebar" id="watchlist-sidebar">
            <div class="watchlist-header">
                <h2>Watchlist</h2>
                <button class="mobile-close-btn" id="watchlist-close-btn" aria-label="Close Watchlist">×</button>
                <button class="watchlist-add-btn" title="Add Symbol">+</button>
            </div>
            <div class="watchlist-search">
                <input type="text" id="watchlist-search" placeholder="Search symbols...">
            </div>
            <div class="watchlist-items" id="watchlist-container">
                <!-- Watchlist items will be populated here -->
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <!-- MAIN: Chart & Controls -->
        <div class="main-panel">
            <div class="header">
                <div class="header-logo">
                    <h1>Options<span>Ganster</span></h1>
                </div>
                <div class="header-contract" id="contract-info">
                    <div class="contract-symbol" id="contract-symbol">-</div>
                    <div class="contract-price" id="contract-price">-</div>
                    <div class="contract-change" id="contract-change">-</div>
                    <div class="contract-details" id="contract-details">Select a symbol</div>
                </div>
                <a href="/api/logout" class="logout-btn" title="Sign Out">⏻ Logout</a>
            </div>
            
            <!-- Controls Summary Bar (Mobile only, shown after first analyze) -->
            <div class="controls-summary" id="controls-summary">
                <span class="summary-text" id="summary-text">SPY $500C 5m</span>
                <button class="summary-analyze-btn" id="summary-analyze-btn">Analyze</button>
                <button class="summary-live-btn" id="summary-live-btn">LIVE</button>
                <button class="controls-chevron" id="controls-chevron">⚙</button>
            </div>
            
            <div class="controls-bar" id="controls-bar">
                <div class="control-group">
                    <label>Exp</label>
                    <select id="expiration" style="min-width: 140px;">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Strike</label>
                    <select id="strike" style="min-width: 100px;">
                        <option value="">-</option>
                    </select>
                </div>
                
                <div class="control-group" id="type-group">
                    <label>Type</label>
                    <select id="right" style="min-width: 70px;">
                        <option value="C">Call</option>
                        <option value="P">Put</option>
                    </select>
                </div>

                <!-- Desktop Call/Put Toggle (shown on desktop) -->
                <div class="desktop-cp-toggle" id="desktop-cp-toggle">
                    <button class="cp-opt call-active" id="dcp-call" data-value="C">CALL</button>
                    <button class="cp-opt" id="dcp-put" data-value="P">PUT</button>
                </div>

                <!-- Mobile Call/Put Switch (replaces dropdown on mobile) -->
                <div class="mobile-cp-switch" id="mobile-cp-switch">
                    <div class="cp-toggle">
                        <button class="cp-toggle-option call-active" id="cp-call" data-value="C">CALL</button>
                        <button class="cp-toggle-option" id="cp-put" data-value="P">PUT</button>
                    </div>
                </div>
                
                <div class="control-group" id="from-group">
                    <label>From</label>
                    <input type="date" id="start-date" style="width: 130px;">
                </div>
                
                <div class="control-group" id="to-group">
                    <label>To</label>
                    <input type="date" id="end-date" style="width: 130px;">
                </div>

                <!-- Desktop Date Range Buttons -->
                <div class="desktop-date-range" id="desktop-date-range">
                    <button class="date-range-btn active" data-range="1">1D</button>
                    <button class="date-range-btn" data-range="5">5D</button>
                    <button class="date-range-btn" data-range="7">1W</button>
                    <button class="date-range-btn" data-range="14">2W</button>
                    <button class="date-range-btn" data-range="30">1M</button>
                    <button class="date-range-btn" data-range="90">3M</button>
                </div>

                <!-- Mobile Date Range Buttons (replaces From/To on mobile) -->
                <div class="mobile-date-range" id="mobile-date-range">
                    <div class="date-range-group">
                        <button class="date-range-btn active" data-range="1">1D</button>
                        <button class="date-range-btn" data-range="7">1W</button>
                        <button class="date-range-btn" data-range="14">2W</button>
                        <button class="date-range-btn" data-range="30">1M</button>
                        <button class="date-range-btn" data-range="90">3M</button>
                        <button class="date-range-btn" data-range="180">6M</button>
                    </div>
                </div>
                
                <div class="interval-buttons">
                    <button class="interval-btn" data-interval="1">1m</button>
                    <button class="interval-btn active" data-interval="5">5m</button>
                    <button class="interval-btn" data-interval="15">15m</button>
                    <button class="interval-btn" data-interval="60">1H</button>
                </div>
                
                <button class="analyze-btn" id="analyze-btn">▶ Analyze</button>
                <button class="live-btn" id="live-btn">⚪ LIVE</button>
                <button class="live-btn" id="mock-btn" style="background:#2a2e39;color:#787b86;font-size:11px;padding:6px 12px;min-width:auto" title="Mock mode: simulates option WS feed using CSV data. Stock prices, expirations &amp; strikes remain real.">MOCK</button>
            </div>

            <div class="filter-bar" id="filter-bar">
                <div class="underlay-toggle">
                    <span class="underlay-label" id="underlay-label">Stock:</span>
                    <div class="underlay-btn-group">
                        <button class="underlay-btn" data-underlay="off" id="underlay-off">OFF</button>
                        <button class="underlay-btn active" data-underlay="line" id="underlay-line">LINE</button>
                        <button class="underlay-btn" data-underlay="candle" id="underlay-candle">CANDLE</button>
                    </div>
                </div>

                <span class="filter-label">Signals:</span>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-strong_bullish"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-strong_bullish">Strong Bullish</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-strong_bearish"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-strong_bearish">Strong Bearish</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-accumulation"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-accumulation">Accumulation</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-distribution"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-distribution">Distribution</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-test_support"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-test_support">Test Support</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-test_resistance"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-test_resistance">Test Resistance</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-climax_bottom"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-climax_bottom">Climax Bottom</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-climax_top"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-climax_top">Climax Top</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-weak_down"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-weak_down">Weak Down</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-weak_up"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-weak_up">Weak Up</span>
                </div>

                <div class="toggle-group bullish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-no_supply"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-no_supply">No Supply</span>
                </div>

                <div class="toggle-group bearish-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-no_demand"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-no_demand">No Demand</span>
                </div>

                <div class="toggle-group neutral-color">
                    <label class="toggle-switch"><input type="checkbox" id="filter-neutral"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-neutral">Neutral</span>
                </div>
            </div>
            
            <div class="chart-area">
                <div class="charts-container">
                    <div id="price-chart"></div>
                    <div id="volume-chart"></div>
                </div>
                
                <!-- RIGHT: Analysis Sidebar -->
                <div class="analysis-sidebar" id="analysis-sidebar">
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" data-tab="composite">Composite</button>
                        <button class="sidebar-tab" data-tab="analysis">VPA</button>
                        <button class="sidebar-tab" data-tab="signals">Signals</button>
                        <button class="mobile-close-btn" id="analysis-close-btn" aria-label="Close Analysis">×</button>
                    </div>
                    
                    <div class="sidebar-content" id="sidebar-content">
                        <!-- COMPOSITE TAB -->
                        <div class="tab-content active" id="tab-composite">
                            <div class="composite-card">
                                <h4>Composite Signal</h4>
                                <div id="composite-gauge" class="composite-signal-gauge neutral">
                                    <div class="composite-action-label" id="comp-action">-</div>
                                    <div class="composite-signal-sub" id="comp-signal-sub"></div>
                                    <div class="composite-meta">
                                        <span>Score: <strong id="comp-score">-</strong></span>
                                        <span>Conf: <strong id="comp-conf">-</strong></span>
                                    </div>
                                </div>
                                <div id="comp-archetype"></div>
                            </div>

                            <div class="composite-card">
                                <h4>Greeks</h4>
                                <div class="greeks-grid" id="greeks-grid">
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-delta">-</div><div class="greek-label">Δ Delta</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-gamma">-</div><div class="greek-label">Γ Gamma</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-theta">-</div><div class="greek-label">Θ Theta</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-vega">-</div><div class="greek-label">ν Vega</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-iv">-</div><div class="greek-label">IV</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-oi">-</div><div class="greek-label">Open Int</div></div>
                                </div>
                            </div>

                            <div class="composite-card">
                                <h4>Chain Metrics</h4>
                                <div class="chain-grid" id="chain-grid">
                                    <div class="chain-item"><div class="chain-value" id="cm-ivr">-</div><div class="chain-label">IV Rank</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-gex">-</div><div class="chain-label">GEX</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-pcr">-</div><div class="chain-label">P/C Ratio</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-maxpain">-</div><div class="chain-label">Max Pain</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-calloi">-</div><div class="chain-label">Call OI</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-putoi">-</div><div class="chain-label">Put OI</div></div>
                                </div>
                                <div id="uoa-container"></div>
                            </div>

                            <div class="composite-card">
                                <h4>Factor Breakdown</h4>
                                <div class="factor-list" id="factor-list">
                                    <div class="loading">Analyze to see factors</div>
                                </div>
                            </div>

                            <div class="composite-card">
                                <h4>Recommendation</h4>
                                <div class="recommendation-box" id="comp-recommendation">Analyze an option to see composite signal</div>
                            </div>
                        </div>

                        <!-- VPA TAB -->
                        <div class="tab-content" id="tab-analysis">
                        <div class="bias-card">
                            <h4>Market Bias</h4>
                            <div id="bias-container" class="bias-indicator neutral">
                                <div class="bias-label">-</div>
                                <div class="bias-strength">Load data to analyze</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid" id="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bars">-</div>
                                <div class="stat-label">Bars</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-signals">-</div>
                                <div class="stat-label">Signals</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bullish">-</div>
                                <div class="stat-label">Bullish</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bearish">-</div>
                                <div class="stat-label">Bearish</div>
                            </div>
                        </div>
                        
                        <div class="signals-header">Recent Signals</div>
                        <div id="signals-container" class="signal-list">
                            <div class="loading">No signals yet</div>
                        </div>
                        </div><!-- end tab-analysis -->

                        <!-- SIGNALS TAB -->
                        <div class="tab-content" id="tab-signals">
                            <div class="signals-header">All Signals (Chronological)</div>
                            <div id="signals-container-full" class="signal-list">
                                <div class="loading">No signals yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Signal Peek Banner (Mobile only) -->
    <div class="signal-peek" id="signal-peek">
        <div class="signal-peek-content">
            <div class="signal-peek-header">
                <span class="signal-peek-name" id="signal-peek-name">-</span>
                <span class="signal-peek-badge bullish" id="signal-peek-badge">BULLISH</span>
            </div>
            <div class="signal-peek-details">
                <span class="signal-peek-description" id="signal-peek-description">-</span>
                <div class="signal-peek-meta">
                    <span class="signal-peek-confidence" id="signal-peek-confidence">-</span>
                    <span class="signal-peek-time" id="signal-peek-time">-</span>
                    <span class="signal-peek-price" id="signal-peek-price">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Action Banner (above bottom nav) -->
    <div class="mobile-action-banner" id="mobile-action-banner">
        <div class="mobile-action-banner-content">
            <span class="mobile-action-label" id="mob-action-label">-</span>
            <div class="mobile-action-meta">
                <div>Score: <strong id="mob-action-score">-</strong></div>
                <div id="mob-action-signal">-</div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav" id="mobile-bottom-nav">
        <button class="mobile-nav-item" id="nav-watchlist" aria-label="Watchlist">
            <span class="nav-icon">☰</span>
            <span>Watchlist</span>
        </button>
        <button class="mobile-nav-item active" id="nav-chart" aria-label="Chart">
            <span class="nav-icon">📈</span>
            <span>Chart</span>
        </button>
        <button class="mobile-nav-item" id="nav-settings" aria-label="Settings">
            <span class="nav-icon">⚙</span>
            <span>Settings</span>
        </button>
        <button class="mobile-nav-item" id="nav-analysis" aria-label="Analysis">
            <span class="nav-icon">📊</span>
            <span>Analysis</span>
            <span class="nav-badge" id="nav-analysis-badge"></span>
        </button>
    </nav>
    
    <script>
        // ===== STATE =====
        let priceChart = null;
        let volumeChart = null;
        let candlestickSeries = null;
        let volumeSeries = null;
        let currentInterval = 5;
        let currentSymbol = 'SPY';
        let watchlistData = {};
        let priceUpdateInterval = null;
        
        // Live mode state
        let liveMode = false;
        let liveInterval = null;
        let liveCountdown = 10;
        let liveCountdownInterval = null;
        let mockMode = false;          // mock data for testing
        let lastBarDatetime = null;    // tracks the last bar for delta updates
        let liveWs = null;             // WebSocket connection for live option feed
        let liveWsTicker = null;       // currently subscribed option ticker
        
        // Watchlist WS state
        let watchlistWs = null;         // dedicated WS for watchlist price streaming
        let watchlistWsReconnectTimer = null;
        let liveUnderlyingTicker = null;  // underlying stock ticker subscribed for chart overlay
        
        // Controls collapse state
        let controlsCollapsed = false;
        let hasAnalyzed = false;
        
        // Signal peek state
        let latestSignalData = null;

        // Last analysis data for re-filtering
        let lastAnalysisData = null;

        // Track last composite action for change-detection toasts
        let lastCompositeAction = null;

        // Track last VPA-derived action (BUY/SELL/HOLD) for historical chart markers
        let lastVpaAction = null;

        // Underlying underlay state
        let underlayMode = 'line';  // 'off', 'line', 'candle'
        let underlaySeries = null;
        let underlayBarsData = [];   // raw underlying bars from API

        // ===== TIMEZONE HELPER =====
        // Backend sends datetimes already in US/Eastern.
        // We parse them as-is into a Unix timestamp so the chart axis shows ET.
        // Append 'Z' to force UTC parse, so the numeric value IS the Eastern wall-clock.
        function toEasternUnix(datetimeStr) {
            // "2026-02-06 09:30:00" → treat digits as Eastern wall-clock
            const iso = datetimeStr.replace(' ', 'T') + 'Z';   // force UTC parse
            return Math.floor(new Date(iso).getTime() / 1000);
        }

        function toEasternString(datetimeStr) {
            // Already in Eastern – just reformat
            const d = new Date(datetimeStr.replace(' ', 'T') + 'Z');
            return d.toISOString().replace('T', ' ').replace('Z', '');
        }

        // ===== SIGNAL FILTER HELPERS =====
        function getEnabledSignals() {
            const enabled = new Set();
            document.querySelectorAll('.filter-bar input[type=checkbox]').forEach(cb => {
                if (cb.checked) enabled.add(cb.id.replace('filter-', ''));
            });
            return enabled;
        }

        function filterSignals(signals) {
            const enabled = getEnabledSignals();
            return signals.filter(s => enabled.has(s.signal));
        }

        function updateFilteredMarkers(signals) {
            if (!candlestickSeries) return;
            // Use the unified marker builder so composite + VPA markers coexist
            rebuildAllMarkers();
        }
        
        // Chart data tracking for incremental updates
        let currentBarTimestamps = new Set();
        
        // Mobile responsiveness breakpoints
        // Portrait mobile: width <= 768px (standard mobile breakpoint)
        // Landscape mobile: width <= 1024px AND height <= 500px
        // This ensures phones in landscape (e.g., iPhone X: 812x375) are detected as mobile
        // while tablets in landscape (typically height > 500px) are treated as desktop
        const MOBILE_MAX_WIDTH = 768;
        const LANDSCAPE_MAX_WIDTH = 1024;
        const LANDSCAPE_MAX_HEIGHT = 500;
        
        // Wire up filter toggle events
        document.querySelectorAll('.filter-bar input[type=checkbox]').forEach(cb => {
            cb.addEventListener('change', () => {
                const label = document.querySelector(`[data-for="${cb.id}"]`);
                if (label) label.classList.toggle('active', cb.checked);
                if (lastAnalysisData) {
                    updateFilteredMarkers(lastAnalysisData.signals || []);
                    updateAnalysis(lastAnalysisData);
                }
            });
        });
        document.querySelectorAll('.filter-bar .toggle-text').forEach(label => {
            label.addEventListener('click', () => {
                const cb = document.getElementById(label.dataset.for);
                if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
            });
        });

        // Signal type constants
        const BULLISH_SIGNALS = [
            'strong_bullish', 'accumulation', 'test_support', 'climax_bottom', 
            'weak_down', 'no_supply', 'pin_bar_bull', 'confirmed_reversal_up'
        ];
        const BEARISH_SIGNALS = [
            'strong_bearish', 'distribution', 'test_resistance', 'climax_top', 
            'no_demand', 'pin_bar_bear', 'confirmed_reversal_down'
        ];

        // Classify a VPA signal to BUY / SELL / HOLD
        function classifySignal(signalName) {
            if (BULLISH_SIGNALS.includes(signalName)) return 'BUY';
            if (BEARISH_SIGNALS.includes(signalName)) return 'SELL';
            return 'HOLD';
        }

        // Build deduplicated BUY/SELL/HOLD transition markers from VPA signals
        function buildActionMarkers(signals) {
            if (!signals || signals.length === 0) return [];
            // Sort chronologically
            const sorted = [...signals].sort((a, b) => {
                return new Date(a.datetime.replace(' ', 'T') + 'Z') - new Date(b.datetime.replace(' ', 'T') + 'Z');
            });
            const markers = [];
            let prevAction = null;
            for (const sig of sorted) {
                const action = classifySignal(sig.signal);
                if (action !== prevAction) {
                    const isBuy = action === 'BUY';
                    const isSell = action === 'SELL';
                    markers.push({
                        time: toEasternUnix(sig.datetime),
                        position: isBuy ? 'belowBar' : 'aboveBar',
                        color: isBuy ? '#00e676' : isSell ? '#ff1744' : 'rgba(255,176,60,0.30)',
                        shape: isBuy ? 'arrowUp' : isSell ? 'arrowDown' : 'circle',
                        text: action,
                    });
                    prevAction = action;
                }
            }
            return markers;
        }
        
        // Default watchlist symbols with metadata
        const defaultWatchlist = [
            { symbol: 'SPY', name: 'S&P 500 ETF' },
            { symbol: 'QQQ', name: 'Nasdaq 100 ETF' },
            { symbol: 'IWM', name: 'Russell 2000 ETF' },
            { symbol: 'AAPL', name: 'Apple Inc' },
            { symbol: 'MSFT', name: 'Microsoft Corp' },
            { symbol: 'NVDA', name: 'NVIDIA Corp' },
            { symbol: 'TSLA', name: 'Tesla Inc' },
            { symbol: 'AMD', name: 'AMD Inc' },
            { symbol: 'AMZN', name: 'Amazon.com' },
            { symbol: 'META', name: 'Meta Platforms' },
            { symbol: 'GOOGL', name: 'Alphabet Inc' }
        ];

        // ===== AUTH HELPER =====
        async function authFetch(url, options) {
            const res = await fetch(url, options);
            if (res.status === 401) {
                window.location.href = '/login';
                throw new Error('Session expired');
            }
            return res;
        }

        // ===== MOBILE FUNCTIONS =====
        function isMobile() {
            // Check for portrait mobile or landscape mobile
            return window.innerWidth <= MOBILE_MAX_WIDTH || 
                   (window.innerWidth <= LANDSCAPE_MAX_WIDTH && window.innerHeight <= LANDSCAPE_MAX_HEIGHT);
        }

        function openWatchlist() {
            if (isMobile()) {
                document.getElementById('watchlist-sidebar').classList.add('mobile-open');
                document.getElementById('backdrop').classList.add('active');
                document.getElementById('mobile-action-banner').classList.remove('visible');
                setActiveNav('nav-watchlist');
            }
        }

        function closeWatchlist() {
            if (isMobile()) {
                document.getElementById('watchlist-sidebar').classList.remove('mobile-open');
                document.getElementById('backdrop').classList.remove('active');
                if (lastCompositeResult) {
                    document.getElementById('mobile-action-banner').classList.add('visible');
                }
                setActiveNav('nav-chart');
            }
        }

        // ===== MOBILE NAV HELPERS =====
        function setActiveNav(id) {
            document.querySelectorAll('.mobile-nav-item').forEach(btn => btn.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
        }

        function updateMobileActionBanner(comp) {
            if (!comp || !comp.action) return;
            const banner = document.getElementById('mobile-action-banner');
            const action = comp.action.toUpperCase();
            let cls = 'hold';
            if (action.includes('BUY')) cls = 'buy';
            else if (action.includes('SELL')) cls = 'sell';
            banner.className = `mobile-action-banner ${cls}`;
            document.getElementById('mob-action-label').textContent = action;
            const pct = Math.round(comp.confidence * 100);
            document.getElementById('mob-action-score').textContent = `${comp.score > 0 ? '+' : ''}${comp.score.toFixed(3)} (${pct}%)`;
            document.getElementById('mob-action-signal').textContent = comp.signal.replace(/_/g, ' ');
            // Show banner if analysis panel is not open
            if (!document.getElementById('analysis-sidebar').classList.contains('mobile-open')) {
                banner.classList.add('visible');
            }
            // Light up nav badge
            const badge = document.getElementById('nav-analysis-badge');
            if (badge) {
                badge.style.background = cls === 'buy' ? '#26a69a' : cls === 'sell' ? '#ef5350' : '#787b86';
                badge.classList.add('visible');
            }
        }

        function toggleWatchlist() {
            const sidebar = document.getElementById('watchlist-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeWatchlist();
            } else {
                openWatchlist();
                // Close analysis if open
                closeAnalysis();
            }
        }

        function openAnalysis() {
            if (isMobile()) {
                document.getElementById('analysis-sidebar').classList.add('mobile-open');
                document.getElementById('backdrop').classList.add('active');
                // Hide signal peek and action banner when analysis is open
                document.getElementById('signal-peek').classList.remove('visible');
                document.getElementById('mobile-action-banner').classList.remove('visible');
                // Update nav highlight
                setActiveNav('nav-analysis');
            }
        }

        function closeAnalysis() {
            if (isMobile()) {
                document.getElementById('analysis-sidebar').classList.remove('mobile-open');
                document.getElementById('backdrop').classList.remove('active');
                // Show signal peek when analysis closes (if data exists)
                if (latestSignalData) {
                    document.getElementById('signal-peek').classList.add('visible');
                }
                // Show action banner if we have composite data
                if (lastCompositeResult) {
                    document.getElementById('mobile-action-banner').classList.add('visible');
                }
                setActiveNav('nav-chart');
            }
        }

        function toggleAnalysis() {
            const sidebar = document.getElementById('analysis-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeAnalysis();
            } else {
                openAnalysis();
                // Close watchlist if open
                closeWatchlist();
            }
        }

        function closeAllMobilePanels() {
            closeWatchlist();
            closeAnalysis();
        }

        function handleResize() {
            // Handle mobile controls visibility and state
            if (isMobile()) {
                // Cache DOM references
                const controlsSummary = document.getElementById('controls-summary');
                
                // Ensure controls-summary is active on mobile
                if (controlsSummary && !controlsSummary.classList.contains('active')) {
                    controlsSummary.classList.add('active');
                    collapseControls();
                }
            } else {
                // Reset mobile panels when switching to desktop
                closeAllMobilePanels();
                
                // Cache DOM references
                const controlsSummary = document.getElementById('controls-summary');
                const controlsBar = document.getElementById('controls-bar');
                
                // Reset controls state on desktop
                if (controlsSummary && controlsBar && controlsSummary.classList.contains('active')) {
                    controlsSummary.classList.remove('active');
                    controlsBar.classList.remove('collapsed');
                    controlsCollapsed = false;
                }
            }
            // Trigger chart resize
            if (priceChart && volumeChart) {
                setTimeout(() => {
                    priceChart.resize(
                        document.getElementById('price-chart').clientWidth,
                        document.getElementById('price-chart').clientHeight
                    );
                    volumeChart.resize(
                        document.getElementById('volume-chart').clientWidth,
                        document.getElementById('volume-chart').clientHeight
                    );
                }, 100);
            }
        }
        
        // ===== CONTROLS COLLAPSE FUNCTIONS =====
        function collapseControls() {
            if (isMobile()) {
                document.getElementById('controls-bar').classList.add('collapsed');
                document.getElementById('controls-summary').classList.add('active');
                document.getElementById('filter-bar').style.display = 'none';
                controlsCollapsed = true;
            }
        }
        
        function expandControls() {
            if (isMobile()) {
                document.getElementById('controls-bar').classList.remove('collapsed');
                document.getElementById('controls-summary').classList.remove('active');
                document.getElementById('filter-bar').style.display = '';
                controlsCollapsed = false;
            }
        }
        
        function toggleControls() {
            if (controlsCollapsed) {
                expandControls();
            } else {
                collapseControls();
            }
        }
        
        function updateSummaryText() {
            const symbol = currentSymbol;
            const strike = document.getElementById('strike').value;
            const right = document.getElementById('right').value;
            const intervalText = currentInterval === 1 ? '1m' : currentInterval === 5 ? '5m' : currentInterval === 15 ? '15m' : '1H';
            
            if (strike) {
                const rightText = right === 'C' ? 'C' : 'P';
                document.getElementById('summary-text').textContent = `${symbol} $${strike}${rightText} ${intervalText}`;
            }
        }
        
        // ===== SIGNAL PEEK FUNCTIONS =====
        function updateSignalPeek(signals) {
            if (!signals || signals.length === 0) {
                latestSignalData = null;
                document.getElementById('signal-peek').classList.remove('visible');
                return;
            }
            
            const latestSignal = signals[signals.length - 1];
            latestSignalData = latestSignal;
            
            const isBullish = BULLISH_SIGNALS.includes(latestSignal.signal);
            
            const peek = document.getElementById('signal-peek');
            peek.className = `signal-peek ${isBullish ? '' : 'bearish'}`;
            
            document.getElementById('signal-peek-name').textContent = latestSignal.signal.replace(/_/g, ' ').toUpperCase();
            document.getElementById('signal-peek-description').textContent = latestSignal.description || '';
            document.getElementById('signal-peek-confidence').textContent = `${Math.round(latestSignal.confidence * 100)}%`;
            document.getElementById('signal-peek-time').textContent = new Date(latestSignal.datetime).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            document.getElementById('signal-peek-price').textContent = `$${latestSignal.price.toFixed(2)}`;
            
            // Update badge
            const badge = document.getElementById('signal-peek-badge');
            badge.textContent = isBullish ? 'BULLISH' : 'BEARISH';
            badge.className = `signal-peek-badge ${isBullish ? 'bullish' : 'bearish'}`;
            
            // Only show if analysis sidebar is not open
            if (isMobile() && !document.getElementById('analysis-sidebar').classList.contains('mobile-open')) {
                peek.classList.add('visible');
            }
        }
        
        // ===== LIVE MODE FUNCTIONS =====
        function updateLiveButton() {
            const desktopBtn = document.getElementById('live-btn');
            const summaryBtn = document.getElementById('summary-live-btn');
            
            if (liveMode) {
                const prefix = mockMode ? '🟡 MOCK ' : '🔴 LIVE ';
                const dot = liveWs && liveWs.readyState === WebSocket.OPEN ? '●' : '○';
                const text = `${prefix}${dot}`;
                desktopBtn.textContent = text;
                if (summaryBtn) {
                    summaryBtn.textContent = `LIVE ${dot}`;
                    summaryBtn.classList.add('active');
                }
            } else {
                desktopBtn.textContent = '⚪ LIVE';
                if (summaryBtn) {
                    summaryBtn.textContent = 'LIVE';
                    summaryBtn.classList.remove('active');
                }
            }
        }

        // Build OCC-format option ticker: O:SPY251219C00650000
        function formatOptionTicker(symbol, expiration, strike, right) {
            const d = new Date(expiration + 'T00:00:00');
            const yy = String(d.getFullYear()).slice(2);
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const strikeInt = Math.round(strike * 1000);
            const strikePad = String(strikeInt).padStart(8, '0');
            return `O:${symbol.toUpperCase()}${yy}${mm}${dd}${right.toUpperCase()}${strikePad}`;
        }

        // Connect to the live WebSocket feed
        function connectLiveWs() {
            if (liveWs && (liveWs.readyState === WebSocket.OPEN || liveWs.readyState === WebSocket.CONNECTING)) {
                return;  // already connected
            }

            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const url = `${proto}//${location.host}/ws/live`;
            console.log('[LiveWS] Connecting to', url);

            liveWs = new WebSocket(url);

            const thisWs = liveWs;   // capture ref for onclose guard

            liveWs.onopen = () => {
                console.log('[LiveWS] Connected');
                updateLiveButton();

                // If we already have a pending subscription, send it now
                if (liveWsTicker) {
                    const subMsg = { action: 'subscribe', ticker: liveWsTicker, mock: mockMode };
                    if (mockMode) subMsg.interval = currentInterval;
                    liveWs.send(JSON.stringify(subMsg));
                    console.log('[LiveWS] Subscribed to', liveWsTicker, mockMode ? '(mock)' : '');
                }
            };

            liveWs.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleLiveMessage(msg);
                } catch (e) {
                    console.warn('[LiveWS] Bad message:', e);
                }
            };

            liveWs.onclose = (event) => {
                console.log('[LiveWS] Disconnected, code:', event.code);
                updateLiveButton();

                // Auto-reconnect only if still in live mode AND this is the current WS
                if (liveMode && liveWs === thisWs) {
                    setTimeout(() => {
                        console.log('[LiveWS] Reconnecting...');
                        connectLiveWs();
                    }, 2000);
                }
            };

            liveWs.onerror = (err) => {
                console.error('[LiveWS] Error:', err);
            };
        }

        // Handle incoming WebSocket messages
        function handleLiveMessage(msg) {
            const type = msg.type;

            if (type === 'sow') {
                // Snapshot of world — initial bars on subscribe
                const bars = msg.bars || [];
                if (bars.length > 0) {
                    console.log(`[LiveWS] SOW: ${bars.length} bars for ${msg.ticker}`);

                    // Update chart with SOW bars incrementally 
                    window._chartDataLoading = true;
                    for (const bar of bars) {
                        const t = toEasternUnix(bar.datetime);
                        candlestickSeries.update({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                        volumeSeries.update({ time: t, value: bar.volume, color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)' });
                    }
                    window._chartDataLoading = false;

                    // Append to analysis data
                    if (lastAnalysisData) {
                        lastAnalysisData.bars = lastAnalysisData.bars.concat(bars);
                    }

                    // Update price header
                    const lastBar = bars[bars.length - 1];
                    document.getElementById('contract-price').textContent = `$${lastBar.close.toFixed(2)}`;
                    document.getElementById('stat-bars').textContent = lastAnalysisData ? lastAnalysisData.bars.length : bars.length;
                }

            } else if (type === 'bar') {
                // Real-time bar update
                const bar = msg.bar;
                const signals = msg.signals || [];

                if (!bar) return;

                const ticker = msg.ticker || '';

                // Log every 10th bar to avoid console spam
                if (!window._liveBarCount) window._liveBarCount = 0;
                window._liveBarCount++;
                if (window._liveBarCount <= 3 || window._liveBarCount % 10 === 0) {
                    console.log(`[LiveWS] bar #${window._liveBarCount}: ${ticker} close=${bar.close} vol=${bar.volume}`);
                }

                // ── Underlying stock overlay update ──
                if (ticker === liveUnderlyingTicker && liveMode && underlaySeries) {
                    const t = toEasternUnix(bar.datetime);
                    if (underlayMode === 'line') {
                        underlaySeries.update({ time: t, value: bar.close });
                    } else if (underlayMode === 'candle') {
                        underlaySeries.update({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                    }
                    // Also keep underlayBarsData in sync for mode switches
                    underlayBarsData.push({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                    return; // underlying bars don't update the main chart
                }

                // ── Option contract bar update ──
                const chartsContainer = document.querySelector('.charts-container');
                chartsContainer.classList.add('live-refreshing');

                // Update chart
                const t = toEasternUnix(bar.datetime);
                window._chartDataLoading = true;
                candlestickSeries.update({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                volumeSeries.update({ time: t, value: bar.volume, color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)' });
                window._chartDataLoading = false;

                // Track for delta state
                lastBarDatetime = bar.datetime;

                // Append to analysis data
                if (lastAnalysisData) {
                    lastAnalysisData.bars.push(bar);
                    if (signals.length > 0) {
                        lastAnalysisData.signals = (lastAnalysisData.signals || []).concat(signals);
                    }
                }

                // Update contract header price
                document.getElementById('contract-price').textContent = `$${bar.close.toFixed(2)}`;

                // Update markers if new signals
                if (signals.length > 0) {
                    updateFilteredMarkers(lastAnalysisData ? lastAnalysisData.signals : signals);
                    updateAnalysis(lastAnalysisData || { bars: [bar], signals: signals, bias: {} });
                }

                // Update stats
                document.getElementById('stat-bars').textContent = lastAnalysisData ? lastAnalysisData.bars.length : 1;

                setTimeout(() => chartsContainer.classList.remove('live-refreshing'), 200);

            } else if (type === 'analysis') {
                // Server-pushed full re-analysis (composite, greeks, bias, signals)
                console.log('[LiveWS] Analysis update received');

                // Update composite gauge + greeks panel
                if (msg.composite) {
                    const newAction = msg.composite.action;
                    if (lastCompositeAction !== null && newAction !== lastCompositeAction) {
                        showSignalToast(lastCompositeAction, newAction, msg.composite);
                    }
                    lastCompositeAction = newAction;
                    updateComposite(msg.composite);
                }

                // Update bias indicator
                if (msg.bias && msg.bias.bias) {
                    const biasContainer = document.getElementById('bias-container');
                    biasContainer.className = `bias-indicator ${msg.bias.bias}`;
                    biasContainer.innerHTML = `
                        <div class="bias-label">${msg.bias.bias}</div>
                        <div class="bias-strength">Strength: ${Math.round((msg.bias.strength || 0) * 100)}%</div>
                        <div class="bias-reason">${msg.bias.reason || ''}</div>
                    `;
                }

                // Update signal stats from full history
                if (msg.all_signals) {
                    const allSig = msg.all_signals;
                    const BULLISH = ['strong_bullish','accumulation','test_support','no_supply','pin_bar_bull'];
                    const BEARISH = ['strong_bearish','distribution','test_resistance','no_demand','pin_bar_bear'];
                    document.getElementById('stat-signals').textContent = allSig.length;
                    document.getElementById('stat-bullish').textContent = allSig.filter(s => BULLISH.includes(s.signal)).length;
                    document.getElementById('stat-bearish').textContent = allSig.filter(s => BEARISH.includes(s.signal)).length;

                    // Also update markers on chart with full signal set
                    if (lastAnalysisData) {
                        lastAnalysisData.signals = allSig;
                        updateFilteredMarkers(allSig);
                    }
                }

                if (msg.total_bars) {
                    document.getElementById('stat-bars').textContent = msg.total_bars;
                }

                // Update contract price from latest bar close
                if (msg.last_price) {
                    document.getElementById('contract-price').textContent = `$${msg.last_price.toFixed(2)}`;
                }

            } else if (type === 'subscribed') {
                console.log('[LiveWS] Confirmed subscription:', msg.ticker);

            } else if (type === 'unsubscribed') {
                console.log('[LiveWS] Confirmed unsubscription:', msg.ticker);

            } else if (type === 'status') {
                console.log('[LiveWS] Feed status:', msg);

            } else if (type === 'error') {
                console.warn('[LiveWS] Error:', msg.message);

                // Connection-limit or auth errors → show modal, revert live mode
                if (msg.code === 'conn_limit' || msg.code === 'auth_failed') {
                    const modal = document.getElementById('conn-limit-modal');
                    const msgEl = document.getElementById('conn-limit-msg');
                    if (msg.code === 'conn_limit') {
                        msgEl.textContent = 'Polygon\u2019s WebSocket connection limit has been exceeded. The server is backing off and will retry automatically. Please wait ~30 seconds before trying live mode again.';
                    } else {
                        msgEl.textContent = msg.message || 'Authentication failed. Your Polygon plan may not support live WebSocket streaming.';
                    }
                    modal.classList.add('active');

                    // Auto-revert live mode so user isn't stuck
                    stopLiveMode();
                }
            }
        }

        // ===== WATCHLIST WEBSOCKET (dedicated price streaming) =====

        function connectWatchlistWs() {
            if (watchlistWs && (watchlistWs.readyState === WebSocket.OPEN || watchlistWs.readyState === WebSocket.CONNECTING)) {
                return;
            }

            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const url = `${proto}//${location.host}/ws/watchlist`;
            console.log('[WatchlistWS] Connecting to', url);

            watchlistWs = new WebSocket(url);

            watchlistWs.onopen = () => {
                console.log('[WatchlistWS] Connected');
                sendWatchlistSymbols();
            };

            watchlistWs.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleWatchlistMessage(msg);
                } catch (e) {
                    console.warn('[WatchlistWS] Bad message:', e);
                }
            };

            watchlistWs.onclose = (event) => {
                console.log('[WatchlistWS] Disconnected, code:', event.code);
                if (watchlistWsReconnectTimer) clearTimeout(watchlistWsReconnectTimer);
                watchlistWsReconnectTimer = setTimeout(() => {
                    console.log('[WatchlistWS] Reconnecting...');
                    connectWatchlistWs();
                }, 3000);
            };

            watchlistWs.onerror = (err) => {
                console.error('[WatchlistWS] Error:', err);
            };
        }

        function sendWatchlistSymbols() {
            if (!watchlistWs || watchlistWs.readyState !== WebSocket.OPEN) return;
            const symbols = defaultWatchlist.map(w => w.symbol);
            // Always use real API for stock prices (mock mode only affects option WS feed)
            watchlistWs.send(JSON.stringify({ symbols: symbols, mock: false }));
            console.log('[WatchlistWS] Sent', symbols.length, 'symbols (always real prices)');
        }

        function handleWatchlistMessage(msg) {
            const type = msg.type;

            if (type === 'prices') {
                const prices = msg.prices || [];
                for (const price of prices) {
                    const prevPrice = watchlistData[price.symbol]?.price;
                    watchlistData[price.symbol] = {
                        ...price,
                        prevPrice: prevPrice || price.price,
                        direction: prevPrice ? (price.price > prevPrice ? 'up' : price.price < prevPrice ? 'down' : null) : null,
                    };
                }
                renderWatchlist();

            } else if (type === 'subscribed') {
                console.log('[WatchlistWS] Subscribed:', msg.symbols?.join(', '));
            } else if (type === 'error') {
                console.warn('[WatchlistWS] Error:', msg.message);
            }
        }

        /**
         * Subscribe to the underlying stock for live chart overlay.
         * Uses liveWs (the options feed WS) for real-time bar streaming of the underlying.
         */
        function subscribeUnderlyingLive(symbol) {
            if (liveUnderlyingTicker === symbol) return;

            // Unsubscribe previous underlying
            if (liveUnderlyingTicker) {
                if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                    liveWs.send(JSON.stringify({ action: 'unsubscribe', ticker: liveUnderlyingTicker }));
                }
            }

            liveUnderlyingTicker = symbol;

            // Subscribe via the live options WS (always real for stock data)
            if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                liveWs.send(JSON.stringify({ action: 'subscribe', ticker: symbol, mock: false }));
                console.log(`[LiveWS] Subscribed to underlying: ${symbol} (always real)`);
            }
        }

        function unsubscribeUnderlyingLive() {
            if (!liveUnderlyingTicker) return;

            if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                liveWs.send(JSON.stringify({ action: 'unsubscribe', ticker: liveUnderlyingTicker }));
            }
            liveUnderlyingTicker = null;
        }

        // Live-mode poll: FALLBACK for mock mode (WebSocket not used for mock)
        async function livePoll() {
            const expiration = document.getElementById('expiration').value;
            const strike = document.getElementById('strike').value;
            const right = document.getElementById('right').value;

            if (!currentSymbol || !expiration || !strike) return;

            const chartsContainer = document.querySelector('.charts-container');
            chartsContainer.classList.add('live-refreshing');

            try {
                let url = `/api/analyze/live?symbol=${currentSymbol}&expiration=${expiration}&strike=${strike}&right=${right}`;
                // mock param not needed – live poll always uses real API
                if (lastBarDatetime) url += `&after=${encodeURIComponent(lastBarDatetime)}`;

                const res = await authFetch(url);
                if (!res.ok) return;
                const data = await res.json();

                const newBars = data.bars || [];
                const newSignals = data.signals || [];

                if (newBars.length === 0) return;

                lastBarDatetime = newBars[newBars.length - 1].datetime;

                window._chartDataLoading = true;
                for (const bar of newBars) {
                    const t = toEasternUnix(bar.datetime);
                    candlestickSeries.update({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                    volumeSeries.update({ time: t, value: bar.volume, color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)' });
                }
                window._chartDataLoading = false;

                if (lastAnalysisData) {
                    lastAnalysisData.bars = lastAnalysisData.bars.concat(newBars);
                    lastAnalysisData.signals = (lastAnalysisData.signals || []).concat(newSignals);
                }

                const lastBar = newBars[newBars.length - 1];
                document.getElementById('contract-price').textContent = `$${lastBar.close.toFixed(2)}`;

                if (newSignals.length > 0) {
                    updateFilteredMarkers(lastAnalysisData ? lastAnalysisData.signals : newSignals);
                    updateAnalysis(lastAnalysisData || { bars: newBars, signals: newSignals, bias: {} });
                }

                document.getElementById('stat-bars').textContent = lastAnalysisData ? lastAnalysisData.bars.length : newBars.length;

            } catch (e) {
                console.warn('Live poll error:', e.message);
            } finally {
                chartsContainer.classList.remove('live-refreshing');
                const interval = mockMode ? 1 : 10;
                liveCountdown = interval;
                updateLiveButton();
            }
        }
        
        function toggleLiveMode() {
            if (liveMode) {
                stopLiveMode();
            } else {
                const expiration = document.getElementById('expiration').value;
                const strike = document.getElementById('strike').value;
                const right = document.getElementById('right').value;

                if (!currentSymbol || !expiration || !strike) {
                    alert('Select a contract before going live');
                    return;
                }

                // Start live mode
                liveMode = true;
                
                // Add active class to button
                document.getElementById('live-btn').classList.add('active');
                document.getElementById('summary-live-btn').classList.add('active');
                document.getElementById('summary-live-btn').textContent = 'LIVE ●';
                
                // Track the last bar we already have for delta updates
                if (lastAnalysisData && lastAnalysisData.bars && lastAnalysisData.bars.length > 0) {
                    lastBarDatetime = lastAnalysisData.bars[lastAnalysisData.bars.length - 1].datetime;
                } else {
                    lastBarDatetime = null;
                }

                if (mockMode) {
                    // Mock mode: connect WS and let the SOW (snapshot) populate the chart
                    liveWsTicker = formatOptionTicker(currentSymbol, expiration, parseFloat(strike), right);
                    console.log('[LiveWS] Will subscribe (MOCK) to:', liveWsTicker);

                    // Clear chart + underlay so mock SOW starts clean
                    if (candlestickSeries) candlestickSeries.setData([]);
                    if (volumeSeries) volumeSeries.setData([]);
                    removeUnderlay();
                    underlayBarsData = [];
                    lastAnalysisData = { bars: [], signals: [], bias: {}, composite: {} };
                    window._liveBarCount = 0;

                    // Auto-analyze to populate composite/greeks panels (real API)
                    analyze().catch(() => {});

                    // Start mock WS immediately — backend sends SOW then live bars
                    connectLiveWs();
                    if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                        liveWs.send(JSON.stringify({ action: 'subscribe', ticker: liveWsTicker, mock: true, interval: currentInterval }));
                    }
                    // Subscribe to underlying stock for live overlay chart
                    subscribeUnderlyingLive(currentSymbol);
                    updateLiveButton();
                } else {
                    // Real mode: use WebSocket for live per-second agg feed
                    liveWsTicker = formatOptionTicker(currentSymbol, expiration, parseFloat(strike), right);
                    console.log('[LiveWS] Will subscribe to:', liveWsTicker);
                    
                    connectLiveWs();

                    // If already connected, subscribe now
                    if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                        liveWs.send(JSON.stringify({ action: 'subscribe', ticker: liveWsTicker, mock: false }));
                    }
                    // Otherwise, onopen handler will send the subscribe

                    // Also subscribe to underlying stock for live overlay chart
                    subscribeUnderlyingLive(currentSymbol);
                    
                    updateLiveButton();
                }
            }
        }
        
        function stopLiveMode() {
            if (liveMode) {
                liveMode = false;
                lastBarDatetime = null;
                lastCompositeAction = null;
                lastVpaAction = null;
                
                // Clear polling intervals (mock mode)
                if (liveInterval) {
                    clearInterval(liveInterval);
                    liveInterval = null;
                }
                if (liveCountdownInterval) {
                    clearInterval(liveCountdownInterval);
                    liveCountdownInterval = null;
                }
                // Unsubscribe from WebSocket feed
                if (liveWs && liveWs.readyState === WebSocket.OPEN && liveWsTicker) {
                    liveWs.send(JSON.stringify({ action: 'unsubscribe', ticker: liveWsTicker }));
                    console.log('[LiveWS] Unsubscribed from', liveWsTicker);
                }
                liveWsTicker = null;

                // Unsubscribe from underlying stock overlay
                unsubscribeUnderlyingLive();

                // Close WebSocket after a short delay (let unsub message send)
                if (liveWs) {
                    const ws = liveWs;
                    liveWs = null;
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.OPEN) ws.close();
                    }, 500);
                }
                
                // Remove active class from button
                document.getElementById('live-btn').classList.remove('active');
                document.getElementById('summary-live-btn').classList.remove('active');
                document.getElementById('summary-live-btn').textContent = 'LIVE';
                
                updateLiveButton();
            }
        }
        
        // ===== WATCHLIST FUNCTIONS =====
        async function loadWatchlistPrices() {
            try {
                const symbols = defaultWatchlist.map(w => w.symbol).join(',');
                let url = `/api/watchlist/prices?symbols=${symbols}`;
                // Always use real API for stock prices (mock mode only affects option WS feed)
                const res = await authFetch(url);
                if (!res.ok) throw new Error('Failed to fetch prices');
                
                const data = await res.json();
                data.prices.forEach(price => {
                    const prevPrice = watchlistData[price.symbol]?.price;
                    watchlistData[price.symbol] = {
                        ...price,
                        prevPrice: prevPrice || price.price,
                        direction: prevPrice ? (price.price > prevPrice ? 'up' : price.price < prevPrice ? 'down' : null) : null
                    };
                });
                
                renderWatchlist();
            } catch (e) {
                console.error('Error loading watchlist:', e);
            }
        }
        
        function renderWatchlist() {
            const container = document.getElementById('watchlist-container');
            const searchTerm = document.getElementById('watchlist-search').value.toLowerCase();
            
            const filteredList = defaultWatchlist.filter(item => 
                item.symbol.toLowerCase().includes(searchTerm) ||
                item.name.toLowerCase().includes(searchTerm)
            );
            
            container.innerHTML = filteredList.map(item => {
                const data = watchlistData[item.symbol] || {};
                const isSelected = item.symbol === currentSymbol;
                const changeClass = data.changePct >= 0 ? 'positive' : 'negative';
                const changeSign = data.changePct >= 0 ? '+' : '';
                const priceClass = data.direction === 'up' ? 'price-up' : data.direction === 'down' ? 'price-down' : '';
                const flashClass = data.direction ? 'price-flash' : '';
                
                return `
                    <div class="watchlist-item ${isSelected ? 'selected' : ''}" data-symbol="${item.symbol}">
                        <div class="watchlist-item-info">
                            <div class="watchlist-symbol">${item.symbol}</div>
                            <div class="watchlist-name">${item.name}</div>
                        </div>
                        <div class="watchlist-price-info">
                            <div class="watchlist-price ${priceClass} ${flashClass}">${data.price != null ? data.price.toFixed(2) : '-'}</div>
                            <div class="watchlist-change ${changeClass}">${data.changePct != null ? `${changeSign}${data.changePct.toFixed(2)}%` : '-'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            container.querySelectorAll('.watchlist-item').forEach(item => {
                item.addEventListener('click', () => selectSymbol(item.dataset.symbol));
            });
            
            // Clear direction flags after render
            Object.keys(watchlistData).forEach(sym => {
                watchlistData[sym].direction = null;
            });
        }
        
        function selectSymbol(symbol) {
            currentSymbol = symbol;
            renderWatchlist();
            loadExpirations(symbol, true);  // autoAnalyze=true
            
            // Stop live mode when symbol changes
            stopLiveMode();
            
            // Update contract info
            const data = watchlistData[symbol] || {};
            document.getElementById('contract-symbol').textContent = symbol;
            document.getElementById('contract-details').textContent = 'Loading...';
            
            // Auto-close watchlist on mobile when symbol is selected
            if (isMobile()) {
                closeWatchlist();
            }
        }
        
        // ===== EXPIRATIONS & STRIKES =====
        async function loadExpirations(symbol, autoAnalyze = false) {
            const select = document.getElementById('expiration');
            select.innerHTML = '<option value="">Loading...</option>';
            
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const res = await authFetch(`/api/expirations/${symbol}`);
                    if (res.status === 429) {
                        select.innerHTML = '<option value="">Rate limited, retrying...</option>';
                        await new Promise(r => setTimeout(r, (attempt + 1) * 5000));
                        continue;
                    }
                    if (!res.ok) throw new Error('Failed to load');
                    
                    const data = await res.json();
                    const today = new Date();
                    
                    select.innerHTML = data.expirations.map(exp => {
                        const expDate = new Date(exp + 'T00:00:00');
                        const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                        const label = diffDays === 0 ? '0DTE' : diffDays === 1 ? '1DTE' : `${diffDays}d`;
                        const dateStr = expDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        return `<option value="${exp}">${dateStr} (${label})</option>`;
                    }).join('');
                    
                    if (data.expirations.length > 0) {
                        await loadStrikes(symbol, data.expirations[0], autoAnalyze);
                    }
                    return;  // success
                } catch (e) {
                    if (attempt === maxRetries - 1) {
                        select.innerHTML = '<option value="">Error loading</option>';
                        // Show retry button next to expiration dropdown
                        showRetryButton(symbol);
                    }
                }
            }
        }

        function showRetryButton(symbol) {
            // Remove existing retry button if any
            const existing = document.getElementById('retry-exp-btn');
            if (existing) existing.remove();

            const btn = document.createElement('button');
            btn.id = 'retry-exp-btn';
            btn.textContent = '↻ Retry';
            btn.style.cssText = 'margin-left:6px;padding:4px 10px;background:#2962ff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;';
            btn.addEventListener('click', () => {
                btn.remove();
                loadExpirations(symbol);
            });
            document.getElementById('expiration').parentNode.appendChild(btn);
        }
        
        async function loadStrikes(symbol, expiration, autoAnalyze = false) {
            const select = document.getElementById('strike');
            select.innerHTML = '<option value="">Loading...</option>';
            
            try {
                // Use watchlistData price if available (no extra API call)
                let underlyingPrice = watchlistData[symbol]?.price || 0;
                
                // If no cached price, try API as fallback
                if (!underlyingPrice) {
                    try {
                        const priceRes = await authFetch(`/api/underlying/${symbol}`);
                        const priceData = await priceRes.json();
                        underlyingPrice = priceData.price || 0;
                    } catch (e) {
                        console.warn('Could not fetch underlying price');
                    }
                }
                
                const res = await authFetch(`/api/strikes/${symbol}/${expiration}`);
                if (!res.ok) throw new Error('Failed to load');
                
                const data = await res.json();
                
                // Find ATM strike
                let atmStrike = data.strikes.reduce((prev, curr) => 
                    Math.abs(curr - underlyingPrice) < Math.abs(prev - underlyingPrice) ? curr : prev
                );
                
                select.innerHTML = data.strikes.map(strike => {
                    const isATM = strike === atmStrike;
                    return `<option value="${strike}" ${isATM ? 'selected' : ''}>${strike}${isATM ? ' (ATM)' : ''}</option>`;
                }).join('');

                // Auto-analyze with ATM strike + default settings
                if (autoAnalyze && atmStrike) {
                    analyze().catch(e => console.warn('Auto-analyze failed:', e));
                }
                
            } catch (e) {
                select.innerHTML = '<option value="">Error</option>';
            }
        }
        
        // ===== CHART FUNCTIONS =====
        function initCharts() {
            const priceContainer = document.getElementById('price-chart');
            const volumeContainer = document.getElementById('volume-chart');
            
            priceChart = LightweightCharts.createChart(priceContainer, {
                layout: {
                    background: { color: '#131722' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: { color: '#758696', width: 1, style: 2 },
                    horzLine: { color: '#758696', width: 1, style: 2 },
                },
                rightPriceScale: { borderColor: '#2a2e39', minimumWidth: 80 },
                timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
            });
            
            candlestickSeries = priceChart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderUpColor: '#26a69a',
                borderDownColor: '#ef5350',
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });

            // ── Underlay toggle buttons ──
            document.querySelectorAll('.underlay-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.underlay-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    underlayMode = btn.dataset.underlay;
                    applyUnderlay();
                });
            });
            
            volumeChart = LightweightCharts.createChart(volumeContainer, {
                layout: {
                    background: { color: '#131722' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                rightPriceScale: { borderColor: '#2a2e39', minimumWidth: 80 },
                timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
            });
            
            volumeSeries = volumeChart.addHistogramSeries({
                priceFormat: { type: 'volume' },
                priceScaleId: '',
            });
            
            // Sync timescales using logical range (bar-index based) for pixel-perfect alignment.
            // Volume chart is padded with zero-volume bars to match any extra underlay timestamps.
            window._chartDataLoading = false;
            let _syncingChart = false;
            priceChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
                if (window._chartDataLoading || _syncingChart) return;
                if (range) {
                    _syncingChart = true;
                    try { volumeChart.timeScale().setVisibleLogicalRange(range); } catch(_) {}
                    _syncingChart = false;
                }
            });
            volumeChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
                if (window._chartDataLoading || _syncingChart) return;
                if (range) {
                    _syncingChart = true;
                    try { priceChart.timeScale().setVisibleLogicalRange(range); } catch(_) {}
                    _syncingChart = false;
                }
            });
            
            // Resize handler
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const { width, height } = entry.contentRect;
                    if (width === 0 || height === 0) continue;
                    if (entry.target === priceContainer) {
                        priceChart.applyOptions({ width, height });
                    } else if (entry.target === volumeContainer) {
                        volumeChart.applyOptions({ width, height });
                    }
                }
            });
            resizeObserver.observe(priceContainer);
            resizeObserver.observe(volumeContainer);
        }
        
        // ===== ANALYSIS =====
        async function analyze() {
            const expiration = document.getElementById('expiration').value;
            const strike = document.getElementById('strike').value;
            const right = document.getElementById('right').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!currentSymbol || !expiration || !strike) {
                alert('Please select expiration and strike');
                return;
            }
            
            const btn = document.getElementById('analyze-btn');
            
            // In live mode, don't disable button, just show visual feedback
            if (liveMode) {
                const chartsContainer = document.querySelector('.charts-container');
                chartsContainer.classList.add('live-refreshing');
            } else {
                btn.disabled = true;
                btn.textContent = 'Loading...';
            }
            
            try {
                let url = `/api/analyze?symbol=${currentSymbol}&expiration=${expiration}&strike=${strike}&right=${right}&interval=${currentInterval}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
                // mock param not needed – analysis always uses real API data
                
                const res = await authFetch(url);
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Analysis failed');
                }
                
                const data = await res.json();
                
                // Track last bar datetime so live mode can send delta requests
                if (data.bars && data.bars.length > 0) {
                    lastBarDatetime = data.bars[data.bars.length - 1].datetime;
                }
                
                // Update contract header
                document.getElementById('contract-symbol').textContent = `${currentSymbol} $${strike} ${right === 'C' ? 'Call' : 'Put'}`;
                document.getElementById('contract-details').textContent = `Exp: ${expiration}`;
                
                if (data.bars.length > 0) {
                    const lastBar = data.bars[data.bars.length - 1];
                    const firstBar = data.bars[0];
                    const change = lastBar.close - firstBar.open;
                    const changePct = (change / firstBar.open * 100);
                    
                    document.getElementById('contract-price').textContent = `$${lastBar.close.toFixed(2)}`;
                    document.getElementById('contract-change').textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%)`;
                    document.getElementById('contract-change').className = `contract-change ${change >= 0 ? 'positive' : 'negative'}`;
                }
                
                // In mock-live mode, only update analysis panels — chart is fed by WS SOW/bars
                if (!(liveMode && mockMode)) {
                    updateCharts(data);
                }
                updateAnalysis(data);
                
                // Update summary text after analyze
                updateSummaryText();
                if (isMobile() && !hasAnalyzed) {
                    hasAnalyzed = true;
                }
                // Auto-collapse controls on mobile after analyze
                if (isMobile()) {
                    collapseControls();
                    setActiveNav('nav-chart');
                }
                
            } catch (e) {
                document.getElementById('signals-container').innerHTML = `<div class="error-message">${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '▶ Analyze';
                if (liveMode) {
                    const chartsContainer = document.querySelector('.charts-container');
                    chartsContainer.classList.remove('live-refreshing');
                }
            }
        }
        
        function updateCharts(data) {
          try {
            const candleData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                open: bar.open,
                high: bar.high,
                low: bar.low,
                close: bar.close,
            }));
            
            const volumeData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                value: bar.volume,
                color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)',
            }));
            
            // Suppress timescale sync during bulk data load
            window._chartDataLoading = true;
            volumeSeries.setData(volumeData);
            candlestickSeries.setData(candleData);

            // ── Underlying underlay ──
            underlayBarsData = (data.underlying_bars || []).map(bar => ({
                time: toEasternUnix(bar.datetime),
                open: bar.open,
                high: bar.high,
                low: bar.low,
                close: bar.close,
            }));
            applyUnderlay();

            // Pad volume chart with zero-volume entries for any underlay timestamps
            // not in the options data so both charts share identical bar indices.
            padVolumeForUnderlay(volumeData);

            // Store for re-filtering and update markers
            lastAnalysisData = data;
            updateFilteredMarkers(data.signals || []);
            
            // Scroll to recent
            if (candleData.length > 0) {
                priceChart.timeScale().fitContent();
                volumeChart.timeScale().fitContent();
                try {
                    const barsToShow = Math.min(100, candleData.length);
                    const fromIndex = Math.max(0, candleData.length - barsToShow);
                    priceChart.timeScale().setVisibleRange({
                        from: candleData[fromIndex].time,
                        to: candleData[candleData.length - 1].time,
                    });
                } catch (_) { /* fitContent already handled it */ }
            } else {
                priceChart.timeScale().fitContent();
                volumeChart.timeScale().fitContent();
            }
            window._chartDataLoading = false;
          } catch(chartErr) { console.warn('Chart update warning:', chartErr.message); }
        }
        
        function updateChartsIncremental(data) {
          try {
            const candleData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                open: bar.open,
                high: bar.high,
                low: bar.low,
                close: bar.close,
            }));
            
            const volumeData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                value: bar.volume,
                color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)',
            }));
            
            // Build new set of timestamps
            const newTimestamps = new Set(candleData.map(d => d.time));
            
            // Suppress timescale sync during updates
            window._chartDataLoading = true;
            
            // Update bars (lightweight-charts update() handles both existing and new bars)
            for (let i = 0; i < candleData.length; i++) {
                candlestickSeries.update(candleData[i]);
                volumeSeries.update(volumeData[i]);
            }

            // Update underlying underlay in live mode
            if (data.underlying_bars && data.underlying_bars.length) {
                underlayBarsData = data.underlying_bars.map(bar => ({
                    time: toEasternUnix(bar.datetime),
                    open: bar.open, high: bar.high, low: bar.low, close: bar.close,
                }));
                applyUnderlay();
                padVolumeForUnderlay(volumeData);
            }
            
            window._chartDataLoading = false;
            
            // Update tracked timestamps
            currentBarTimestamps = newTimestamps;
            
            // Store for re-filtering and update markers
            lastAnalysisData = data;
            updateFilteredMarkers(data.signals || []);
            
          } catch(chartErr) { console.warn('Chart incremental update warning:', chartErr.message); }
        }

        // Pad volume chart with zero-volume bars for underlay timestamps
        // so logical-range sync stays pixel-perfect.
        function padVolumeForUnderlay(existingVolumeData) {
            if (!underlayBarsData.length || !volumeSeries) return;
            const existing = new Set(existingVolumeData.map(d => d.time));
            const padBars = underlayBarsData
                .filter(b => !existing.has(b.time))
                .map(b => ({ time: b.time, value: 0, color: 'rgba(0,0,0,0)' }));
            if (!padBars.length) return;
            // Merge and sort
            const merged = existingVolumeData.concat(padBars).sort((a, b) => a.time - b.time);
            volumeSeries.setData(merged);
        }

        // ===== UNDERLAY MANAGEMENT =====
        function removeUnderlay() {
            if (underlaySeries) {
                try { priceChart.removeSeries(underlaySeries); } catch(_) {}
                underlaySeries = null;
            }
        }

        function applyUnderlay() {
            removeUnderlay();
            if (underlayMode === 'off' || !underlayBarsData.length || !priceChart) return;

            if (underlayMode === 'line') {
                underlaySeries = priceChart.addLineSeries({
                    color: 'rgba(100, 130, 180, 0.25)',
                    lineWidth: 1,
                    lineStyle: 0,
                    priceScaleId: 'underlay',
                    lastValueVisible: false,
                    priceLineVisible: false,
                    crosshairMarkerVisible: false,
                });
                underlaySeries.setData(underlayBarsData.map(b => ({ time: b.time, value: b.close })));
            } else if (underlayMode === 'candle') {
                underlaySeries = priceChart.addCandlestickSeries({
                    upColor: 'rgba(38, 166, 154, 0.12)',
                    downColor: 'rgba(239, 83, 80, 0.12)',
                    borderUpColor: 'rgba(38, 166, 154, 0.20)',
                    borderDownColor: 'rgba(239, 83, 80, 0.20)',
                    wickUpColor: 'rgba(38, 166, 154, 0.15)',
                    wickDownColor: 'rgba(239, 83, 80, 0.15)',
                    priceScaleId: 'underlay',
                    lastValueVisible: false,
                    priceLineVisible: false,
                });
                underlaySeries.setData(underlayBarsData);
            }

            // Configure the underlay price scale (right side, hidden)
            priceChart.priceScale('underlay').applyOptions({
                scaleMargins: { top: 0.05, bottom: 0.05 },
                visible: false,
            });
        }

        function updateAnalysis(data) {
            // Bias - with null check
            const biasContainer = document.getElementById('bias-container');
            if (data.bias && data.bias.bias) {
                biasContainer.className = `bias-indicator ${data.bias.bias}`;
                biasContainer.innerHTML = `
                    <div class="bias-label">${data.bias.bias}</div>
                    <div class="bias-strength">Strength: ${Math.round((data.bias.strength || 0) * 100)}%</div>
                    <div class="bias-reason">${data.bias.reason || ''}</div>
                `;
            } else {
                biasContainer.className = 'bias-indicator neutral';
                biasContainer.innerHTML = `
                    <div class="bias-label">neutral</div>
                    <div class="bias-strength">Not enough data</div>
                `;
            }
            
            // Stats
            const signals = data.signals || [];
            const bullishSignals = signals.filter(s => BULLISH_SIGNALS.includes(s.signal));
            const bearishSignals = signals.filter(s => BEARISH_SIGNALS.includes(s.signal));
            
            document.getElementById('stat-bars').textContent = (data.bars || []).length;
            document.getElementById('stat-signals').textContent = signals.length;
            document.getElementById('stat-bullish').textContent = bullishSignals.length;
            document.getElementById('stat-bearish').textContent = bearishSignals.length;
            
            // Signals list
            const signalsContainer = document.getElementById('signals-container');
            if (signals.length === 0) {
                signalsContainer.innerHTML = '<div class="loading">No significant signals</div>';
                return;
            }
            
            const filteredSignals = filterSignals(signals);
            if (filteredSignals.length === 0) {
                signalsContainer.innerHTML = '<div class="loading">No signals match active filters</div>';
                // still update stats with unfiltered counts
            } else {
            const signalHtml = [...filteredSignals]
                .reverse()
                .slice(0, 30)
                .map(signal => {
                    const isBullish = BULLISH_SIGNALS.includes(signal.signal);
                    return `
                        <div class="signal-item ${isBullish ? 'bullish' : 'bearish'}">
                            <div class="signal-time">${toEasternString(signal.datetime)} ET</div>
                            <div class="signal-name">${signal.signal.replace(/_/g, ' ').toUpperCase()}</div>
                            <div class="signal-desc">${signal.description}</div>
                            <div class="signal-meta">
                                <span>$${signal.price.toFixed(2)}</span>
                                <span>Vol: ${signal.volume.toLocaleString()}</span>
                                <span>${signal.volume_ratio}x avg</span>
                            </div>
                        </div>
                    `;
                }).join('');
            signalsContainer.innerHTML = signalHtml;
            // Also update the full signals tab
            const fullContainer = document.getElementById('signals-container-full');
            if (fullContainer) fullContainer.innerHTML = signalHtml;
            }
            
            // Update signal peek
            updateSignalPeek(signals);
            
            // Composite signal
            if (data.composite) {
                updateComposite(data.composite);
            }
        }
        
        // ===== TOAST NOTIFICATIONS =====
        function showToast(html, cssClass, duration = 5000) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast ' + cssClass;
            el.innerHTML = html;
            el.onclick = () => { el.classList.add('fade-out'); setTimeout(() => el.remove(), 300); };
            container.appendChild(el);
            setTimeout(() => {
                if (el.parentNode) { el.classList.add('fade-out'); setTimeout(() => el.remove(), 300); }
            }, duration);
        }

        function showSignalToast(oldAction, newAction, comp) {
            const icons = { 'STRONG BUY': '🟢', 'BUY': '🟢', 'HOLD': '⚪', 'SELL': '🔴', 'STRONG SELL': '🔴' };
            const cls = newAction.includes('BUY') ? 'buy' : newAction.includes('SELL') ? 'sell' : 'hold';
            const icon = icons[newAction] || '⚪';
            const score = (comp.score >= 0 ? '+' : '') + comp.score.toFixed(3);
            const conf = Math.round(comp.confidence * 100) + '%';
            showToast(
                `<span class="toast-icon">${icon}</span>` +
                `<div class="toast-body">` +
                `<span class="toast-title">Signal Changed: ${oldAction} → ${newAction}</span>` +
                `<span class="toast-detail">Score ${score} · Conf ${conf} · ${comp.trade_archetype.replace(/_/g, ' ')}</span>` +
                `</div>`,
                cls, 6000
            );
        }

        function showVpaActionToast(oldAction, newAction, signal) {
            const icons = { 'BUY': '🟢', 'HOLD': '⚪', 'SELL': '🔴' };
            const cls = newAction === 'BUY' ? 'buy' : newAction === 'SELL' ? 'sell' : 'hold';
            const icon = icons[newAction] || '⚪';
            const conf = Math.round(signal.confidence * 100) + '%';
            const sigName = signal.signal.replace(/_/g, ' ').toUpperCase();
            showToast(
                `<span class="toast-icon">${icon}</span>` +
                `<div class="toast-body">` +
                `<span class="toast-title">VPA Signal: ${oldAction} → ${newAction}</span>` +
                `<span class="toast-detail">${sigName} · Conf ${conf} · $${signal.price.toFixed(2)}</span>` +
                `</div>`,
                cls, 6000
            );
        }

        function updateComposite(comp) {
            if (!comp) return;

            // Gauge – color based on ACTION (BUY=green, SELL=red) not underlying direction
            // This way buying a put still shows green because the action is BUY
            const actionClass = {
                'STRONG BUY': 'strong_buy', 'BUY': 'buy',
                'HOLD': 'neutral',
                'SELL': 'sell', 'STRONG SELL': 'strong_sell',
            }[comp.action] || 'neutral';
            const gauge = document.getElementById('composite-gauge');
            gauge.className = 'composite-signal-gauge ' + actionClass;
            document.getElementById('comp-action').textContent = comp.action;
            document.getElementById('comp-signal-sub').textContent = comp.signal.replace(/_/g, ' ');
            document.getElementById('comp-score').textContent = (comp.score >= 0 ? '+' : '') + comp.score.toFixed(3);
            document.getElementById('comp-conf').textContent = Math.round(comp.confidence * 100) + '%';

            // Archetype
            const archDiv = document.getElementById('comp-archetype');
            archDiv.innerHTML = `
                <span class="archetype-badge">${comp.trade_archetype.replace(/_/g, ' ')}</span>
                <div class="archetype-desc">${comp.archetype_description}</div>
            `;

            // Greeks
            const g = comp.greeks;
            setGreek('g-delta', g.delta, true);
            setGreek('g-gamma', g.gamma, false);
            setGreek('g-theta', g.theta, true);
            setGreek('g-vega', g.vega, false);
            document.getElementById('g-iv').textContent = (g.iv * 100).toFixed(1) + '%';
            document.getElementById('g-oi').textContent = g.open_interest.toLocaleString();

            // Chain metrics
            const cm = comp.chain_metrics;
            document.getElementById('cm-ivr').textContent = cm.iv_rank.toFixed(0) + '%';
            const gexEl = document.getElementById('cm-gex');
            gexEl.textContent = cm.gex_regime.charAt(0).toUpperCase() + cm.gex_regime.slice(1);
            gexEl.style.color = cm.gex_regime === 'positive' ? '#26a69a' : cm.gex_regime === 'negative' ? '#ef5350' : '#787b86';
            document.getElementById('cm-pcr').textContent = cm.put_call_oi_ratio.toFixed(2);
            document.getElementById('cm-maxpain').textContent = '$' + cm.max_pain.toFixed(0);
            document.getElementById('cm-calloi').textContent = formatCompact(cm.total_call_oi);
            document.getElementById('cm-putoi').textContent = formatCompact(cm.total_put_oi);

            // UOA
            const uoaDiv = document.getElementById('uoa-container');
            if (cm.uoa_detected && cm.uoa_details.length > 0) {
                uoaDiv.innerHTML = `
                    <div class="uoa-alert">
                        <div class="uoa-alert-header">⚡ Unusual Options Activity</div>
                        ${cm.uoa_details.slice(0, 5).map(u => `
                            <div class="uoa-strike">
                                <span>$${u.strike} ${u.type}</span>
                                <span>Vol: ${u.volume.toLocaleString()}</span>
                                <span class="uoa-ratio">${u.vol_oi_ratio}x V/OI</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                uoaDiv.innerHTML = '';
            }

            // Factor breakdown
            const factorList = document.getElementById('factor-list');
            factorList.innerHTML = comp.factors.map(f => {
                const cls = f.score > 0.05 ? 'positive' : f.score < -0.05 ? 'negative' : 'zero';
                const barPct = Math.abs(f.score) * 50; // 0-50% from center
                const barLeft = f.score >= 0 ? '50%' : (50 - barPct) + '%';
                return `
                    <div class="factor-item">
                        <div class="factor-header">
                            <span class="factor-name">${f.name}</span>
                            <span class="factor-score-badge ${cls}">${f.score >= 0 ? '+' : ''}${f.score.toFixed(2)}</span>
                        </div>
                        <div class="factor-bar-bg">
                            <div class="factor-bar-fill ${cls}" style="left:${barLeft};width:${barPct}%"></div>
                        </div>
                        <div class="factor-detail">${f.detail}</div>
                    </div>
                `;
            }).join('');

            // Recommendation
            document.getElementById('comp-recommendation').textContent = comp.recommendation;

            // Add BUY/SELL/HOLD marker on the last bar of the chart
            addCompositeMarker(comp);

            // Update mobile action banner
            if (isMobile()) {
                updateMobileActionBanner(comp);
            }
        }

        // Store the composite result globally so markers can be combined with VPA signals
        let lastCompositeResult = null;

        function addCompositeMarker(comp) {
            if (!candlestickSeries || !lastAnalysisData || !lastAnalysisData.bars.length) return;
            lastCompositeResult = comp;
            rebuildAllMarkers();
        }

        function rebuildAllMarkers() {
            if (!candlestickSeries) return;

            // Collect VPA signal markers (individual signal types)
            const vpaSignals = lastAnalysisData ? (lastAnalysisData.signals || []) : [];
            const filtered = filterSignals(vpaSignals);
            const markers = filtered.map(signal => {
                const isBullish = BULLISH_SIGNALS.includes(signal.signal);
                return {
                    time: toEasternUnix(signal.datetime),
                    position: isBullish ? 'belowBar' : 'aboveBar',
                    color: isBullish ? '#26a69a' : '#ef5350',
                    shape: isBullish ? 'arrowUp' : 'arrowDown',
                    text: signal.signal.replace('_', ' '),
                };
            });

            // Add deduplicated BUY/SELL/HOLD transition markers for entire chart history
            const actionMarkers = buildActionMarkers(vpaSignals);
            for (const am of actionMarkers) {
                markers.push(am);
            }

            // Check if the latest VPA-derived action changed → fire toast
            if (vpaSignals.length > 0) {
                const sortedAll = [...vpaSignals].sort((a, b) => {
                    return new Date(a.datetime.replace(' ', 'T') + 'Z') - new Date(b.datetime.replace(' ', 'T') + 'Z');
                });
                const latestAction = classifySignal(sortedAll[sortedAll.length - 1].signal);
                if (lastVpaAction !== null && latestAction !== lastVpaAction) {
                    showVpaActionToast(lastVpaAction, latestAction, sortedAll[sortedAll.length - 1]);
                }
                lastVpaAction = latestAction;
            }

            // Add composite BUY/SELL/HOLD marker on the last bar (from greeks engine)
            if (lastCompositeResult && lastAnalysisData && lastAnalysisData.bars.length > 0) {
                const comp = lastCompositeResult;
                const lastBar = lastAnalysisData.bars[lastAnalysisData.bars.length - 1];
                const action = comp.action;
                const isBuy = action.includes('BUY');
                const isSell = action.includes('SELL');

                if (isBuy || isSell) {
                    const confPct = Math.round(comp.confidence * 100);
                    markers.push({
                        time: toEasternUnix(lastBar.datetime),
                        position: isBuy ? 'belowBar' : 'aboveBar',
                        color: isBuy ? '#00e676' : '#ff1744',
                        shape: isBuy ? 'arrowUp' : 'arrowDown',
                        text: `${action} (${confPct}%)`,
                    });
                }
            }

            markers.sort((a, b) => a.time - b.time);
            candlestickSeries.setMarkers(markers);
        }

        function setGreek(id, value, showSign) {
            const el = document.getElementById(id);
            const formatted = showSign ? ((value >= 0 ? '+' : '') + value.toFixed(4)) : value.toFixed(4);
            el.textContent = formatted;
            el.className = 'greek-value ' + (value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral-val');
        }

        function formatCompact(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
        }
        
        // ===== EVENT LISTENERS =====
        document.getElementById('expiration').addEventListener('change', (e) => {
            if (currentSymbol && e.target.value) {
                loadStrikes(currentSymbol, e.target.value);
            }
            // Stop live mode when expiration changes
            stopLiveMode();
        });
        
        document.getElementById('strike').addEventListener('change', () => {
            // Stop live mode when strike changes
            stopLiveMode();
        });
        
        document.getElementById('analyze-btn').addEventListener('click', analyze);
        document.getElementById('summary-analyze-btn').addEventListener('click', analyze);
        
        // Live mode button
        document.getElementById('live-btn').addEventListener('click', toggleLiveMode);

        // Connection-limit modal dismiss
        document.getElementById('conn-limit-ok').addEventListener('click', () => {
            document.getElementById('conn-limit-modal').classList.remove('active');
        });
        document.getElementById('conn-limit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'conn-limit-modal') {
                e.target.classList.remove('active');
            }
        });
        
        // Mock mode toggle
        document.getElementById('mock-btn').addEventListener('click', () => {
            mockMode = !mockMode;
            const btn = document.getElementById('mock-btn');
            if (mockMode) {
                btn.style.background = '#facc15';
                btn.style.color = '#000';
                btn.textContent = 'MOCK ✓';
            } else {
                btn.style.background = '#2a2e39';
                btn.style.color = '#787b86';
                btn.textContent = 'MOCK';
            }
            // Re-send watchlist symbols with new mock state
            sendWatchlistSymbols();
            // If live mode is running, restart it with new mock state
            if (liveMode) {
                stopLiveMode();
                toggleLiveMode();
            }
        });
        
        // Controls chevron
        document.getElementById('controls-chevron').addEventListener('click', toggleControls);
        
        // Interval buttons - Handle both main and summary interval buttons
        document.querySelectorAll('.interval-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const newInterval = parseInt(btn.dataset.interval);
                if (newInterval === currentInterval) return;
                // Update all interval buttons (both main and summary)
                document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
                currentInterval = newInterval;
                // Set active on all buttons with same interval
                document.querySelectorAll(`.interval-btn[data-interval="${currentInterval}"]`).forEach(b => b.classList.add('active'));

                // If live mock mode is active, restart with new interval
                if (liveMode && mockMode) {
                    console.log(`[Interval] Changed to ${currentInterval}m while mock-live active — restarting`);
                    stopLiveMode();
                    setTimeout(() => toggleLiveMode(), 300);
                }
            });
        });

        // ===== DATE RANGE BUTTONS (auto-analyze on change) =====
        document.querySelectorAll('.date-range-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Sync all date-range-btn across mobile and desktop
                document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
                // Activate all buttons with the same range value
                const rangeVal = btn.dataset.range;
                document.querySelectorAll(`.date-range-btn[data-range="${rangeVal}"]`).forEach(b => b.classList.add('active'));
                const days = parseInt(rangeVal);
                const today = new Date();
                const from = new Date(today);
                from.setDate(today.getDate() - days);
                document.getElementById('start-date').value = from.toISOString().split('T')[0];
                document.getElementById('end-date').value = today.toISOString().split('T')[0];
                // Auto-analyze with new date range if a symbol is selected
                if (currentSymbol && document.getElementById('expiration').value && document.getElementById('strike').value) {
                    analyze().catch(e => console.warn('Auto-analyze on date range change failed:', e));
                }
            });
        });

        // ===== CALL/PUT SWITCH (syncs desktop + mobile + hidden select) =====
        function syncCallPut(value) {
            document.getElementById('right').value = value;
            if (value === 'C') {
                document.getElementById('cp-call').className = 'cp-toggle-option call-active';
                document.getElementById('cp-put').className = 'cp-toggle-option';
                document.getElementById('dcp-call').className = 'cp-opt call-active';
                document.getElementById('dcp-put').className = 'cp-opt';
            } else {
                document.getElementById('cp-put').className = 'cp-toggle-option put-active';
                document.getElementById('cp-call').className = 'cp-toggle-option';
                document.getElementById('dcp-put').className = 'cp-opt put-active';
                document.getElementById('dcp-call').className = 'cp-opt';
            }
            stopLiveMode();
        }
        // Mobile
        document.getElementById('cp-call').addEventListener('click', () => syncCallPut('C'));
        document.getElementById('cp-put').addEventListener('click', () => syncCallPut('P'));
        // Desktop
        document.getElementById('dcp-call').addEventListener('click', () => syncCallPut('C'));
        document.getElementById('dcp-put').addEventListener('click', () => syncCallPut('P'));
        // Hidden select change (fallback)
        document.getElementById('right').addEventListener('change', (e) => syncCallPut(e.target.value));

        // ===== SUMMARY LIVE BUTTON =====
        document.getElementById('summary-live-btn').addEventListener('click', toggleLiveMode);
        
        // Signal peek click handler
        document.getElementById('signal-peek').addEventListener('click', () => {
            if (isMobile()) {
                openAnalysis();
            }
        });
        
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                // Switch tab content
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                const target = document.getElementById('tab-' + tabName);
                if (target) target.classList.add('active');
            });
        });
        
        document.getElementById('watchlist-search').addEventListener('input', renderWatchlist);

        // ===== MOBILE EVENT LISTENERS =====
        // Mobile toggle buttons (old, kept for landscape)
        document.getElementById('mobile-menu-toggle').addEventListener('click', toggleWatchlist);
        document.getElementById('mobile-analysis-toggle').addEventListener('click', toggleAnalysis);

        // Mobile close buttons
        document.getElementById('watchlist-close-btn').addEventListener('click', closeWatchlist);
        document.getElementById('analysis-close-btn').addEventListener('click', closeAnalysis);

        // Backdrop click to close
        document.getElementById('backdrop').addEventListener('click', closeAllMobilePanels);

        // Window resize handler
        window.addEventListener('resize', handleResize);

        // ===== MOBILE BOTTOM NAV =====
        document.getElementById('nav-watchlist').addEventListener('click', () => {
            const sidebar = document.getElementById('watchlist-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeWatchlist();
            } else {
                closeAnalysis();
                openWatchlist();
            }
        });

        document.getElementById('nav-chart').addEventListener('click', () => {
            closeAllMobilePanels();
            setActiveNav('nav-chart');
            // Collapse controls to maximize chart view
            collapseControls();
        });

        document.getElementById('nav-settings').addEventListener('click', () => {
            if (!controlsCollapsed) {
                // Settings already open — close it and go back to chart
                closeAllMobilePanels();
                setActiveNav('nav-chart');
                collapseControls();
            } else {
                closeAllMobilePanels();
                setActiveNav('nav-settings');
                // Expand controls for editing
                expandControls();
            }
        });

        document.getElementById('nav-analysis').addEventListener('click', () => {
            const sidebar = document.getElementById('analysis-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeAnalysis();
            } else {
                closeWatchlist();
                openAnalysis();
            }
        });

        // Mobile action banner tap opens analysis
        document.getElementById('mobile-action-banner').addEventListener('click', () => {
            openAnalysis();
        });
        
        // ===== INITIALIZATION =====
        async function init() {
            // Set default dates (1 day on both mobile and desktop)
            const today = new Date();
            const startFrom = new Date(today);
            startFrom.setDate(today.getDate() - 1); // 1D default
            
            document.getElementById('start-date').value = startFrom.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            
            // Init charts
            initCharts();
            
            // Initialize mobile controls visibility and state
            if (isMobile()) {
                const controlsSummary = document.getElementById('controls-summary');
                // Show controls-summary immediately on mobile
                if (controlsSummary) {
                    controlsSummary.classList.add('active');
                    // Start with controls collapsed on mobile to maximize chart space
                    collapseControls();
                }
            }
            
            // Load watchlist prices via REST first (needed for ATM calculation)
            await loadWatchlistPrices();
            
            // Select default symbol (will now have price data for ATM)
            selectSymbol('SPY');
            
            // Start watchlist WebSocket for 1/sec price streaming
            connectWatchlistWs();
        }
        
        init();
    </script>
</body>
</html>
