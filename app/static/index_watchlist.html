<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionsGanster - AI Options Signals</title>
    <meta name="description" content="AI-driven options signals. One actionable BUY, SELL, or HOLD verdict with a confidence score. Free to use.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://optionsganster.com">
    <meta property="og:title" content="OptionsGanster – AI-Powered Options Signals">
    <meta property="og:description" content="Stop guessing. Our AI analyzes multiple market dimensions in real time and delivers one clear verdict with a confidence score. Free.">
    <meta property="og:image" content="https://optionsganster.com/static/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="OptionsGanster – AI-Powered Options Signals">
    <meta name="twitter:description" content="Stop guessing. Our AI analyzes multiple market dimensions in real time and delivers one clear verdict with a confidence score.">
    <meta name="twitter:image" content="https://optionsganster.com/static/og-image.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32.png">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon-180.png">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100vh;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            display: flex;
            flex-direction: column;
        }
        
        /* ===== WATCHLIST SIDEBAR (LEFT) ===== */
        .watchlist-sidebar {
            width: 260px;
            background: #1e222d;
            border-right: 1px solid #2a2e39;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        min-width 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .watchlist-sidebar.collapsed {
            width: 0px;
            min-width: 0px;
            border-right: none;
        }

        .watchlist-sidebar.collapsed .watchlist-header,
        .watchlist-sidebar.collapsed .watchlist-search,
        .watchlist-sidebar.collapsed .watchlist-items,
        .watchlist-sidebar.collapsed .watchlist-tabs,
        .watchlist-sidebar.collapsed .ideas-panel {
            opacity: 0;
            pointer-events: none;
        }

        /* Watchlist sidebar tabs */
        .watchlist-tabs {
            display: flex;
            border-bottom: 1px solid #2a2e39;
            flex-shrink: 0;
        }
        .watchlist-tab {
            flex: 1;
            padding: 10px 8px;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .watchlist-tab:hover { color: #d1d4dc; }
        .watchlist-tab.active { color: #2962ff; border-bottom-color: #2962ff; }

        /* Ideas panel */
        .ideas-panel {
            flex: 1;
            overflow-y: auto;
            display: none;
        }
        .ideas-panel-title { display: none; } /* hidden on desktop */
        .ideas-panel.active { display: flex; flex-direction: column; }
        .ideas-list { display: flex; flex-direction: column; }
        .ideas-loading, .ideas-empty {
            color: #787b86;
            font-size: 12px;
            text-align: center;
            padding: 24px 12px;
        }
        .idea-item {
            padding: 10px 14px;
            margin: 6px 8px;
            background: #1a1e2a;
            border: 1px solid #2a2e39;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .idea-item:hover {
            background: #252936;
            border-color: #3a3e49;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        }
        .idea-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }
        .idea-ticker {
            font-size: 13px;
            font-weight: 600;
            color: #d1d4dc;
        }
        .idea-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
        }
        .idea-badge.call { background: #0f3d2e; color: #26a69a; }
        .idea-badge.put { background: #3d1f1f; color: #ef5350; }
        .idea-detail {
            font-size: 11px;
            color: #787b86;
            margin-top: 4px;
        }
        .idea-signal {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            font-size: 11px;
        }
        .idea-signal-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }
        .idea-signal-dot.buy { background: #26a69a; }
        .idea-signal-dot.sell { background: #ef5350; }

        /* Strong idea glow + pulse */
        .idea-item.strong-idea {
            border-left: 3px solid #26a69a;
            background: rgba(38, 166, 154, 0.06);
            animation: strongPulse 2s ease-in-out 1;
        }
        .idea-item.strong-idea.strong-sell {
            border-left-color: #ef5350;
            background: rgba(239, 83, 80, 0.06);
        }
        @keyframes strongPulse {
            0%   { background: rgba(38, 166, 154, 0.20); }
            100% { background: rgba(38, 166, 154, 0.06); }
        }
        .idea-item.strong-sell {
            animation-name: strongPulseSell;
        }
        @keyframes strongPulseSell {
            0%   { background: rgba(239, 83, 80, 0.20); }
            100% { background: rgba(239, 83, 80, 0.06); }
        }
        .idea-strong-badge {
            font-size: 9px;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: badgeBlink 1.5s ease-in-out 3;
        }
        .idea-strong-badge.buy { background: #26a69a; color: #fff; }
        .idea-strong-badge.sell { background: #ef5350; color: #fff; }
        @keyframes badgeBlink {
            0%, 100% { opacity: 1; }
            50%      { opacity: 0.4; }
        }

        /* Toast notification */
        .ideas-toast {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .ideas-toast-item {
            background: #1e222d;
            border: 1px solid #26a69a;
            border-radius: 8px;
            padding: 12px 18px;
            color: #d1d4dc;
            font-size: 13px;
            box-shadow: 0 4px 20px rgba(38, 166, 154, 0.25);
            pointer-events: auto;
            cursor: pointer;
            opacity: 0;
            transform: translateX(100px);
            animation: toastIn 0.4s ease-out forwards, toastOut 0.4s ease-in 4.6s forwards;
        }
        .ideas-toast-item.sell-toast {
            border-color: #ef5350;
            box-shadow: 0 4px 20px rgba(239, 83, 80, 0.25);
        }
        .ideas-toast-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 2px;
        }
        .ideas-toast-title.buy { color: #26a69a; }
        .ideas-toast-title.sell { color: #ef5350; }
        @keyframes toastIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toastOut {
            to { opacity: 0; transform: translateX(100px); }
        }
        .idea-signal-dot.hold { background: #787b86; }

        /* Submit Idea button in header — golden/amber */
        .submit-idea-btn {
            display: none;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #d4a017, #b8860b);
            color: #1a1200;
            border: none;
            padding: 6px 14px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 8px rgba(212, 160, 23, 0.25);
        }
        .submit-idea-btn:hover {
            background: linear-gradient(135deg, #e6b422, #c99700);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(212, 160, 23, 0.40);
        }
        .submit-idea-btn.visible { display: flex; }

        /* Idea submit modal */
        .idea-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 15000;
            background: rgba(0,0,0,0.65);
            backdrop-filter: blur(6px);
            align-items: center;
            justify-content: center;
        }
        .idea-modal-overlay.open { display: flex; }
        .idea-modal {
            background: #1e222d;
            border: 1px solid #2a2e39;
            border-radius: 12px;
            padding: 28px 24px;
            width: 380px;
            max-width: 90vw;
            box-shadow: 0 24px 64px rgba(0,0,0,.5);
        }
        .idea-modal h3 {
            font-size: 16px;
            font-weight: 700;
            color: #d1d4dc;
            margin-bottom: 16px;
        }
        .idea-modal .idea-form-info {
            background: #131722;
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 14px;
            font-size: 12px;
            color: #787b86;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        .idea-modal .idea-form-info .val {
            color: #d1d4dc;
            font-weight: 600;
        }
        .idea-modal .idea-action-group {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }
        .idea-modal .idea-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #2a2e39;
            background: transparent;
            color: #787b86;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }
        .idea-modal .idea-action-btn.buy-action:hover,
        .idea-modal .idea-action-btn.buy-action.selected {
            border-color: #26a69a;
            background: rgba(38, 166, 154, 0.1);
            color: #26a69a;
        }
        .idea-modal .idea-action-btn.sell-action:hover,
        .idea-modal .idea-action-btn.sell-action.selected {
            border-color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
            color: #ef5350;
        }
        .idea-modal textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #2a2e39;
            background: #131722;
            color: #d1d4dc;
            font-size: 12px;
            font-family: inherit;
            resize: vertical;
            min-height: 50px;
            margin-bottom: 14px;
            outline: none;
        }
        .idea-modal textarea:focus { border-color: #2962ff; }
        .idea-modal .idea-submit-final {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: none;
            background: #2962ff;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.15s;
        }
        .idea-modal .idea-submit-final:hover { background: #1e88e5; }
        .idea-modal .idea-submit-final:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .idea-modal-close {
            position: absolute;
            top: 10px;
            right: 14px;
            background: none;
            border: none;
            color: #787b86;
            font-size: 20px;
            cursor: pointer;
        }
        .idea-modal-close:hover { color: #d1d4dc; }

        /* Idea card: poster + time */
        .idea-meta {
            font-size: 10px;
            color: #5d606b;
            margin-top: 3px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .idea-meta .idea-poster {
            font-weight: 600;
            color: #787b86;
        }

        /* Idea price badge in header — golden highlight */
        .idea-price-badge {
            display: none;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            background: rgba(212, 160, 23, 0.15);
            border: 1px solid rgba(212, 160, 23, 0.40);
            border-radius: 4px;
            font-size: 12px;
            color: #e6b422;
            font-weight: 600;
            white-space: nowrap;
        }
        .idea-price-badge.visible { display: flex; }
        .idea-price-badge .idea-price-label {
            font-size: 10px;
            color: #b8960b;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* Sidebar toggle button — overlaps sidebar edge */
        .sidebar-toggle-btn {
            width: 20px;
            height: 48px;
            background: #3d3520;
            border: 1px solid #6b5c2e;
            border-left: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 260px;
            top: 50%;
            transform: translateY(-50%);
            flex-shrink: 0;
            z-index: 20;
            color: #e2c56b;
            font-size: 11px;
            padding: 0;
            transition: background 0.15s, color 0.15s, left 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-toggle-btn:hover {
            background: #4d4528;
            color: #f5d97e;
        }

        .sidebar-toggle-btn .toggle-arrow {
            transition: transform 0.25s;
        }

        .sidebar-toggle-btn.collapsed .toggle-arrow {
            transform: rotate(180deg);
        }

        .sidebar-toggle-btn.collapsed {
            left: 0px;
        }
        
        .watchlist-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .watchlist-header h2 {
            font-size: 13px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .watchlist-add-btn {
            background: transparent;
            border: none;
            color: #2962ff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .watchlist-add-btn:hover {
            background: rgba(41, 98, 255, 0.1);
        }
        
        .watchlist-header .sheet-done-btn {
            display: none;
        }
        
        .watchlist-search {
            padding: 8px 12px;
            border-bottom: 1px solid #2a2e39;
        }
        
        .watchlist-search input {
            width: 100%;
            background: #131722;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 8px 12px;
            color: #d1d4dc;
            font-size: 13px;
        }
        
        .watchlist-search input:focus {
            outline: none;
            border-color: #2962ff;
        }
        
        .watchlist-search input::placeholder {
            color: #787b86;
        }
        
        .watchlist-items {
            flex: 1;
            overflow-y: auto;
        }
        
        .watchlist-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #2a2e39;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .watchlist-item:hover {
            background: #2a2e39;
        }
        
        .watchlist-item.selected {
            background: #2962ff20;
            border-left: 3px solid #2962ff;
        }
        
        .watchlist-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .watchlist-symbol {
            font-size: 14px;
            font-weight: 600;
            color: #d1d4dc;
        }
        
        .watchlist-name {
            font-size: 11px;
            color: #787b86;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .watchlist-price-info {
            text-align: right;
        }
        
        .watchlist-price {
            font-size: 14px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .watchlist-change {
            font-size: 11px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .watchlist-change.positive {
            color: #26a69a;
        }
        
        .watchlist-change.negative {
            color: #ef5350;
        }
        
        .price-flash {
            animation: flash 0.3s ease-out;
        }
        
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .price-up {
            color: #26a69a !important;
        }
        
        .price-down {
            color: #ef5350 !important;
        }
        
        /* ===== MAIN LAYOUT ===== */
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            height: 100vh;
            position: relative;
        }
        
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;
            overflow: hidden;
        }
        
        /* ===== HEADER ===== */
        .header {
            background: #1e222d;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-logo h1 {
            font-size: 18px;
            font-weight: 700;
            color: #2962ff;
        }
        
        .header-logo h1 span {
            color: #ef5350;
        }
        
        .header-contract {
            display: flex;
            align-items: baseline;
            gap: 10px;
            padding: 6px 12px;
            background: #131722;
            border-radius: 6px;
        }
        
        .contract-symbol {
            font-size: 16px;
            font-weight: 700;
            color: #d1d4dc;
        }
        
        .contract-details {
            font-size: 12px;
            color: #787b86;
        }
        
        .contract-price {
            font-size: 16px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .contract-change {
            font-size: 12px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        /* Mobile LIVE badge — hidden on desktop */
        .mobile-live-badge {
            display: none;
        }
        
        .contract-change.positive { color: #26a69a; }
        .contract-change.negative { color: #ef5350; }
        
        .logout-btn {
            margin-left: auto;
            color: #787b86;
            text-decoration: none;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 4px;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .logout-btn:hover {
            color: #ef5350;
            background: rgba(239, 83, 80, 0.1);
        }

        /* ===== FAIR VALUE CARD ===== */
        .fv-verdict-badge {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 6px;
            letter-spacing: 0.5px;
        }
        .fv-verdict-badge.cheap {
            background: rgba(38, 166, 154, 0.2);
            color: #26a69a;
        }
        .fv-verdict-badge.expensive {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }
        .fv-verdict-badge.fair {
            background: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }
        .fv-verdict-badge.nomarket {
            background: rgba(139, 148, 158, 0.15);
            color: #8b949e;
        }
        .fv-card-body {
            margin-top: 6px;
        }
        .fv-card-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        .fv-main-row .fv-card-col {
            flex: 1;
            background: #0d1117;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .fv-vol-row .fv-card-col {
            flex: 1;
            background: #0d1117;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        .fv-card-label {
            font-size: 10px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.3px;
        }
        .fv-card-value {
            font-size: 13px;
            font-weight: 600;
            color: #d1d4dc;
        }
        .fv-card-value.positive { color: #26a69a; }
        .fv-card-value.negative { color: #ef5350; }
        .fv-card-details {
            font-size: 11px;
            color: #8b949e;
            padding: 6px 0 2px;
            line-height: 1.5;
        }
        .fv-card-extra {
            border-top: 1px solid #2a2e39;
            padding-top: 8px;
            margin-top: 4px;
        }
        .fv-card-extra .fv-card-col {
            flex: 1;
            background: #0d1117;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        .fv-toggle-btn {
            display: block;
            width: 100%;
            background: none;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            color: #787b86;
            font-size: 10px;
            padding: 4px 0;
            cursor: pointer;
            margin-top: 6px;
            text-align: center;
        }
        .fv-toggle-btn:hover {
            color: #d1d4dc;
            border-color: #363a45;
        }

        /* ===== CONTROLS BAR ===== */
        /* Hide old dropdowns replaced by toggle buttons */
        #type-group, #from-group, #to-group {
            display: none;
        }

        .controls-bar {
            background: #1e222d;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .control-group label {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
        }
        
        .control-group select,
        .control-group input {
            background: #131722;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 6px 10px;
            color: #d1d4dc;
            font-size: 13px;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #2962ff;
        }
        
        .interval-buttons {
            display: flex;
            gap: 2px;
            background: #131722;
            padding: 2px;
            border-radius: 4px;
        }
        
        .interval-btn {
            background: transparent;
            border: none;
            color: #787b86;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.15s;
        }
        
        .interval-btn:hover {
            color: #d1d4dc;
        }
        
        .interval-btn.active {
            background: #2962ff;
            color: white;
        }
        
        .analyze-btn {
            display: none;
            background: #2962ff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .analyze-btn:hover {
            background: #1e53e4;
        }
        
        .analyze-btn:disabled {
            background: #363a45;
            cursor: not-allowed;
        }
        
        /* ===== LIVE BUTTON ===== */
        .live-btn {
            background: #363a45;
            color: #787b86;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        
        .live-btn:hover {
            background: #4a4e59;
            color: #d1d4dc;
        }
        
        .live-btn.active {
            background: #ef5350;
            color: white;
            animation: live-pulse 2s ease-in-out infinite;
        }
        
        @keyframes live-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 83, 80, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(239, 83, 80, 0);
            }
        }
        
        /* ===== CONTROLS SUMMARY (Mobile only) ===== */
        .controls-summary {
            display: none;
            background: #131722;
            padding: 6px 12px;
            border-bottom: 1px solid #2a2e39;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
            height: 40px;
            overflow: hidden;
        }
        
        .summary-text {
            font-size: 12px;
            color: #d1d4dc;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }
        
        .summary-intervals {
            display: none;
        }
        
        .summary-interval-btn {
            padding: 4px 8px;
            font-size: 10px;
        }
        
        .summary-analyze-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 700;
            min-width: 0;
            background: #2962ff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .summary-analyze-btn:active {
            background: #1e4fd6;
        }
        
        .summary-live-btn {
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            background: #2a2e39;
            color: #787b86;
            border: 1px solid #363a45;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .summary-live-btn.active {
            background: rgba(239, 83, 80, 0.15);
            color: #ef5350;
            border-color: #ef5350;
        }
        
        .controls-chevron {
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        
        .controls-chevron:hover {
            background: rgba(120, 123, 134, 0.1);
            color: #d1d4dc;
        }
        
        .controls-bar.collapsed {
            display: none;
        }
        
        /* ===== SIGNAL PEEK (Mobile only) ===== */
        .signal-peek {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to right, rgba(38, 166, 154, 0.15), #1e222d);
            border-top: 3px solid #26a69a;
            padding: 12px 16px;
            z-index: 998;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            cursor: pointer;
            min-height: 68px;
        }
        
        .signal-peek.visible {
            transform: translateY(0);
        }
        
        .signal-peek.bearish {
            border-top-color: #ef5350;
            background: linear-gradient(to right, rgba(239, 83, 80, 0.15), #1e222d);
        }
        
        .signal-peek-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .signal-peek-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        
        .signal-peek-name {
            font-size: 14px;
            font-weight: 700;
            color: #d1d4dc;
            flex: 1;
        }
        
        .signal-peek-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .signal-peek-badge.bullish {
            background: rgba(38, 166, 154, 0.2);
            color: #26a69a;
        }
        
        .signal-peek-badge.bearish {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }
        
        .signal-peek-details {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        
        .signal-peek-description {
            font-size: 11px;
            color: #9ca3af;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .signal-peek-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .signal-peek-confidence {
            color: #2962ff;
            font-weight: 600;
        }
        
        .signal-peek-time {
            font-size: 10px;
            color: #787b86;
        }
        
        .signal-peek-price {
            font-size: 13px;
            font-weight: 600;
            color: #2962ff;
        }
        
        .live-refreshing {
            position: relative;
        }
        
        .live-refreshing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #2962ff, transparent);
            animation: live-refresh-slide 1.5s ease-in-out infinite;
        }
        
        @keyframes live-refresh-slide {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }
        
        /* ===== CHART AREA ===== */
        .chart-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }
        
        .charts-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #131722;
            min-height: 0;
            min-width: 0;
        }
        
        #price-chart {
            flex: 3;
            min-height: 0;
        }
        
        #stock-chart {
            flex: 1;
            border-top: 1px solid #2a2e39;
            min-height: 0;
        }

        #volume-chart {
            flex: 1;
            border-top: 1px solid #2a2e39;
            min-height: 0;
        }
        
        .chart-legend {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(30, 34, 45, 0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
        }
        
        .chart-legend .ohlc {
            display: flex;
            gap: 16px;
        }
        
        .chart-legend .ohlc span {
            color: #787b86;
        }
        
        .chart-legend .ohlc span strong {
            color: #d1d4dc;
            font-weight: 600;
        }
        
        /* ===== ANALYSIS SIDEBAR (RIGHT) ===== */
        .analysis-sidebar {
            width: 320px;
            background: #1e222d;
            border-left: 1px solid #2a2e39;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            min-height: 0;
            overflow: hidden;
        }
        
        .analysis-sheet-header {
            display: none;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #2a2e39;
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }
        
        .sidebar-tab:hover {
            color: #d1d4dc;
        }
        
        .sidebar-tab.active {
            color: #2962ff;
            border-bottom-color: #2962ff;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        /* Bias Indicator */
        .bias-card {
            background: #131722;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .bias-card h4 {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .bias-indicator {
            text-align: center;
            padding: 16px;
            border-radius: 6px;
        }
        
        .bias-indicator.bullish {
            background: rgba(38, 166, 154, 0.1);
            border: 1px solid #26a69a;
        }
        
        .bias-indicator.bearish {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid #ef5350;
        }
        
        .bias-indicator.neutral {
            background: rgba(120, 123, 134, 0.1);
            border: 1px solid #787b86;
        }
        
        .bias-label {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .bias-indicator.bullish .bias-label { color: #26a69a; }
        .bias-indicator.bearish .bias-label { color: #ef5350; }
        .bias-indicator.neutral .bias-label { color: #787b86; }
        
        .bias-strength {
            font-size: 13px;
            color: #787b86;
            margin-top: 8px;
        }
        
        .bias-reason {
            font-size: 12px;
            color: #5d606b;
            margin-top: 4px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            background: #131722;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #d1d4dc;
        }
        
        .stat-label {
            font-size: 11px;
            color: #787b86;
            margin-top: 4px;
        }
        
        /* Signals List */
        .signals-header {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .signal-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .signal-item {
            background: #131722;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid;
        }
        
        .signal-item.bullish { border-color: #26a69a; }
        .signal-item.bearish { border-color: #ef5350; }
        
        .signal-time {
            font-size: 11px;
            color: #5d606b;
        }
        
        .signal-name {
            font-size: 13px;
            font-weight: 600;
            color: #d1d4dc;
            margin: 4px 0;
        }
        
        .signal-desc {
            font-size: 12px;
            color: #787b86;
        }
        
        .signal-meta {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            font-size: 11px;
            color: #5d606b;
        }
        
        /* Loading & Error States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #787b86;
        }
        
        .error-message {
            background: rgba(239, 83, 80, 0.1);
            border: 1px solid #ef5350;
            color: #ef5350;
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
        }

        /* ===== COMPOSITE SIGNAL PANEL ===== */
        .composite-card {
            background: #131722;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .composite-card h4 {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .composite-signal-gauge {
            text-align: center;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .composite-signal-gauge.strong_buy,
        .composite-signal-gauge.buy { background: rgba(38,166,154,0.12); border: 1px solid #26a69a; }
        .composite-signal-gauge.lean_bullish { background: rgba(38,166,154,0.06); border: 1px solid rgba(38,166,154,0.4); }
        .composite-signal-gauge.neutral { background: rgba(120,123,134,0.08); border: 1px solid #787b86; }
        .composite-signal-gauge.lean_bearish { background: rgba(239,83,80,0.06); border: 1px solid rgba(239,83,80,0.4); }
        .composite-signal-gauge.sell,
        .composite-signal-gauge.strong_sell { background: rgba(239,83,80,0.12); border: 1px solid #ef5350; }

        .composite-action-label {
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .composite-signal-gauge.strong_buy .composite-action-label,
        .composite-signal-gauge.buy .composite-action-label,
        .composite-signal-gauge.lean_bullish .composite-action-label { color: #26a69a; }
        .composite-signal-gauge.neutral .composite-action-label { color: #787b86; }
        .composite-signal-gauge.lean_bearish .composite-action-label,
        .composite-signal-gauge.sell .composite-action-label,
        .composite-signal-gauge.strong_sell .composite-action-label { color: #ef5350; }

        .composite-signal-sub {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .composite-meta {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 6px;
            font-size: 12px;
            color: #787b86;
        }

        .composite-meta span strong {
            color: #d1d4dc;
        }

        .archetype-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(41,98,255,0.15);
            color: #5b8af5;
            margin-top: 8px;
        }

        .archetype-desc {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 6px;
            line-height: 1.5;
        }

        .recommendation-box {
            background: #0d1117;
            border: 1px solid #2a2e39;
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            color: #b0b3bc;
            line-height: 1.6;
            margin-top: 8px;
        }

        /* Greeks grid */
        .greeks-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 4px;
        }

        .greek-item {
            background: #0d1117;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .greek-value {
            font-size: 18px;
            font-weight: 700;
            font-family: 'SF Mono','Monaco',monospace;
        }

        .greek-value.positive { color: #26a69a; }
        .greek-value.negative { color: #ef5350; }
        .greek-value.neutral-val { color: #d1d4dc; }

        .greek-label {
            font-size: 10px;
            color: #787b86;
            text-transform: uppercase;
            margin-top: 2px;
            letter-spacing: 0.5px;
        }

        /* Factor bars */
        .factor-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .factor-item {
            background: #0d1117;
            padding: 10px 12px;
            border-radius: 6px;
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .factor-name {
            font-size: 12px;
            font-weight: 600;
            color: #d1d4dc;
        }

        .factor-score-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SF Mono','Monaco',monospace;
        }

        .factor-score-badge.positive { background: rgba(38,166,154,0.15); color: #26a69a; }
        .factor-score-badge.negative { background: rgba(239,83,80,0.15); color: #ef5350; }
        .factor-score-badge.zero { background: rgba(120,123,134,0.15); color: #787b86; }

        .factor-bar-bg {
            height: 4px;
            background: #1e222d;
            border-radius: 2px;
            position: relative;
            margin: 6px 0 4px;
        }

        .factor-bar-fill {
            position: absolute;
            top: 0;
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .factor-bar-fill.positive { background: #26a69a; }
        .factor-bar-fill.negative { background: #ef5350; }

        .factor-detail {
            font-size: 11px;
            color: #787b86;
            line-height: 1.4;
        }

        /* Chain metrics mini-grid */
        .chain-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .chain-item {
            background: #0d1117;
            padding: 8px 6px;
            border-radius: 6px;
            text-align: center;
        }

        .chain-value {
            font-size: 14px;
            font-weight: 700;
            color: #d1d4dc;
            font-family: 'SF Mono','Monaco',monospace;
        }

        .chain-label {
            font-size: 9px;
            color: #787b86;
            text-transform: uppercase;
            margin-top: 2px;
            letter-spacing: 0.3px;
        }

        .uoa-alert {
            background: rgba(255, 193, 7, 0.08);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            padding: 10px 12px;
            margin-top: 8px;
        }

        .uoa-alert-header {
            font-size: 12px;
            font-weight: 700;
            color: #ffc107;
            margin-bottom: 6px;
        }

        .uoa-strike {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #b0b3bc;
            padding: 2px 0;
        }

        .uoa-strike .uoa-ratio {
            font-weight: 600;
            color: #ffc107;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ===== SIGNAL FILTER TOGGLES ===== */
        .filter-bar {
            background: #1e222d;
            padding: 6px 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #2a2e39;
        }

        .filter-bar .filter-label {
            font-size: 11px;
            color: #787b86;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-right: 2px;
        }

        /* ── Confidence Toggle Group ── */
        .conf-toggle-group {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-left: 10px;
            border-left: 1px solid #2a2e39;
            margin-left: 2px;
        }
        .conf-toggle-group .conf-label {
            font-size: 10px;
            color: #787b86;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .conf-btn-group {
            display: flex;
            gap: 1px;
            background: #131722;
            padding: 2px;
            border-radius: 4px;
        }
        .conf-btn {
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 600;
            line-height: 1;
        }
        .conf-btn:hover {
            color: #d1d4dc;
        }
        .conf-btn.active {
            background: #2962ff;
            color: #fff;
        }

        /* ── Stock Underlay Toggle (compact, inline in filter bar) ── */
        .underlay-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-right: 10px;
            border-right: 1px solid #2a2e39;
            margin-right: 2px;
        }
        .underlay-toggle .underlay-label {
            font-size: 10px;
            color: #787b86;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .underlay-btn-group {
            display: flex;
            gap: 1px;
            background: #131722;
            padding: 2px;
            border-radius: 4px;
        }
        .underlay-btn {
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 10px;
            padding: 3px 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 600;
            line-height: 1;
        }
        .underlay-btn:hover {
            color: #d1d4dc;
        }
        .underlay-btn.active {
            background: #2962ff;
            color: #fff;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .toggle-group .toggle-text {
            font-size: 11px;
            color: #5d606b;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: color 0.2s;
        }

        .toggle-group .toggle-text.active {
            color: #d1d4dc;
        }

        .toggle-switch {
            position: relative;
            width: 30px;
            height: 16px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #363a45;
            border-radius: 16px;
            transition: background 0.2s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 10px;
            width: 10px;
            left: 3px;
            bottom: 3px;
            background: #787b86;
            border-radius: 50%;
            transition: transform 0.2s, background 0.2s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #2962ff;
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(14px);
            background: #fff;
        }

        .toggle-group.bullish-color .toggle-switch input:checked + .toggle-slider {
            background: #26a69a;
        }

        .toggle-group.bearish-color .toggle-switch input:checked + .toggle-slider {
            background: #ef5350;
        }

        .toggle-group.neutral-color .toggle-switch input:checked + .toggle-slider {
            background: #5d606b;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #131722;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #363a45;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #4a4e59;
        }

        /* ===== MOBILE TOGGLE BUTTONS ===== */
        .mobile-menu-toggle,
        .mobile-analysis-toggle {
            display: none;
            position: fixed;
            z-index: 1001;
            background: #2962ff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .mobile-menu-toggle {
            top: 12px;
            left: 12px;
        }

        .mobile-analysis-toggle {
            bottom: 20px;
            right: 20px;
        }

        .mobile-menu-toggle:active,
        .mobile-analysis-toggle:active {
            transform: scale(0.95);
        }

        .mobile-close-btn {
            display: none;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .mobile-close-btn:hover {
            background: rgba(120, 123, 134, 0.1);
            color: #d1d4dc;
        }

        .backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }

        .backdrop.active {
            display: block;
        }

        /* ===== MOBILE BOTTOM NAV ===== */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: #1e222d;
            border-top: 1px solid #2a2e39;
            z-index: 1100;
            justify-content: space-around;
            align-items: center;
            padding: 0 4px;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 12px;
            background: none;
            border: none;
            color: #787b86;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s;
            min-width: 56px;
            position: relative;
        }

        .mobile-nav-item .nav-icon {
            font-size: 20px;
            line-height: 1;
        }

        .mobile-nav-item.active {
            color: #2962ff;
        }

        .mobile-nav-item .nav-badge {
            position: absolute;
            top: 2px;
            right: 6px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: none;
        }

        .mobile-nav-item .nav-badge.visible {
            display: block;
        }

        /* ===== SETTINGS SHEET (wrapper for mobile bottom-sheet) ===== */
        .settings-sheet {
            display: contents; /* Transparent on desktop */
        }
        .settings-sheet-header {
            display: none;
        }
        .settings-sheet-body {
            display: contents;
        }
        .mobile-section-label {
            display: none;
        }

        /* Desktop: unwrap mobile-contract-row so Exp + Strike flow inline */
        .mobile-contract-row {
            display: contents;
        }

        /* Desktop: hide strike matrix trigger + modal (only for mobile) */
        .strike-matrix-trigger {
            display: none !important;
        }
        .strike-modal-overlay {
            display: none;
        }

        /* ===== DATE RANGE BUTTONS ===== */
        .mobile-date-range {
            display: none; /* shown on mobile via controls-bar grid */
        }

        /* Desktop date range (always visible) */
        .desktop-date-range {
            display: flex;
            gap: 2px;
            background: #131722;
            padding: 2px;
            border-radius: 4px;
        }
        .desktop-date-range .date-range-btn {
            flex: none;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 500;
            background: transparent;
            color: #787b86;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .desktop-date-range .date-range-btn:hover {
            color: #d1d4dc;
        }
        .desktop-date-range .date-range-btn.active {
            background: #2962ff;
            color: white;
        }

        .date-range-group {
            display: flex;
            gap: 4px;
            width: 100%;
        }

        .date-range-btn {
            flex: 1;
            padding: 8px 4px;
            font-size: 12px;
            font-weight: 700;
            background: #2a2e39;
            color: #787b86;
            border: 1px solid #363a45;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
        }

        .date-range-btn.active {
            background: #2962ff;
            color: #fff;
            border-color: #2962ff;
        }

        .date-range-btn:not(.active):active {
            background: #363a45;
        }

        /* ===== CALL/PUT SWITCH ===== */
        .mobile-cp-switch {
            display: none; /* shown on mobile via controls-bar grid */
        }

        /* Desktop Call/Put Toggle (always visible) */
        .desktop-cp-toggle {
            display: flex;
            background: #131722;
            border-radius: 4px;
            overflow: hidden;
            padding: 2px;
            gap: 2px;
        }
        .desktop-cp-toggle .cp-opt {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            border-radius: 3px;
            background: transparent;
            color: #787b86;
            transition: all 0.15s;
        }
        .desktop-cp-toggle .cp-opt:hover {
            color: #d1d4dc;
        }
        .desktop-cp-toggle .cp-opt.call-active {
            background: #26a69a;
            color: #fff;
        }
        .desktop-cp-toggle .cp-opt.put-active {
            background: #ef5350;
            color: #fff;
        }

        .cp-toggle {
            display: flex;
            background: #1e222d;
            border-radius: 8px;
            border: 1px solid #363a45;
            overflow: hidden;
            height: 40px;
        }

        .cp-toggle-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #787b86;
            padding: 0 12px;
        }

        .cp-toggle-option.active {
            color: #fff;
        }

        .cp-toggle-option.call-active {
            background: #26a69a;
            color: #fff;
        }

        .cp-toggle-option.put-active {
            background: #ef5350;
            color: #fff;
        }

        /* ===== MOBILE ACTION BANNER ===== */
        .mobile-action-banner {
            display: none;
            position: fixed;
            bottom: 56px;
            left: 0;
            right: 0;
            padding: 10px 16px;
            z-index: 1099;
            cursor: pointer;
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(100%);
            opacity: 0;
        }

        .mobile-action-banner.visible {
            transform: translateY(0);
            opacity: 1;
        }

        .mobile-action-banner.buy {
            background: #0d2b26;
            border-top: 3px solid #26a69a;
        }

        .mobile-action-banner.sell {
            background: #2b1215;
            border-top: 3px solid #ef5350;
        }

        .mobile-action-banner.hold {
            background: #1e222d;
            border-top: 3px solid #787b86;
        }

        .mobile-action-banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-action-label {
            font-size: 20px;
            font-weight: 900;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .mobile-action-banner.buy .mobile-action-label { color: #26a69a; }
        .mobile-action-banner.sell .mobile-action-label { color: #ef5350; }
        .mobile-action-banner.hold .mobile-action-label { color: #787b86; }

        .mobile-action-meta {
            text-align: right;
            font-size: 11px;
            color: #787b86;
        }

        .mobile-action-meta strong {
            color: #d1d4dc;
        }

        /* Hide mobile-only elements on desktop */
        .exp-calendar-overlay {
            display: none !important;
        }

        /* ===== MOBILE RESPONSIVE (≤768px) ===== */
        @media (max-width: 768px) {
            /* Hide sidebar tab bar on mobile — bottom nav controls which panel shows */
            .watchlist-tabs { display: none !important; }

            /* Hide sidebar collapse/expand toggle on mobile */
            .sidebar-toggle-btn { display: none !important; }

            /* Ideas panel title — visible only on mobile */
            .ideas-panel-title {
                display: block !important;
                font-size: 18px;
                font-weight: 700;
                color: #d1d4dc;
                padding: 14px 16px 8px;
                border-bottom: 1px solid #2a2e39;
                letter-spacing: 0.5px;
            }

            html, body {
                overflow: hidden;
                height: 100%;
                height: -webkit-fill-available;
            }

            .app-container {
                height: 100%;
                height: -webkit-fill-available;
            }

            .main-panel {
                overflow: hidden;
                padding-bottom: 56px; /* space for bottom nav */
            }

            /* Show bottom nav + action banner */
            .mobile-bottom-nav {
                display: flex;
            }

            .mobile-action-banner {
                display: block;
            }

            /* Hide old floating toggle buttons */
            .mobile-menu-toggle,
            .mobile-analysis-toggle {
                display: none !important;
            }

            /* Hide old signal-peek (replaced by action banner) */
            .signal-peek {
                display: none !important;
            }

            /* ---- Watchlist sidebar overlay ---- */
            .watchlist-sidebar {
                position: fixed;
                top: 10vh;
                left: 0;
                right: 0;
                bottom: 56px;
                width: 100% !important;
                max-width: 100%;
                min-width: 100% !important;
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
                transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 1002;
                border-top: 1px solid #2a2e39;
                border-right: none !important;
            }

            .watchlist-sidebar.collapsed .watchlist-header,
            .watchlist-sidebar.collapsed .watchlist-search,
            .watchlist-sidebar.collapsed .watchlist-items,
            .watchlist-sidebar.collapsed .watchlist-tabs,
            .watchlist-sidebar.collapsed .ideas-panel {
                opacity: 1;
                pointer-events: auto;
            }

            .watchlist-sidebar.mobile-open {
                transform: translateY(0);
            }

            .watchlist-sidebar .mobile-close-btn {
                display: none;
            }

            .watchlist-header {
                padding: 14px 16px 10px;
                border-bottom: 1px solid #2a2e39;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .watchlist-header h2 {
                font-size: 15px;
                font-weight: 700;
                color: #d1d4dc;
                letter-spacing: 0.3px;
                text-transform: none;
            }
            .watchlist-header .sheet-done-btn {
                display: block;
            }

            .watchlist-sidebar::before {
                content: '';
                display: none;
            }

            /* ---- Analysis sidebar: bottom sheet ---- */
            .analysis-sidebar {
                position: fixed;
                top: 10vh;
                left: 0;
                right: 0;
                bottom: 56px;
                width: 100%;
                max-width: 100%;
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
                transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 1002;
                border-left: none;
                border-top: 1px solid #2a2e39;
            }

            .analysis-sidebar.mobile-open {
                transform: translateY(0);
            }

            .analysis-sheet-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 14px 16px 10px;
                border-bottom: 1px solid #2a2e39;
                flex-shrink: 0;
            }
            .analysis-sheet-header .sheet-title {
                font-size: 15px;
                font-weight: 700;
                color: #d1d4dc;
                letter-spacing: 0.3px;
            }

            .analysis-sidebar .mobile-close-btn {
                display: none;
            }

            /* Bottom sheet drag handle */
            .analysis-sidebar::before {
                content: '';
                display: none;
                width: 36px;
                height: 4px;
                background: #4a4e59;
                border-radius: 2px;
                margin: 8px auto 4px;
            }

            /* ---- Compact header (two rows on mobile) ---- */
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 0;
                padding: 0;
                min-height: auto;
            }

            .header-logo {
                display: none;
            }

            /* Top row: underlying symbol + ticking price */
            .mobile-header-top {
                display: flex !important;
                align-items: center;
                justify-content: space-between;
                padding: 6px 12px;
                background: #131722;
                border-bottom: 1px solid #2a2e3966;
            }

            .mobile-underlying-symbol {
                font-size: 15px;
                font-weight: 800;
                color: #d1d4dc;
            }

            .mobile-underlying-price {
                font-size: 15px;
                padding: 6px 12px;
                font-weight: 800;
                font-family: 'SF Mono', 'Monaco', monospace;
                color: #d1d4dc;
                transition: color 0.3s;
            }

            .mobile-underlying-price.tick-up { color: #26a69a; }
            .mobile-underlying-price.tick-down { color: #ef5350; }

            /* Bottom row: contract info */
            .header-contract {
                flex: 1;
                flex-direction: row;
                align-items: baseline;
                gap: 8px;
                padding: 5px 12px;
                background: transparent;
                border-radius: 0;
            }

            .contract-symbol {
                font-size: 13px;
                font-weight: 700;
                color: #787b86;
            }

            .contract-details {
                display: none;
            }

            .contract-price {
                font-size: 13px;
            }

            .contract-change {
                font-size: 11px;
            }

            /* Hide desktop logout, show mobile sign-out in header */
            .logout-btn {
                display: none !important;
            }

            .submit-idea-btn:not(.visible) {
                display: none !important;
            }

            /* Mobile sign-out button in header top row */
            .mobile-signout-header {
                display: inline-flex !important;
                align-items: center;
                gap: 4px;
                padding: 3px 10px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                color: #ef5350;
                background: rgba(239, 83, 80, 0.08);
                border: 1px solid rgba(239, 83, 80, 0.2);
                cursor: pointer;
                text-decoration: none;
                transition: all 0.15s;
                white-space: nowrap;
                margin-left: 4px;
            }
            .mobile-signout-header:hover {
                background: rgba(239, 83, 80, 0.15);
            }

            /* Mobile submit idea icon button — compact, next to sign out */
            .mobile-submit-idea-btn {
                display: inline-flex !important;
                align-items: center;
                justify-content: center;
                width: 30px;
                height: 23px;
                padding: 0;
                margin-left: auto;
                border-radius: 4px;
                font-size: 14px;
                background: linear-gradient(135deg, #d4a017, #b8860b);
                border: none;
                cursor: pointer;
                transition: all 0.15s;
                box-shadow: 0 1px 4px rgba(212, 160, 23, 0.25);
                line-height: 1;
            }
            .mobile-submit-idea-btn:hover {
                background: linear-gradient(135deg, #e6b422, #c99700);                
            }

            /* Hide original submit idea btn on mobile (use mobile version) */
            .submit-idea-btn {
                display: none !important;
            }

            /* Hide the old mobile logout row in settings */
            .mobile-logout-row {
                display: none !important;
            }

            .mobile-logout-btn {
                display: none !important;
            }

            /* ---- Toast notifications: bottom-right above tab menu on mobile ---- */
            .toast-container {
                top: auto !important;
                bottom: 66px; /* 56px nav + 10px gap */
                right: 10px;
                left: 10px;
                flex-direction: column-reverse;
            }
            .toast-container .toast {
                max-width: 100%;
                animation: mobileToastIn .35s ease-out;
            }
            .toast-container .toast.fade-out {
                animation: mobileToastOut .3s ease-in forwards;
            }
            .ideas-toast {
                top: auto !important;
                bottom: 66px;
                right: 10px;
                left: 10px;
                flex-direction: column-reverse;
            }
            .ideas-toast-item {
                transform: translateY(100px);
                animation: mobileToastIn 0.4s ease-out forwards, mobileToastOut 0.4s ease-in 4.6s forwards;
            }
            @keyframes mobileToastIn {
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes mobileToastOut {
                to { opacity: 0; transform: translateY(100px); }
            }

            /* ---- Controls Summary: hidden on mobile ---- */
            .controls-summary {
                display: none !important;
            }

            .controls-summary.active {
                display: none !important;
            }

            /* ---- Mobile LIVE badge in header ---- */
            .mobile-live-badge {
                display: inline-flex !important;
                align-items: center;
                gap: 4px;
                padding: 3px 10px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 700;
                letter-spacing: 0.5px;
                cursor: pointer;
                background: #2a2e39;
                color: #787b86;
                border: 1px solid #363a45;
                margin-left: auto;
                white-space: nowrap;
                transition: all 0.2s;
            }
            .mobile-live-badge.active {
                background: rgba(239, 83, 80, 0.15);
                color: #ef5350;
                border-color: rgba(239, 83, 80, 0.4);
                animation: livePulse 1.5s ease-in-out infinite;
            }
            .mobile-live-badge.mock-active {
                background: rgba(255, 235, 59, 0.12);
                color: #ffeb3b;
                border-color: rgba(255, 235, 59, 0.3);
            }

            /* ---- Show analyze-btn on mobile ---- */
            .analyze-btn {
                display: flex !important;
                justify-content: center;
                align-items: center;
                padding: 12px;
                font-size: 14px;
                font-weight: 700;
                background: #2962ff;
                color: #fff;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                width: 100%;
            }
            .analyze-btn:hover {
                background: #1e88e5;
            }

            /* ===== SETTINGS SHEET: Mobile Bottom Sheet ===== */
            .settings-sheet {
                display: flex;
                flex-direction: column;
                position: fixed;
                top: 10vh;
                left: 0;
                right: 0;
                bottom: 56px;
                background: #1a1e2e;
                border-radius: 16px 16px 0 0;
                border-top: 1px solid #363a45;
                z-index: 1100;
                transform: translateY(100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 -8px 32px rgba(0,0,0,0.6);
                overflow: hidden;
            }
            .settings-sheet.open {
                transform: translateY(0);
            }

            .settings-sheet-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 14px 16px 10px;
                border-bottom: 1px solid #2a2e39;
                flex-shrink: 0;
                position: relative;
            }
            .sheet-drag-handle {
                position: absolute;
                top: 6px;
                left: 50%;
                transform: translateX(-50%);
                width: 36px;
                height: 4px;
                background: #4a4e59;
                border-radius: 2px;
            }
            .sheet-title {
                font-size: 15px;
                font-weight: 700;
                color: #d1d4dc;
                letter-spacing: 0.3px;
            }
            .sheet-done-btn {
                background: none;
                border: none;
                color: #2962ff;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                padding: 4px 2px;
                letter-spacing: 0.2px;
            }
            .sheet-done-btn:active {
                opacity: 0.7;
            }

            .settings-sheet-body {
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                flex: 1;
                min-height: 0;
                -webkit-overflow-scrolling: touch;
            }

            /* Section labels inside the sheet */
            .mobile-section-label {
                display: block;
                font-size: 10px;
                font-weight: 700;
                letter-spacing: 1.2px;
                text-transform: uppercase;
                color: #636983;
                padding: 14px 6px 6px;
            }

            /* ---- Controls Bar: vertical flex inside sheet ---- */
            .controls-bar {
                padding: 0 6px 8px;
                display: flex !important;
                flex-direction: column;
                gap: 10px;
                background: transparent;
                border-bottom: none;
            }

            .controls-bar.collapsed {
                display: flex !important; /* Sheet controls visibility, not collapsed class */
            }

            /* Hide desktop From/To/Type/desktop toggles on mobile */
            #from-group, #to-group, #type-group,
            .desktop-cp-toggle, .desktop-date-range {
                display: none !important;
            }

            /* Contract row: Exp + Strike side by side, full width like Call/Put */
            .mobile-contract-row {
                display: flex;
                gap: 8px;
                width: 100%;
            }
            .mobile-contract-row .control-group {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                min-width: 0;
                width: auto;
            }
            .mobile-contract-row .control-group:first-child {
                flex: 1;
            }
            /* Show strike control group, but hide the native select */
            .mobile-contract-row .control-group:last-child {
                flex: 1;
            }
            .mobile-contract-row .control-group select,
            .mobile-contract-row .exp-calendar-trigger {
                padding: 12px 10px;
                font-size: 14px;
                height: 44px;
                flex: 1;
                min-width: 0;
            }

            /* ---- Strike Matrix Trigger Button (mobile) ---- */
            .strike-matrix-trigger {
                display: flex !important;
                align-items: center;
                justify-content: space-between;
                padding: 12px 10px;
                font-size: 14px;
                height: 44px;
                flex: 1;
                min-width: 0;
                background: #1e222d;
                border: 1px solid #363a45;
                border-radius: 8px;
                color: #d1d4dc;
                cursor: pointer;
                font-family: inherit;
                font-weight: 600;
            }
            .strike-matrix-trigger:active {
                background: #2a2e39;
            }
            .strike-trigger-chevron {
                font-size: 10px;
                color: #787b86;
                margin-left: 6px;
            }

            /* Hide native select on mobile, show trigger */
            .mobile-contract-row .control-group:last-child select#strike {
                display: none;
            }

            /* ---- Strike Modal Overlay ---- */
            .strike-modal-overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                z-index: 10000;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
                align-items: flex-end;
                justify-content: center;
            }
            .strike-modal-overlay.open {
                display: flex;
            }
            .strike-modal {
                width: 100%;
                max-height: 70vh;
                background: #131722;
                border-radius: 16px 16px 0 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                animation: strikeModalSlideUp 0.25s ease-out;
            }
            @keyframes strikeModalSlideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }
            .strike-modal-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 16px 16px 12px;
                border-bottom: 1px solid #2a2e39;
            }
            .strike-modal-title {
                font-size: 16px;
                font-weight: 700;
                color: #d1d4dc;
            }
            .strike-modal-close {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                border: none;
                background: #2a2e39;
                color: #d1d4dc;
                font-size: 20px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0;
                line-height: 1;
            }
            .strike-modal-close:active {
                background: #363a45;
            }

            /* Strike matrix inside modal */
            .strike-matrix {
                width: 100%;
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                scroll-behavior: smooth;
                padding: 12px;
            }
            .strike-matrix::-webkit-scrollbar {
                display: none;
            }
            .strike-matrix-inner {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                padding: 0;
            }
            .strike-cell {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 52px;
                padding: 4px 6px;
                border-radius: 10px;
                background: #1e222d;
                border: 1px solid #2a2e39;
                cursor: pointer;
                transition: all 0.15s;
            }
            .strike-cell:active {
                transform: scale(0.95);
            }
            .strike-cell .strike-val {
                font-size: 15px;
                font-weight: 700;
                color: #d1d4dc;
                line-height: 1.2;
            }
            .strike-cell .strike-tag {
                font-size: 9px;
                color: #787b86;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                margin-top: 2px;
            }
            .strike-cell.atm {
                background: rgba(41, 98, 255, 0.15);
                border-color: #2962ff;
            }
            .strike-cell.atm .strike-val {
                color: #5b8af5;
            }
            .strike-cell.atm .strike-tag {
                color: #2962ff;
                font-weight: 700;
            }
            .strike-cell.selected {
                background: #2962ff;
                border-color: #2962ff;
            }
            .strike-cell.selected .strike-val {
                color: #fff;
            }
            .strike-cell.selected .strike-tag {
                color: rgba(255, 255, 255, 0.7);
            }
            .strike-cell.itm .strike-tag {
                color: #26a69a;
            }
            .strike-cell.otm .strike-tag {
                color: #ef5350;
            }

            /* Show mobile replacements */
            .mobile-cp-switch {
                display: block !important;
                width: 100%;
            }

            .mobile-date-range {
                display: block !important;
                width: 100%;
            }

            .control-group {
                display: flex;
                flex-direction: column;
                width: 100%;
                flex: 1;
                min-width: 0;
            }

            .control-group select,
            .control-group input {
                flex: 1;
                width: 100%;
                min-width: 0;
                padding: 10px 8px;
                font-size: 13px;
                border-radius: 8px;
                background: #131722;
                border: 1px solid #363a45;
            }

            .control-group label {
                min-width: 0;
                font-size: 10px;
                color: #636983;
                margin-bottom: 2px;
            }

            /* Show Exp/Strike labels inside contract row — left of control */
            .mobile-contract-row .control-group label {
                display: block;
                font-size: 10px;
                color: #636983;
                text-transform: uppercase;
                font-weight: 600;
                letter-spacing: 0.5px;
                margin-bottom: 0;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* ---- Exp Calendar Picker ---- */
            .exp-calendar-trigger {
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                padding: 10px 8px;
                font-size: 13px;
                border-radius: 8px;
                background: #131722;
                border: 1px solid #363a45;
                color: #d1d4dc;
                cursor: pointer;
                font-family: inherit;
            }
            .exp-calendar-trigger .cal-icon {
                font-size: 14px;
                color: #636983;
            }
            .exp-calendar-overlay {
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.6);
                z-index: 2000;
                align-items: center;
                justify-content: center;
            }
            .exp-calendar-overlay.open {
                display: flex !important;
            }
            .exp-calendar-card {
                background: #1a1e2e;
                border-radius: 16px;
                border: 1px solid #2a2e39;
                width: 320px;
                max-width: 92vw;
                box-shadow: 0 12px 40px rgba(0,0,0,0.7);
                overflow: hidden;
            }
            .exp-cal-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 14px 16px;
                border-bottom: 1px solid #2a2e39;
            }
            .exp-cal-header .cal-title {
                font-size: 15px;
                font-weight: 700;
                color: #d1d4dc;
            }
            .exp-cal-header button {
                background: none;
                border: none;
                color: #9ca3af;
                font-size: 20px;
                cursor: pointer;
                padding: 0 6px;
                line-height: 1;
            }
            .exp-cal-header button:active { opacity: 0.6; }
            .exp-cal-grid {
                padding: 8px 12px 14px;
            }
            .exp-cal-weekdays {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                text-align: center;
                font-size: 10px;
                font-weight: 700;
                color: #636983;
                letter-spacing: 0.8px;
                margin-bottom: 4px;
            }
            .exp-cal-days {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
            }
            .exp-cal-day {
                text-align: center;
                padding: 8px 0;
                font-size: 13px;
                border-radius: 8px;
                color: #363a45;
                cursor: default;
            }
            .exp-cal-day.valid {
                color: #d1d4dc;
                background: #1e222d;
                cursor: pointer;
                font-weight: 700;
            }
            .exp-cal-day.valid:active {
                background: #2962ff;
                color: #fff;
            }
            .exp-cal-day.selected {
                background: #2962ff;
                color: #fff;
                font-weight: 700;
            }
            .exp-cal-day.today {
                border: 1px solid #636983;
            }
            .exp-cal-day.empty {
                visibility: hidden;
            }

            /* Call/Put toggle - clean full-width */
            .cp-toggle {
                width: 100%;
                height: 42px;
                border-radius: 8px;
                background: #131722;
                border: 1px solid #363a45;
            }
            .cp-toggle-option {
                font-size: 14px;
                font-weight: 700;
                border-radius: 6px;
            }

            /* Date range buttons */
            .date-range-group {
                width: 100%;
                display: flex;
                gap: 3px;
                background: #131722;
                padding: 3px;
                border-radius: 8px;
                border: 1px solid #2a2e39;
            }
            .date-range-btn {
                flex: 1;
                padding: 9px 0;
                min-height: 38px;
                font-size: 12px;
                font-weight: 700;
                border-radius: 6px;
                text-align: center;
                background: #1e222d;
                color: #c8cad0;
                border: none;
            }
            .date-range-btn.active {
                background: #2962ff;
                color: #fff;
            }

            /* Interval buttons */
            .interval-buttons {
                width: 100%;
                display: flex;
                gap: 3px;
                background: #131722;
                padding: 3px;
                border-radius: 8px;
                border: 1px solid #2a2e39;
            }
            .interval-btn {
                flex: 1;
                padding: 9px 0;
                min-height: 38px;
                font-size: 12px;
                font-weight: 700;
                border-radius: 6px;
                text-align: center;
                background: #1e222d;
                color: #c8cad0;
                border: none;
            }
            .interval-btn.active {
                background: #2962ff;
                color: #fff;
            }

            /* Action row */
            .mobile-action-row {
                display: flex !important;
                gap: 8px;
                width: 100%;
                padding: 8px 16px 12px;
                background: #1a1e2e;
                border-top: 1px solid #2a2e39;
                flex-shrink: 0;
            }
            .mobile-action-row .analyze-btn {
                flex: 2;
                width: auto;
                padding: 12px 6px;
                min-height: 44px;
                font-size: 14px;
                font-weight: 700;
                border-radius: 8px;
            }
            .mobile-action-row .live-btn {
                flex: 1;
                width: auto;
                padding: 10px 6px;
                min-height: 44px;
                font-size: 12px;
                font-weight: 600;
                border-radius: 8px;
            }

            .live-btn {
                width: 100%;
                padding: 8px 12px;
                min-height: 36px;
                font-size: 12px;
            }

            /* ---- Filter bar inside sheet ---- */
            .filter-bar {
                flex-wrap: wrap;
                overflow-x: visible;
                padding: 0 16px 4px;
                gap: 10px;
                flex-direction: column;
                align-items: stretch;
                background: transparent;
                border-bottom: none;
            }

            .filter-bar::-webkit-scrollbar {
                display: none;
            }

            .filter-bar .filter-label {
                display: none;
            }

            /* Chart type + confidence as separate rows */
            .mobile-chart-conf-row {
                display: flex !important;
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            .mobile-chart-conf-row .underlay-toggle {
                border-right: none;
                padding-right: 0;
                margin-right: 0;
                width: 100%;
            }
            .mobile-chart-conf-row .underlay-label {
                display: none;
            }
            .mobile-chart-conf-row .underlay-btn-group {
                display: flex;
                gap: 3px;
                background: #131722;
                padding: 3px;
                border-radius: 8px;
                border: 1px solid #2a2e39;
                width: 100%;
            }
            .mobile-chart-conf-row .underlay-btn {
                flex: 1;
                padding: 9px 0;
                font-size: 12px;
                font-weight: 700;
                border-radius: 6px;
                text-align: center;
                background: #1e222d;
                color: #c8cad0;
                border: none;
            }
            .mobile-chart-conf-row .underlay-btn.active {
                background: #2962ff;
                color: #fff;
            }
            .mobile-chart-conf-row .conf-toggle-group {
                border-left: none !important;
                padding-left: 0 !important;
                margin-left: 0;
                width: 100%;
            }
            .mobile-chart-conf-row .conf-btn-group {
                display: flex;
                gap: 3px;
                background: #131722;
                padding: 3px;
                border-radius: 8px;
                border: 1px solid #2a2e39;
                width: 100%;
            }
            .mobile-chart-conf-row .conf-label {
                display: block;
                font-size: 10px;
                font-weight: 700;
                letter-spacing: 1.2px;
                text-transform: uppercase;
                color: #636983;
                margin-bottom: 6px;
            }
            .mobile-chart-conf-row .conf-btn {
                flex: 1;
                padding: 9px 0;
                font-size: 11px;
                font-weight: 700;
                border-radius: 6px;
                text-align: center;
                background: #1e222d;
                color: #c8cad0;
                border: none;
            }
            .mobile-chart-conf-row .conf-btn.active {
                background: #2962ff;
                color: #fff;
            }

            /* Signal toggles as clean 2-column grid */
            .mobile-signals-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                width: 100%;
                padding: 4px 0 8px;
            }
            .mobile-signals-grid .toggle-group {
                flex-shrink: 0;
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 6px 0;
            }
            .mobile-signals-grid .toggle-text {
                font-size: 12px;
            }

            .toggle-group {
                flex-shrink: 0;
            }

            /* ---- Stock toggle: hide with collapsed controls on mobile ---- */
            .underlay-toggle {
                border-right: none;
                padding-right: 0;
                margin-right: 0;
                flex-shrink: 0;
            }

            /* Hide desktop filter items on mobile, show mobile versions */
            .desktop-filter-item {
                display: none !important;
            }

            /* ---- Chart: fill available space ---- */
            .chart-area {
                flex: 1;
                flex-direction: column;
                overflow: hidden;
                min-height: 0;
            }

            .charts-container {
                flex: 1;
                min-height: 0;
            }

            #price-chart {
                flex: 3;
                min-height: 0;
            }

            #stock-chart {
                flex: 1;
                min-height: 0;
            }

            #volume-chart {
                flex: 1;
                min-height: 0;
            }

            /* ---- Watchlist mobile styling ---- */
            .watchlist-search input {
                padding: 12px 14px;
                font-size: 14px;
            }

            .watchlist-item {
                padding: 14px 16px;
            }

            .watchlist-symbol {
                font-size: 15px;
            }

            /* ---- Analysis sidebar content mobile ---- */
            .sidebar-content {
                padding: 12px;
            }

            .composite-card {
                padding: 12px;
                margin-bottom: 10px;
            }

            .composite-action-label {
                font-size: 24px;
            }

            .greeks-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }

            .greek-item {
                padding: 8px 4px;
            }

            .greek-value {
                font-size: 14px;
            }

            .greek-label {
                font-size: 9px;
            }

            .chain-grid {
                gap: 4px;
            }

            .chain-item {
                padding: 6px 4px;
            }

            .chain-value {
                font-size: 12px;
            }

            .chain-label {
                font-size: 8px;
            }

            .recommendation-box {
                font-size: 12px;
                padding: 10px;
            }

            /* Stats grid mobile */
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 4px;
            }

            .stat-item {
                padding: 8px 4px;
            }

            .stat-value {
                font-size: 16px;
            }

            .stat-label {
                font-size: 9px;
            }
        }

        /* ===== LANDSCAPE MOBILE RESPONSIVE (≤1024px width AND ≤500px height) ===== */
        @media (max-width: 1024px) and (max-height: 500px) {
            html, body {
                overflow: auto;
            }

            .main-panel {
                overflow: visible;
            }

            .mobile-menu-toggle,
            .mobile-analysis-toggle {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .mobile-bottom-nav {
                display: none;
            }

            .watchlist-sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                bottom: 0;
                width: 220px;
                z-index: 1000;
                transition: left 0.3s ease;
            }

            .watchlist-sidebar.mobile-open {
                left: 0;
            }

            .analysis-sidebar {
                position: fixed;
                right: -280px;
                top: 0;
                bottom: 0;
                width: 260px;
                z-index: 1000;
                transition: right 0.3s ease;
                overflow-y: auto;
            }

            .analysis-sidebar.mobile-open {
                right: 0;
            }

            .mobile-close-btn {
                display: block;
            }

            .main-panel {
                flex: 1;
                width: 100%;
            }

            .header {
                padding-top: 60px;
            }

            .logout-btn {
                position: absolute;
                top: 12px;
                right: 12px;
                margin-left: 0;
                font-size: 11px;
                padding: 8px 12px;
                z-index: 100;
            }

            .controls-summary {
                display: none;
            }

            .controls-summary.active {
                display: flex;
            }

            .signal-peek {
                display: block;
            }

            .mobile-analysis-toggle {
                bottom: 80px;
            }

            .chart-area {
                flex-direction: column;
                overflow: visible;
                min-height: 500px;
            }

            .charts-container {
                min-height: 400px;
            }
        }

        /* ── Toast notifications ── */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,.5);
            animation: toastIn .35s ease-out;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,.12);
            cursor: pointer;
            max-width: 360px;
        }
        .toast.fade-out { animation: toastOut .3s ease-in forwards; }
        .toast.buy   { background: linear-gradient(135deg, #1b5e20cc, #2e7d32cc); }
        .toast.sell  { background: linear-gradient(135deg, #b71c1ccc, #c62828cc); }
        .toast.hold  { background: linear-gradient(135deg, #37474fcc, #455a64cc); }
        .toast-icon  { font-size: 20px; flex-shrink: 0; }
        .toast-body  { display: flex; flex-direction: column; gap: 2px; }
        .toast-title  { font-size: 14px; font-weight: 700; letter-spacing: .3px; }
        .toast-detail { font-size: 12px; opacity: .85; font-weight: 400; }
        @keyframes toastIn  { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(120%); opacity: 0; } }

        /* ── Connection-limit modal ── */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.65);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: #161b22;
            border: 1px solid #f85149;
            border-radius: 12px;
            padding: 28px 32px;
            max-width: 460px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,.5);
        }
        .modal-box .modal-icon { font-size: 40px; margin-bottom: 12px; }
        .modal-box h2 { color: #f85149; font-size: 18px; margin-bottom: 8px; }
        .modal-box p  { color: #8b949e; font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
        .modal-box .modal-btn {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px 28px;
            font-size: 14px;
            cursor: pointer;
            transition: background .2s;
        }
        .modal-box .modal-btn:hover { background: #30363d; }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Connection-limit modal -->
    <div class="modal-overlay" id="conn-limit-modal">
        <div class="modal-box">
            <div class="modal-icon">⚠️</div>
            <h2>Connection Limit Reached</h2>
            <p id="conn-limit-msg">Polygon’s WebSocket connection limit has been exceeded. The server is backing off and will retry automatically. Please wait ~30 seconds before trying live mode again.</p>
            <button class="modal-btn" id="conn-limit-ok">OK</button>
        </div>
    </div>

    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle Watchlist">
        ☰ <span>Watchlist</span>
    </button>

    <!-- Mobile Analysis Toggle Button -->
    <button class="mobile-analysis-toggle" id="mobile-analysis-toggle" aria-label="Toggle Analysis">
        📊 <span>Analysis</span>
    </button>

    <!-- Backdrop for mobile overlays -->
    <div class="backdrop" id="backdrop"></div>
    <div class="ideas-toast" id="ideas-toast"></div>

    <!-- Idea submit modal -->
    <div class="idea-modal-overlay" id="idea-modal-overlay">
        <div class="idea-modal" style="position:relative;">
            <button class="idea-modal-close" id="idea-modal-close">&times;</button>
            <h3>💡 Submit Trade Idea</h3>
            <div class="idea-form-info" id="idea-form-info">
                <span>Symbol</span><span class="val" id="idea-form-symbol">-</span>
                <span>Contract</span><span class="val" id="idea-form-contract">-</span>
                <span>Expiration</span><span class="val" id="idea-form-exp">-</span>
                <span>Price</span><span class="val" id="idea-form-price">-</span>
            </div>
            <div class="idea-action-group">
                <button class="idea-action-btn buy-action" data-action="BUY">BUY</button>
                <button class="idea-action-btn sell-action" data-action="SELL">SELL</button>
            </div>
            <textarea id="idea-note" placeholder="Optional note (e.g. breakout setup, earnings play...)"></textarea>
            <button class="idea-submit-final" id="idea-submit-final" disabled>Submit Idea</button>
        </div>
    </div>

    <div class="app-container">
        <!-- LEFT: Watchlist Sidebar -->
        <div class="watchlist-sidebar" id="watchlist-sidebar">
            <div class="watchlist-header">
                <h2>Watchlist</h2>
                <button class="sheet-done-btn" id="watchlist-done-btn">Done</button>
            </div>

            <!-- Sidebar tabs (hidden on mobile — bottom nav controls which panel shows) -->
            <div class="watchlist-tabs" id="watchlist-tabs">
                <button class="watchlist-tab active" data-tab="watchlist">Watchlist</button>
                <button class="watchlist-tab" data-tab="ideas">Ideas</button>
            </div>

            <!-- Tab: Watchlist (default) -->
            <div class="watchlist-search" id="watchlist-search-wrap">
                <input type="text" id="watchlist-search" placeholder="Search symbols...">
            </div>
            <div class="watchlist-items" id="watchlist-container">
                <!-- Watchlist items will be populated here -->
                <div class="loading">Loading...</div>
            </div>

            <!-- Tab: Ideas -->
            <div class="ideas-panel" id="ideas-panel">
                <div class="watchlist-search">
                    <input type="text" id="ideas-search" placeholder="Filter by symbol...">
                </div>
                <div class="ideas-loading" id="ideas-loading" style="display:none;">Loading ideas...</div>
                <div class="ideas-empty" id="ideas-empty" style="display:none;">No trade ideas today</div>
                <div class="ideas-list" id="ideas-list"></div>
            </div>
        </div>

        <!-- Sidebar collapse/expand toggle (outside sidebar) -->
        <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" title="Toggle Watchlist">
            <span class="toggle-arrow">&#9664;</span>
        </button>
        
        <!-- MAIN: Chart & Controls -->
        <div class="main-panel">
            <div class="header">
                <!-- Mobile top row: underlying symbol + ticking price + sign out -->
                <div class="mobile-header-top" id="mobile-header-top" style="display:none;">
                    <span class="mobile-underlying-symbol" id="mobile-underlying-symbol">-</span>
                    <span class="mobile-underlying-price" id="mobile-underlying-price">-</span>
                    <button class="mobile-submit-idea-btn" id="mobile-submit-idea-btn" style="display:none;" title="Submit Trade Idea">💡</button>
                    <a href="/api/logout" class="mobile-signout-header" style="display:none;" title="Sign Out">Sign Out</a>
                </div>
                <div class="header-logo">
                    <h1>Options<span>Ganster</span></h1>
                </div>
                <div class="header-contract" id="contract-info">
                    <div class="contract-symbol" id="contract-symbol">-</div>
                    <div class="contract-price" id="contract-price">-</div>
                    <div class="contract-change" id="contract-change">-</div>
                    <span class="mobile-live-badge" id="mobile-live-badge" style="display:none;">LIVE</span>
                    <div class="idea-price-badge" id="idea-price-badge">
                        <span class="idea-price-label">Idea @</span>
                        <span id="idea-price-value">-</span>
                    </div>
                    <div class="contract-details" id="contract-details">Select a symbol</div>
                </div>

                <button class="submit-idea-btn" id="submit-idea-btn" title="Share this contract as a trade idea">💡 Submit Idea</button>
                <a href="/api/logout" class="logout-btn" title="Sign Out">⏻ Logout</a>
            </div>
            
            <!-- Controls Summary Bar (Mobile only, shown after first analyze) -->
            <div class="controls-summary" id="controls-summary">
                <span class="summary-text" id="summary-text">SPY $500C 5m</span>
                <button class="summary-analyze-btn" id="summary-analyze-btn" style="display:none">Analyze</button>
                <button class="summary-live-btn" id="summary-live-btn">LIVE</button>
                <button class="controls-chevron" id="controls-chevron">⚙</button>
            </div>
            
            <div class="settings-sheet" id="settings-sheet">
            <div class="settings-sheet-header">
                <span class="sheet-title">Settings</span>
                <button class="sheet-done-btn" id="settings-done-btn">Done</button>
            </div>
            <div class="settings-sheet-body">
            <div class="controls-bar" id="controls-bar">
                <div class="mobile-section-label">Contract</div>
                <div class="mobile-contract-row">
                <div class="control-group">
                    <label>Exp</label>
                    <select id="expiration" style="min-width: 140px;">
                        <option value="">Loading...</option>
                    </select>
                    <button type="button" class="exp-calendar-trigger" id="exp-calendar-trigger" style="display:none;">
                        <span id="exp-cal-display">Select date</span>
                        <span class="cal-icon">📅</span>
                    </button>
                </div>
                
                <div class="control-group">
                    <label>Strike</label>
                    <select id="strike" style="min-width: 100px;">
                        <option value="">-</option>
                    </select>
                    <button type="button" class="strike-matrix-trigger" id="strike-matrix-trigger" style="display:none;">
                        <span id="strike-trigger-display">-</span>
                        <span class="strike-trigger-chevron">▼</span>
                    </button>
                </div>
                </div>

                <!-- Strike Matrix Modal (popup on mobile) -->
                <div class="strike-modal-overlay" id="strike-modal-overlay">
                    <div class="strike-modal">
                        <div class="strike-modal-header">
                            <span class="strike-modal-title">Select Strike</span>
                            <button type="button" class="strike-modal-close" id="strike-modal-close">&times;</button>
                        </div>
                        <div class="strike-matrix" id="strike-matrix">
                            <div class="strike-matrix-inner" id="strike-matrix-inner">
                                <!-- populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group" id="type-group">
                    <label>Type</label>
                    <select id="right" style="min-width: 70px;">
                        <option value="C">Call</option>
                        <option value="P">Put</option>
                    </select>
                </div>

                <!-- Desktop Call/Put Toggle (shown on desktop) -->
                <div class="desktop-cp-toggle" id="desktop-cp-toggle">
                    <button class="cp-opt call-active" id="dcp-call" data-value="C">CALL</button>
                    <button class="cp-opt" id="dcp-put" data-value="P">PUT</button>
                </div>

                <!-- Mobile Call/Put Switch (replaces dropdown on mobile) -->
                <div class="mobile-cp-switch" id="mobile-cp-switch">
                    <div class="cp-toggle">
                        <button class="cp-toggle-option call-active" id="cp-call" data-value="C">CALL</button>
                        <button class="cp-toggle-option" id="cp-put" data-value="P">PUT</button>
                    </div>
                </div>
                
                <div class="mobile-section-label">Time Range</div>
                <div class="control-group" id="from-group">
                    <label>From</label>
                    <input type="date" id="start-date" style="width: 130px;">
                </div>
                
                <div class="control-group" id="to-group">
                    <label>To</label>
                    <input type="date" id="end-date" style="width: 130px;">
                </div>

                <!-- Desktop Date Range Buttons -->
                <div class="desktop-date-range" id="desktop-date-range">
                    <button class="date-range-btn" data-range="1">1D</button>
                    <button class="date-range-btn active" data-range="5">5D</button>
                    <button class="date-range-btn" data-range="7">1W</button>
                    <button class="date-range-btn" data-range="14">2W</button>
                    <button class="date-range-btn" data-range="30">1M</button>
                    <button class="date-range-btn" data-range="90">3M</button>
                </div>

                <!-- Mobile Date Range Buttons (replaces From/To on mobile) -->
                <div class="mobile-date-range" id="mobile-date-range">
                    <div class="date-range-group">
                        <button class="date-range-btn" data-range="1">1D</button>
                        <button class="date-range-btn" data-range="5">5D</button>
                        <button class="date-range-btn" data-range="7">1W</button>
                        <button class="date-range-btn" data-range="14">2W</button>
                        <button class="date-range-btn" data-range="30">1M</button>
                        <button class="date-range-btn" data-range="90">3M</button>
                    </div>
                </div>
                
                <div class="mobile-section-label">Interval</div>
                <div class="interval-buttons">
                    <button class="interval-btn" data-interval="1">1m</button>
                    <button class="interval-btn active" data-interval="5">5m</button>
                    <button class="interval-btn" data-interval="15">15m</button>
                    <button class="interval-btn" data-interval="60">1H</button>
                </div>
            </div>

            <div class="filter-bar" id="filter-bar">
                <div class="mobile-section-label">Chart Overlay</div>
                <!-- Mobile: chart type + confidence on same row -->
                <div class="mobile-chart-conf-row" style="display:none;">
                    <div class="underlay-toggle">
                        <span class="underlay-label">Stock:</span>
                        <div class="underlay-btn-group">
                            <button class="underlay-btn" data-underlay="off">OFF</button>
                            <button class="underlay-btn" data-underlay="line">LINE</button>
                            <button class="underlay-btn active" data-underlay="candle">CANDLE</button>
                        </div>
                    </div>
                    <div class="conf-toggle-group" style="border-left:1px solid #2a2e39;padding-left:10px;margin-left:0;">
                        <span class="conf-label">Confidence:</span>
                        <div class="conf-btn-group">
                            <button class="conf-btn" data-conf="50">50%</button>
                            <button class="conf-btn" data-conf="60">60%</button>
                            <button class="conf-btn" data-conf="70">70%</button>
                            <button class="conf-btn active" data-conf="80">80%</button>
                            <button class="conf-btn" data-conf="90">90%</button>
                        </div>
                    </div>
                </div>

                <!-- Mobile: signal toggles in 2x2 grid -->
                <div class="mobile-section-label">Signal Filters</div>
                <div class="mobile-signals-grid" style="display:none;">
                    <div class="toggle-group bullish-color">
                        <label class="toggle-switch"><input type="checkbox" class="filter-mirror" data-mirror="filter-strong_bullish"><span class="toggle-slider"></span></label>
                        <span class="toggle-text">Strong Bullish</span>
                    </div>
                    <div class="toggle-group bearish-color">
                        <label class="toggle-switch"><input type="checkbox" class="filter-mirror" data-mirror="filter-strong_bearish"><span class="toggle-slider"></span></label>
                        <span class="toggle-text">Strong Bearish</span>
                    </div>
                    <div class="toggle-group bullish-color">
                        <label class="toggle-switch"><input type="checkbox" class="filter-mirror" data-mirror="filter-test_support"><span class="toggle-slider"></span></label>
                        <span class="toggle-text">Test Support</span>
                    </div>
                    <div class="toggle-group bearish-color">
                        <label class="toggle-switch"><input type="checkbox" class="filter-mirror" data-mirror="filter-test_resistance"><span class="toggle-slider"></span></label>
                        <span class="toggle-text">Test Resistance</span>
                    </div>
                    <div class="toggle-group bullish-color">
                        <label class="toggle-switch"><input type="checkbox" class="filter-mirror" data-mirror="filter-climax_bottom"><span class="toggle-slider"></span></label>
                        <span class="toggle-text">Climax Bottom</span>
                    </div>
                    <div class="toggle-group bearish-color">
                        <label class="toggle-switch"><input type="checkbox" class="filter-mirror" data-mirror="filter-climax_top"><span class="toggle-slider"></span></label>
                        <span class="toggle-text">Climax Top</span>
                    </div>
                </div>

                <!-- Desktop: original layout (hidden on mobile) -->
                <div class="underlay-toggle desktop-filter-item">
                    <span class="underlay-label" id="underlay-label">Stock:</span>
                    <div class="underlay-btn-group">
                        <button class="underlay-btn" data-underlay="off" id="underlay-off">OFF</button>
                        <button class="underlay-btn" data-underlay="line" id="underlay-line">LINE</button>
                        <button class="underlay-btn active" data-underlay="candle" id="underlay-candle">CANDLE</button>
                    </div>
                </div>

                <span class="filter-label">Signals:</span>

                <div class="conf-toggle-group desktop-filter-item">
                    <span class="conf-label">Confidence:</span>
                    <div class="conf-btn-group">
                        <button class="conf-btn" data-conf="50">50%</button>
                        <button class="conf-btn" data-conf="60">60%</button>
                        <button class="conf-btn" data-conf="70">70%</button>
                        <button class="conf-btn active" data-conf="80">80%</button>
                        <button class="conf-btn" data-conf="90">90%</button>
                    </div>
                </div>

                <div class="toggle-group bullish-color desktop-filter-item">
                    <label class="toggle-switch"><input type="checkbox" id="filter-strong_bullish"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-strong_bullish">Strong Bullish</span>
                </div>

                <div class="toggle-group bearish-color desktop-filter-item">
                    <label class="toggle-switch"><input type="checkbox" id="filter-strong_bearish"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-strong_bearish">Strong Bearish</span>
                </div>

                <div class="toggle-group bullish-color" style="display:none">
                    <label class="toggle-switch"><input type="checkbox" id="filter-accumulation"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-accumulation">Accumulation</span>
                </div>

                <div class="toggle-group bearish-color" style="display:none">
                    <label class="toggle-switch"><input type="checkbox" id="filter-distribution"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-distribution">Distribution</span>
                </div>

                <div class="toggle-group bullish-color desktop-filter-item">
                    <label class="toggle-switch"><input type="checkbox" id="filter-test_support"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-test_support">Test Support</span>
                </div>

                <div class="toggle-group bearish-color desktop-filter-item">
                    <label class="toggle-switch"><input type="checkbox" id="filter-test_resistance"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-test_resistance">Test Resistance</span>
                </div>

                <div class="toggle-group bullish-color desktop-filter-item">
                    <label class="toggle-switch"><input type="checkbox" id="filter-climax_bottom"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-climax_bottom">Climax Bottom</span>
                </div>

                <div class="toggle-group bearish-color desktop-filter-item">
                    <label class="toggle-switch"><input type="checkbox" id="filter-climax_top"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-climax_top">Climax Top</span>
                </div>

                <div class="toggle-group bullish-color" style="display:none">
                    <label class="toggle-switch"><input type="checkbox" id="filter-weak_down"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-weak_down">Weak Down</span>
                </div>

                <div class="toggle-group bearish-color" style="display:none">
                    <label class="toggle-switch"><input type="checkbox" id="filter-weak_up"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-weak_up">Weak Up</span>
                </div>

                <div class="toggle-group bullish-color" style="display:none">
                    <label class="toggle-switch"><input type="checkbox" id="filter-no_supply"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-no_supply">No Supply</span>
                </div>

                <div class="toggle-group bearish-color" style="display:none">
                    <label class="toggle-switch"><input type="checkbox" id="filter-no_demand"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-no_demand">No Demand</span>
                </div>

                <div class="toggle-group neutral-color" style="display:none">
                    <label class="toggle-switch"><input type="checkbox" id="filter-neutral"><span class="toggle-slider"></span></label>
                    <span class="toggle-text" data-for="filter-neutral">Neutral</span>
                </div>
            </div>
            </div><!-- /.settings-sheet-body -->
            <!-- Mobile: Analyze + LIVE + MOCK sticky footer -->
            <div class="mobile-action-row" style="display:none;">
                <button class="analyze-btn" id="analyze-btn">▶ Analyze</button>
                <button class="live-btn" id="live-btn">⚪ LIVE</button>
                <button class="live-btn" id="mock-btn" style="background:#2a2e39;color:#787b86;font-size:11px;padding:6px 8px;min-width:auto" title="Mock mode: simulates option WS feed using CSV data. Stock prices, expirations &amp; strikes remain real.">MOCK</button>
            </div>
            </div><!-- /.settings-sheet -->
            
            <div class="chart-area">
                <div class="charts-container">
                    <div id="price-chart"></div>
                    <div id="stock-chart"></div>
                    <div id="volume-chart"></div>
                </div>
                
                <!-- RIGHT: Analysis Sidebar -->
                <div class="analysis-sidebar" id="analysis-sidebar">
                    <div class="analysis-sheet-header">
                        <span class="sheet-title">Analysis</span>
                        <button class="sheet-done-btn" id="analysis-done-btn">Done</button>
                    </div>
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" data-tab="composite">Composite</button>
                        <button class="sidebar-tab" data-tab="analysis">VPA</button>
                        <button class="sidebar-tab" data-tab="signals">Signals</button>
                    </div>
                    
                    <div class="sidebar-content" id="sidebar-content">
                        <!-- COMPOSITE TAB -->
                        <div class="tab-content active" id="tab-composite">
                            <div class="composite-card">
                                <h4>Composite Signal</h4>
                                <div id="composite-gauge" class="composite-signal-gauge neutral">
                                    <div class="composite-action-label" id="comp-action">-</div>
                                    <div class="composite-signal-sub" id="comp-signal-sub"></div>
                                    <div class="composite-meta">
                                        <span>Score: <strong id="comp-score">-</strong></span>
                                        <span>Conf: <strong id="comp-conf">-</strong></span>
                                    </div>
                                </div>
                                <div id="comp-archetype"></div>
                            </div>

                            <div class="composite-card">
                                <h4>Recommendation</h4>
                                <div class="recommendation-box" id="comp-recommendation">Analyze an option to see composite signal</div>
                                <div id="comp-warnings" style="margin-top:8px"></div>
                            </div>

                            <div class="composite-card" id="fv-card" style="display:none;">
                                <h4>Fair Value <span class="fv-verdict-badge" id="fv-verdict"></span></h4>
                                <div class="fv-card-body">
                                    <div class="fv-card-row fv-main-row">
                                        <div class="fv-card-col">
                                            <div class="fv-card-label">Theoretical</div>
                                            <div class="fv-card-value" id="fv-theo">-</div>
                                        </div>
                                        <div class="fv-card-col">
                                            <div class="fv-card-label">Market</div>
                                            <div class="fv-card-value" id="fv-market">-</div>
                                        </div>
                                        <div class="fv-card-col">
                                            <div class="fv-card-label">Diff</div>
                                            <div class="fv-card-value" id="fv-diff">-</div>
                                        </div>
                                    </div>
                                    <div class="fv-card-row fv-vol-row">
                                        <div class="fv-card-col">
                                            <div class="fv-card-label">Hist Vol</div>
                                            <div class="fv-card-value" id="fv-hv">-</div>
                                        </div>
                                        <div class="fv-card-col">
                                            <div class="fv-card-label">Impl Vol</div>
                                            <div class="fv-card-value" id="fv-iv">-</div>
                                        </div>
                                        <div class="fv-card-col">
                                            <div class="fv-card-label">HV - IV</div>
                                            <div class="fv-card-value" id="fv-hviv">-</div>
                                        </div>
                                    </div>
                                    <div class="fv-card-details" id="fv-details"></div>
                                    <div class="fv-card-extra" id="fv-extra" style="display:none;">
                                        <div class="fv-card-row">
                                            <div class="fv-card-col"><div class="fv-card-label">d₁</div><div class="fv-card-value" id="fv-d1">-</div></div>
                                            <div class="fv-card-col"><div class="fv-card-label">d₂</div><div class="fv-card-value" id="fv-d2">-</div></div>
                                            <div class="fv-card-col"><div class="fv-card-label">DTE</div><div class="fv-card-value" id="fv-dte">-</div></div>
                                        </div>
                                        <div class="fv-card-row">
                                            <div class="fv-card-col"><div class="fv-card-label">Bid</div><div class="fv-card-value" id="fv-bid">-</div></div>
                                            <div class="fv-card-col"><div class="fv-card-label">Ask</div><div class="fv-card-value" id="fv-ask">-</div></div>
                                            <div class="fv-card-col"><div class="fv-card-label">Spread</div><div class="fv-card-value" id="fv-spread">-</div></div>
                                        </div>
                                    </div>
                                    <button class="fv-toggle-btn" id="fv-toggle-btn" onclick="document.getElementById('fv-extra').style.display = document.getElementById('fv-extra').style.display === 'none' ? 'block' : 'none'; this.textContent = document.getElementById('fv-extra').style.display === 'none' ? 'Show Details ▾' : 'Hide Details ▴';">Show Details ▾</button>
                                </div>
                            </div>

                            <div class="composite-card">
                                <h4>Greeks</h4>
                                <div class="greeks-grid" id="greeks-grid">
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-delta">-</div><div class="greek-label">Δ Delta</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-gamma">-</div><div class="greek-label">Γ Gamma</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-theta">-</div><div class="greek-label">Θ Theta</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-vega">-</div><div class="greek-label">ν Vega</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-iv">-</div><div class="greek-label">IV</div></div>
                                    <div class="greek-item"><div class="greek-value neutral-val" id="g-oi">-</div><div class="greek-label">Open Int</div></div>
                                </div>
                            </div>

                            <div class="composite-card">
                                <h4>Chain Metrics</h4>
                                <div class="chain-grid" id="chain-grid">
                                    <div class="chain-item"><div class="chain-value" id="cm-ivr">-</div><div class="chain-label">IV Rank</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-gex">-</div><div class="chain-label">GEX</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-pcr">-</div><div class="chain-label">P/C Ratio</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-maxpain">-</div><div class="chain-label">Max Pain</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-calloi">-</div><div class="chain-label">Call OI</div></div>
                                    <div class="chain-item"><div class="chain-value" id="cm-putoi">-</div><div class="chain-label">Put OI</div></div>
                                </div>
                                <div id="uoa-container"></div>
                            </div>

                            <div class="composite-card" id="sr-card" style="display:none">
                                <h4>Support / Resistance</h4>
                                <div id="sr-summary"></div>
                                <div id="sr-levels-list" style="margin-top:8px"></div>
                            </div>

                            <div class="composite-card">
                                <h4>Factor Breakdown</h4>
                                <div class="factor-list" id="factor-list">
                                    <div class="loading">Analyze to see factors</div>
                                </div>
                            </div>

                        </div>

                        <!-- VPA TAB -->
                        <div class="tab-content" id="tab-analysis">
                        <div class="bias-card">
                            <h4>Market Bias</h4>
                            <div id="bias-container" class="bias-indicator neutral">
                                <div class="bias-label">-</div>
                                <div class="bias-strength">Load data to analyze</div>
                            </div>
                        </div>
                        
                        <div class="stats-grid" id="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bars">-</div>
                                <div class="stat-label">Bars</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-signals">-</div>
                                <div class="stat-label">Signals</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bullish">-</div>
                                <div class="stat-label">Bullish</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="stat-bearish">-</div>
                                <div class="stat-label">Bearish</div>
                            </div>
                        </div>
                        
                        <div class="signals-header">Recent Signals</div>
                        <div id="signals-container" class="signal-list">
                            <div class="loading">No signals yet</div>
                        </div>
                        </div><!-- end tab-analysis -->

                        <!-- SIGNALS TAB -->
                        <div class="tab-content" id="tab-signals">
                            <div class="signals-header">All Signals (Chronological)</div>
                            <div id="signals-container-full" class="signal-list">
                                <div class="loading">No signals yet</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Signal Peek Banner (Mobile only) -->
    <div class="signal-peek" id="signal-peek">
        <div class="signal-peek-content">
            <div class="signal-peek-header">
                <span class="signal-peek-name" id="signal-peek-name">-</span>
                <span class="signal-peek-badge bullish" id="signal-peek-badge">BULLISH</span>
            </div>
            <div class="signal-peek-details">
                <span class="signal-peek-description" id="signal-peek-description">-</span>
                <div class="signal-peek-meta">
                    <span class="signal-peek-confidence" id="signal-peek-confidence">-</span>
                    <span class="signal-peek-time" id="signal-peek-time">-</span>
                    <span class="signal-peek-price" id="signal-peek-price">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Action Banner (above bottom nav) -->
    <div class="mobile-action-banner" id="mobile-action-banner">
        <div class="mobile-action-banner-content">
            <span class="mobile-action-label" id="mob-action-label">-</span>
            <div class="mobile-action-meta">
                <div>Score: <strong id="mob-action-score">-</strong></div>
                <div id="mob-action-signal">-</div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav" id="mobile-bottom-nav">
        <button class="mobile-nav-item" id="nav-watchlist" aria-label="Watchlist">
            <span class="nav-icon">☰</span>
            <span>Watchlist</span>
        </button>
        <button class="mobile-nav-item active" id="nav-chart" aria-label="Chart">
            <span class="nav-icon">📈</span>
            <span>Chart</span>
        </button>
        <button class="mobile-nav-item" id="nav-settings" aria-label="Settings">
            <span class="nav-icon">⚙</span>
            <span>Settings</span>
        </button>
        <button class="mobile-nav-item" id="nav-ideas" aria-label="Ideas">
            <span class="nav-icon">💡</span>
            <span>Ideas</span>
        </button>
        <button class="mobile-nav-item" id="nav-analysis" aria-label="Analysis">
            <span class="nav-icon">📊</span>
            <span>Analysis</span>
            <span class="nav-badge" id="nav-analysis-badge"></span>
        </button>
    </nav>

    <!-- Exp Calendar Overlay (mobile) -->
    <div class="exp-calendar-overlay" id="exp-calendar-overlay">
        <div class="exp-calendar-card">
            <div class="exp-cal-header">
                <button id="exp-cal-prev">‹</button>
                <span class="cal-title" id="exp-cal-month-label">February 2026</span>
                <button id="exp-cal-next">›</button>
            </div>
            <div class="exp-cal-grid">
                <div class="exp-cal-weekdays">
                    <span>SU</span><span>MO</span><span>TU</span><span>WE</span><span>TH</span><span>FR</span><span>SA</span>
                </div>
                <div class="exp-cal-days" id="exp-cal-days"></div>
            </div>
        </div>
    </div>
    
    <script>
        // ===== STATE =====
        let priceChart = null;
        let stockChart = null;
        let volumeChart = null;
        let candlestickSeries = null;
        let volumeSeries = null;
        let currentInterval = 5;
        let currentSymbol = 'SPY';
        let watchlistData = {};
        let priceUpdateInterval = null;
        
        // Live mode state
        let liveMode = false;
        let liveInterval = null;
        let liveCountdown = 10;
        let liveCountdownInterval = null;
        let mockMode = false;          // mock data for testing
        let lastBarDatetime = null;    // tracks the last bar for delta updates
        let liveWs = null;             // WebSocket connection for live option feed
        let liveWsTicker = null;       // currently subscribed option ticker
        
        // Watchlist WS state
        let watchlistWs = null;         // dedicated WS for watchlist price streaming
        let watchlistWsReconnectTimer = null;
        let liveUnderlyingTicker = null;  // underlying stock ticker subscribed for chart overlay

        // ===== URL QUERY PARAMS SYNC =====
        function updateUrlParams() {
            const params = new URLSearchParams();
            if (currentSymbol) params.set('symbol', currentSymbol);
            const exp = document.getElementById('expiration')?.value;
            if (exp) params.set('exp', exp);
            const strike = document.getElementById('strike')?.value;
            if (strike) params.set('strike', strike);
            const right = document.getElementById('right')?.value;
            if (right) params.set('right', right);
            if (currentInterval) params.set('interval', currentInterval);
            // Find active date range button
            const activeRange = document.querySelector('.desktop-date-range .date-range-btn.active');
            if (activeRange) params.set('range', activeRange.dataset.range);
            // Confidence filter
            if (minConfidence !== 80) params.set('conf', minConfidence);
            // Signal toggles
            const enabledSignals = [];
            document.querySelectorAll('.filter-bar input[type=checkbox]').forEach(cb => {
                if (cb.checked) enabledSignals.push(cb.id.replace('filter-', ''));
            });
            if (enabledSignals.length > 0) params.set('signals', enabledSignals.join(','));
            const qs = params.toString();
            const newUrl = qs ? `${window.location.pathname}?${qs}` : window.location.pathname;
            window.history.replaceState(null, '', newUrl);
        }

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                symbol: params.get('symbol'),
                exp: params.get('exp'),
                strike: params.get('strike'),
                right: params.get('right'),
                interval: params.get('interval'),
                range: params.get('range'),
                conf: params.get('conf'),
                signals: params.get('signals'),
            };
        }
        
        // Controls collapse state
        let controlsCollapsed = false;
        let hasAnalyzed = false;
        
        // Signal peek state
        let latestSignalData = null;

        // Last analysis data for re-filtering
        let lastAnalysisData = null;

        // Track last composite action for change-detection toasts
        let lastCompositeAction = null;

        // Track last VPA-derived action (BUY/SELL/HOLD) for historical chart markers
        let lastVpaAction = null;

        // Underlying underlay state
        let underlayMode = 'candle';  // 'off', 'line', 'candle'

        // User role/auth info
        let currentUser = null; // {email, role, display_name}

        // Idea price tracking — when navigating from an idea
        let activeIdeaPrice = null; // null or {price, action, timestamp, posted_by}

        // Ideas WebSocket
        let ideasWs = null;
        let underlaySeries = null;
        let underlayBarsData = [];   // raw underlying bars from API
        let pocLine = null;          // Point of Control price line on stock chart
        let currentPOC = null;       // Current POC price for autoscale
        let _srPriceLines = [];      // S/R price lines on stock chart
        let _srData = null;          // support_resistance data from API

        // Unified timestamp data for multi-chart sync (ensures all charts share
        // the same set of timestamps so logical-range sync works perfectly)
        let _unifiedCandleData = [];
        let _unifiedVolumeData = [];
        let _unifiedUnderlayData = [];
        // Lookup maps for crosshair sync (time -> data point)
        let _volumeByTime = new Map();
        let _underlayByTime = new Map();

        // ===== TIMEZONE HELPER =====
        // Backend sends datetimes already in US/Eastern.
        // We parse them as-is into a Unix timestamp so the chart axis shows ET.
        // Append 'Z' to force UTC parse, so the numeric value IS the Eastern wall-clock.
        function toEasternUnix(datetimeStr) {
            // "2026-02-06 09:30:00" → treat digits as Eastern wall-clock
            const iso = datetimeStr.replace(' ', 'T') + 'Z';   // force UTC parse
            return Math.floor(new Date(iso).getTime() / 1000);
        }

        function toEasternString(datetimeStr) {
            // Already in Eastern – just reformat
            const d = new Date(datetimeStr.replace(' ', 'T') + 'Z');
            return d.toISOString().replace('T', ' ').replace('Z', '');
        }

        // ===== MULTI-CHART TIMESTAMP UNIFICATION =====
        // Ensures all three chart datasets share the exact same set of timestamps.
        // Missing bars become "whitespace" entries (time only, no value fields)
        // so logical bar indices stay aligned across all charts.
        function unifyTimestamps(candleData, volumeData, underlayData) {
            // Collect every unique timestamp across all datasets
            const allTimes = new Set();
            candleData.forEach(d => allTimes.add(d.time));
            volumeData.forEach(d => allTimes.add(d.time));
            underlayData.forEach(d => allTimes.add(d.time));

            const sortedTimes = Array.from(allTimes).sort((a, b) => a - b);

            // Build fast lookup maps
            const candleMap = new Map(candleData.map(d => [d.time, d]));
            const volumeMap = new Map(volumeData.map(d => [d.time, d]));
            const underlayMap = new Map(underlayData.map(d => [d.time, d]));

            // Pad each dataset: real data where it exists, whitespace { time } elsewhere
            const unified = {
                candle:   sortedTimes.map(t => candleMap.get(t)   || { time: t }),
                volume:   sortedTimes.map(t => volumeMap.get(t)   || { time: t }),
                underlay: sortedTimes.map(t => underlayMap.get(t) || { time: t }),
            };

            // Store lookup maps for crosshair sync
            _volumeByTime = volumeMap;
            _underlayByTime = underlayMap;

            return unified;
        }

        // ===== SIGNAL FILTER HELPERS =====
        function getEnabledSignals() {
            const enabled = new Set();
            document.querySelectorAll('.filter-bar input[type=checkbox]').forEach(cb => {
                if (cb.checked) enabled.add(cb.id.replace('filter-', ''));
            });
            return enabled;
        }

        let minConfidence = 80; // 0-100

        function filterSignals(signals) {
            const enabled = getEnabledSignals();
            return signals.filter(s => {
                // Toggle OFF = hidden, Toggle ON = visible
                if (!enabled.has(s.signal)) return false;
                if (minConfidence > 0) {
                    const conf = (s.confidence || 0) * 100;
                    if (conf < minConfidence) return false;
                }
                return true;
            });
        }

        function updateFilteredMarkers(signals) {
            if (!candlestickSeries) return;
            // Use the unified marker builder so composite + VPA markers coexist
            rebuildAllMarkers();
        }
        
        // Chart data tracking for incremental updates
        let currentBarTimestamps = new Set();
        
        // Mobile responsiveness breakpoints
        // Portrait mobile: width <= 768px (standard mobile breakpoint)
        // Landscape mobile: width <= 1024px AND height <= 500px
        // This ensures phones in landscape (e.g., iPhone X: 812x375) are detected as mobile
        // while tablets in landscape (typically height > 500px) are treated as desktop
        const MOBILE_MAX_WIDTH = 768;
        const LANDSCAPE_MAX_WIDTH = 1024;
        const LANDSCAPE_MAX_HEIGHT = 500;
        
        // Wire up confidence toggle buttons
        document.querySelectorAll('.conf-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.conf-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                minConfidence = parseInt(btn.dataset.conf);
                updateUrlParams();
                if (lastAnalysisData) {
                    updateFilteredMarkers(lastAnalysisData.signals || []);
                    updateAnalysis(lastAnalysisData);
                }
            });
        });

        // Wire up filter toggle events
        document.querySelectorAll('.filter-bar input[type=checkbox]').forEach(cb => {
            cb.addEventListener('change', () => {
                const label = document.querySelector(`[data-for="${cb.id}"]`);
                if (label) label.classList.toggle('active', cb.checked);
                updateUrlParams();
                if (lastAnalysisData) {
                    updateFilteredMarkers(lastAnalysisData.signals || []);
                    updateAnalysis(lastAnalysisData);
                }
            });
        });
        document.querySelectorAll('.filter-bar .toggle-text').forEach(label => {
            label.addEventListener('click', () => {
                const cb = document.getElementById(label.dataset.for);
                if (cb) { cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
            });
        });

        // Sync mobile mirror checkboxes with desktop originals
        document.querySelectorAll('.filter-mirror').forEach(mirror => {
            const targetId = mirror.dataset.mirror;
            const target = document.getElementById(targetId);
            if (!target) return;
            // Mirror → Desktop
            mirror.addEventListener('change', () => {
                target.checked = mirror.checked;
                target.dispatchEvent(new Event('change'));
            });
            // Desktop → Mirror (keep in sync)
            target.addEventListener('change', () => {
                mirror.checked = target.checked;
            });
        });

        // Mobile signals grid toggle-text click
        document.querySelectorAll('.mobile-signals-grid .toggle-text').forEach(label => {
            const cb = label.closest('.toggle-group').querySelector('input[type=checkbox]');
            if (cb) {
                label.addEventListener('click', () => {
                    cb.checked = !cb.checked;
                    cb.dispatchEvent(new Event('change'));
                });
                cb.addEventListener('change', () => {
                    label.classList.toggle('active', cb.checked);
                });
            }
        });

        // Signal type constants
        const BULLISH_SIGNALS = [
            'strong_bullish', 'accumulation', 'test_support', 'climax_bottom', 
            'weak_down', 'no_supply', 'pin_bar_bull', 'confirmed_reversal_up'
        ];
        const BEARISH_SIGNALS = [
            'strong_bearish', 'distribution', 'test_resistance', 'climax_top', 
            'no_demand', 'pin_bar_bear', 'confirmed_reversal_down'
        ];

        // Classify a VPA signal to BUY / SELL / HOLD
        function classifySignal(signalName) {
            if (BULLISH_SIGNALS.includes(signalName)) return 'BUY';
            if (BEARISH_SIGNALS.includes(signalName)) return 'SELL';
            return 'HOLD';
        }

        // Build deduplicated BUY/SELL/HOLD transition markers from VPA signals
        function buildActionMarkers(signals) {
            if (!signals || signals.length === 0) return [];
            // Sort chronologically
            const sorted = [...signals].sort((a, b) => {
                return new Date(a.datetime.replace(' ', 'T') + 'Z') - new Date(b.datetime.replace(' ', 'T') + 'Z');
            });
            const markers = [];
            let prevAction = null;
            for (const sig of sorted) {
                const action = classifySignal(sig.signal);
                if (action !== prevAction) {
                    const isBuy = action === 'BUY';
                    const isSell = action === 'SELL';
                    const confPct = sig.confidence ? Math.round(sig.confidence * 100) : null;
                    const label = confPct !== null ? `${action} ${confPct}%` : action;
                    markers.push({
                        time: toEasternUnix(sig.datetime),
                        position: isBuy ? 'belowBar' : 'aboveBar',
                        color: isBuy ? '#00e676' : isSell ? '#ff1744' : 'rgba(255,176,60,0.30)',
                        shape: isBuy ? 'arrowUp' : isSell ? 'arrowDown' : 'circle',
                        text: label,
                    });
                    prevAction = action;
                }
            }
            return markers;
        }
        
        // Default watchlist symbols with metadata
        const defaultWatchlist = [
            { symbol: 'QQQ', name: 'Nasdaq 100 ETF' },
            { symbol: 'SPY', name: 'S&P 500 ETF' },
            { symbol: 'IWM', name: 'Russell 2000 ETF' },
            { symbol: 'AAPL', name: 'Apple Inc' },
            { symbol: 'MSFT', name: 'Microsoft Corp' },
            { symbol: 'NVDA', name: 'NVIDIA Corp' },
            { symbol: 'TSLA', name: 'Tesla Inc' },
            { symbol: 'AMD', name: 'AMD Inc' },
            { symbol: 'AMZN', name: 'Amazon.com' },
            { symbol: 'META', name: 'Meta Platforms' },
            { symbol: 'GOOGL', name: 'Alphabet Inc' }
        ];

        // ===== AUTH HELPER =====
        async function authFetch(url, options) {
            const res = await fetch(url, options);
            if (res.status === 401) {
                window.location.href = '/login';
                throw new Error('Session expired');
            }
            return res;
        }

        // ===== MOBILE FUNCTIONS =====
        function isMobile() {
            // Check for portrait mobile or landscape mobile
            return window.innerWidth <= MOBILE_MAX_WIDTH || 
                   (window.innerWidth <= LANDSCAPE_MAX_WIDTH && window.innerHeight <= LANDSCAPE_MAX_HEIGHT);
        }

        function openWatchlist() {
            if (isMobile()) {
                closeAnalysis();
                collapseControls();
                const sidebar = document.getElementById('watchlist-sidebar');
                sidebar.classList.remove('collapsed');
                sidebar.classList.add('mobile-open');
                document.getElementById('backdrop').classList.add('active');
                document.getElementById('mobile-action-banner').classList.remove('visible');
            }
        }

        function closeWatchlist() {
            if (isMobile()) {
                document.getElementById('watchlist-sidebar').classList.remove('mobile-open');
                document.getElementById('backdrop').classList.remove('active');
                if (lastCompositeResult) {
                    document.getElementById('mobile-action-banner').classList.add('visible');
                }
                setActiveNav('nav-chart');
            }
        }

        // ===== MOBILE NAV HELPERS =====
        function setActiveNav(id) {
            document.querySelectorAll('.mobile-nav-item').forEach(btn => btn.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
        }

        function updateMobileActionBanner(comp) {
            if (!comp || !comp.action) return;
            const banner = document.getElementById('mobile-action-banner');
            const action = comp.action.toUpperCase();
            let cls = 'hold';
            if (action.includes('BUY')) cls = 'buy';
            else if (action.includes('SELL')) cls = 'sell';
            banner.className = `mobile-action-banner ${cls}`;
            document.getElementById('mob-action-label').textContent = action;
            const pct = Math.round(comp.confidence * 100);
            document.getElementById('mob-action-score').textContent = `${comp.score > 0 ? '+' : ''}${comp.score.toFixed(3)} (${pct}%)`;
            document.getElementById('mob-action-signal').textContent = comp.signal.replace(/_/g, ' ');
            // Show banner if analysis panel is not open
            if (!document.getElementById('analysis-sidebar').classList.contains('mobile-open')) {
                banner.classList.add('visible');
            }
            // Light up nav badge
            const badge = document.getElementById('nav-analysis-badge');
            if (badge) {
                badge.style.background = cls === 'buy' ? '#26a69a' : cls === 'sell' ? '#ef5350' : '#787b86';
                badge.classList.add('visible');
            }
        }

        function toggleWatchlist() {
            const sidebar = document.getElementById('watchlist-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeWatchlist();
            } else {
                openWatchlist();
                // Close analysis if open
                closeAnalysis();
            }
        }

        function openAnalysis() {
            if (isMobile()) {
                closeWatchlist();
                collapseControls();
                document.getElementById('analysis-sidebar').classList.add('mobile-open');
                document.getElementById('backdrop').classList.add('active');
                document.getElementById('signal-peek').classList.remove('visible');
                document.getElementById('mobile-action-banner').classList.remove('visible');
            }
        }

        function closeAnalysis() {
            if (isMobile()) {
                document.getElementById('analysis-sidebar').classList.remove('mobile-open');
                document.getElementById('backdrop').classList.remove('active');
                // Show signal peek when analysis closes (if data exists)
                if (latestSignalData) {
                    document.getElementById('signal-peek').classList.add('visible');
                }
                // Show action banner if we have composite data
                if (lastCompositeResult) {
                    document.getElementById('mobile-action-banner').classList.add('visible');
                }
                setActiveNav('nav-chart');
            }
        }

        function toggleAnalysis() {
            const sidebar = document.getElementById('analysis-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeAnalysis();
            } else {
                openAnalysis();
                // Close watchlist if open
                closeWatchlist();
            }
        }

        function closeAllMobilePanels() {
            closeWatchlist();
            closeAnalysis();
            collapseControls();
        }

        function handleResize() {
            // Handle mobile controls visibility and state
            if (isMobile()) {
                // Cache DOM references
                const controlsSummary = document.getElementById('controls-summary');
                
                // Ensure controls-summary is active on mobile
                if (controlsSummary && !controlsSummary.classList.contains('active')) {
                    controlsSummary.classList.add('active');
                    collapseControls();
                }
            } else {
                // Reset mobile panels when switching to desktop
                closeAllMobilePanels();
                
                // Cache DOM references
                const controlsSummary = document.getElementById('controls-summary');
                const controlsBar = document.getElementById('controls-bar');
                
                // Reset controls state on desktop
                if (controlsSummary && controlsBar && controlsSummary.classList.contains('active')) {
                    controlsSummary.classList.remove('active');
                    controlsBar.classList.remove('collapsed');
                    controlsCollapsed = false;
                }
            }
            // Trigger chart resize
            if (priceChart && volumeChart) {
                setTimeout(() => {
                    priceChart.resize(
                        document.getElementById('price-chart').clientWidth,
                        document.getElementById('price-chart').clientHeight
                    );
                    if (stockChart) {
                        stockChart.resize(
                            document.getElementById('stock-chart').clientWidth,
                            document.getElementById('stock-chart').clientHeight
                        );
                    }
                    volumeChart.resize(
                        document.getElementById('volume-chart').clientWidth,
                        document.getElementById('volume-chart').clientHeight
                    );
                }, 100);
            }
        }
        
        // ===== CONTROLS COLLAPSE FUNCTIONS =====
        function collapseControls() {
            if (isMobile()) {
                document.getElementById('settings-sheet').classList.remove('open');
                // Restore action banner if it was visible
                const banner = document.getElementById('mobile-action-banner');
                if (banner && lastCompositeResult) banner.classList.add('visible');
                controlsCollapsed = true;
            }
        }
        
        function expandControls() {
            if (isMobile()) {
                closeWatchlist();
                closeAnalysis();
                document.getElementById('settings-sheet').classList.add('open');
                const banner = document.getElementById('mobile-action-banner');
                if (banner) banner.classList.remove('visible');
                controlsCollapsed = false;
            }
        }
        
        function toggleControls() {
            if (controlsCollapsed) {
                expandControls();
            } else {
                collapseControls();
            }
        }
        
        function updateSummaryText() {
            const symbol = currentSymbol;
            const strike = document.getElementById('strike').value;
            const right = document.getElementById('right').value;
            const intervalText = currentInterval === 1 ? '1m' : currentInterval === 5 ? '5m' : currentInterval === 15 ? '15m' : '1H';
            
            if (strike) {
                const rightText = right === 'C' ? 'C' : 'P';
                document.getElementById('summary-text').textContent = `${symbol} $${strike}${rightText} ${intervalText}`;
            }
        }
        
        // ===== SIGNAL PEEK FUNCTIONS =====
        function updateSignalPeek(signals) {
            if (!signals || signals.length === 0) {
                latestSignalData = null;
                document.getElementById('signal-peek').classList.remove('visible');
                return;
            }
            
            const latestSignal = signals[signals.length - 1];
            latestSignalData = latestSignal;
            
            const isBullish = BULLISH_SIGNALS.includes(latestSignal.signal);
            
            const peek = document.getElementById('signal-peek');
            peek.className = `signal-peek ${isBullish ? '' : 'bearish'}`;
            
            document.getElementById('signal-peek-name').textContent = latestSignal.signal.replace(/_/g, ' ').toUpperCase();
            document.getElementById('signal-peek-description').textContent = latestSignal.description || '';
            document.getElementById('signal-peek-confidence').textContent = `${Math.round(latestSignal.confidence * 100)}%`;
            document.getElementById('signal-peek-time').textContent = new Date(latestSignal.datetime).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            document.getElementById('signal-peek-price').textContent = `$${latestSignal.price.toFixed(2)}`;
            
            // Update badge
            const badge = document.getElementById('signal-peek-badge');
            badge.textContent = isBullish ? 'BULLISH' : 'BEARISH';
            badge.className = `signal-peek-badge ${isBullish ? 'bullish' : 'bearish'}`;
            
            // Only show if analysis sidebar is not open
            if (isMobile() && !document.getElementById('analysis-sidebar').classList.contains('mobile-open')) {
                peek.classList.add('visible');
            }
        }
        
        // ===== LIVE MODE FUNCTIONS =====
        function updateLiveButton() {
            const desktopBtn = document.getElementById('live-btn');
            const summaryBtn = document.getElementById('summary-live-btn');
            const mobileBadge = document.getElementById('mobile-live-badge');
            
            if (liveMode) {
                const prefix = mockMode ? '🟡 MOCK ' : '🔴 LIVE ';
                const dot = liveWs && liveWs.readyState === WebSocket.OPEN ? '●' : '○';
                const text = `${prefix}${dot}`;
                desktopBtn.textContent = text;
                if (summaryBtn) {
                    summaryBtn.textContent = `LIVE ${dot}`;
                    summaryBtn.classList.add('active');
                }
                if (mobileBadge) {
                    if (mockMode) {
                        mobileBadge.textContent = `MOCK ${dot}`;
                        mobileBadge.classList.add('mock-active');
                        mobileBadge.classList.remove('active');
                    } else {
                        mobileBadge.textContent = `LIVE ${dot}`;
                        mobileBadge.classList.add('active');
                        mobileBadge.classList.remove('mock-active');
                    }
                }
            } else {
                desktopBtn.textContent = '⚪ LIVE';
                if (summaryBtn) {
                    summaryBtn.textContent = 'LIVE';
                    summaryBtn.classList.remove('active');
                }
                if (mobileBadge) {
                    mobileBadge.textContent = 'LIVE';
                    mobileBadge.classList.remove('active');
                    mobileBadge.classList.remove('mock-active');
                }
            }
        }

        // Build OCC-format option ticker: O:SPY251219C00650000
        function formatOptionTicker(symbol, expiration, strike, right) {
            const d = new Date(expiration + 'T00:00:00');
            const yy = String(d.getFullYear()).slice(2);
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const strikeInt = Math.round(strike * 1000);
            const strikePad = String(strikeInt).padStart(8, '0');
            return `O:${symbol.toUpperCase()}${yy}${mm}${dd}${right.toUpperCase()}${strikePad}`;
        }

        // Connect to the live WebSocket feed
        function connectLiveWs() {
            if (liveWs && (liveWs.readyState === WebSocket.OPEN || liveWs.readyState === WebSocket.CONNECTING)) {
                return;  // already connected
            }

            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const url = `${proto}//${location.host}/ws/live`;
            console.log('[LiveWS] Connecting to', url);

            liveWs = new WebSocket(url);

            const thisWs = liveWs;   // capture ref for onclose guard

            liveWs.onopen = () => {
                console.log('[LiveWS] Connected');
                updateLiveButton();

                // If we already have a pending subscription, send it now
                if (liveWsTicker) {
                    const subMsg = { action: 'subscribe', ticker: liveWsTicker, mock: mockMode };
                    if (mockMode) subMsg.interval = currentInterval;
                    liveWs.send(JSON.stringify(subMsg));
                    console.log('[LiveWS] Subscribed to', liveWsTicker, mockMode ? '(mock)' : '');
                }
            };

            liveWs.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleLiveMessage(msg);
                } catch (e) {
                    console.warn('[LiveWS] Bad message:', e);
                }
            };

            liveWs.onclose = (event) => {
                console.log('[LiveWS] Disconnected, code:', event.code);
                updateLiveButton();

                // Auto-reconnect only if still in live mode AND this is the current WS
                if (liveMode && liveWs === thisWs) {
                    setTimeout(() => {
                        console.log('[LiveWS] Reconnecting...');
                        connectLiveWs();
                    }, 2000);
                }
            };

            liveWs.onerror = (err) => {
                console.error('[LiveWS] Error:', err);
            };
        }

        // Handle incoming WebSocket messages
        function handleLiveMessage(msg) {
            const type = msg.type;

            if (type === 'sow') {
                // Snapshot of world — initial bars on subscribe
                const bars = msg.bars || [];
                if (bars.length > 0) {
                    console.log(`[LiveWS] SOW: ${bars.length} bars for ${msg.ticker}`);

                    // Update chart with SOW bars incrementally 
                    window._chartDataLoading = true;
                    for (const bar of bars) {
                        const t = toEasternUnix(bar.datetime);
                        candlestickSeries.update({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                        volumeSeries.update({ time: t, value: bar.volume, color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)' });
                    }
                    window._chartDataLoading = false;

                    // Append to analysis data
                    if (lastAnalysisData) {
                        lastAnalysisData.bars = lastAnalysisData.bars.concat(bars);
                    }

                    // Update price header from last SOW bar
                    const lastBar = bars[bars.length - 1];
                    const firstBar = bars[0];
                    document.getElementById('contract-price').textContent = `$${lastBar.close.toFixed(2)}`;
                    document.getElementById('stat-bars').textContent = lastAnalysisData ? lastAnalysisData.bars.length : bars.length;

                    // ── Mock-mode: update contract header & date range ──
                    if (msg.mock && msg.ticker) {
                        // Parse OCC ticker: O:QQQ260213C00601000
                        const occRaw = msg.ticker.replace('O:', '');
                        const occMatch = occRaw.match(/^([A-Z]+)(\d{6})([CP])(\d{8})$/);
                        if (occMatch) {
                            const sym = occMatch[1];
                            const dtStr = occMatch[2]; // YYMMDD
                            const right = occMatch[3];
                            const strike = parseInt(occMatch[4]) / 1000;
                            const expStr = `20${dtStr.slice(0,2)}-${dtStr.slice(2,4)}-${dtStr.slice(4,6)}`;
                            const rightLabel = right === 'C' ? 'Call' : 'Put';

                            document.getElementById('contract-symbol').textContent = `${sym} $${strike} ${rightLabel}`;
                            document.getElementById('contract-details').textContent = `Exp: ${expStr} (MOCK ${msg.interval || currentInterval}m)`;
                        }

                        // Show price change from mock data
                        const change = lastBar.close - firstBar.open;
                        const changePct = firstBar.open !== 0 ? (change / firstBar.open * 100) : 0;
                        document.getElementById('contract-change').textContent = 
                            `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%)`;
                        document.getElementById('contract-change').className = 
                            `contract-change ${change >= 0 ? 'positive' : 'negative'}`;

                        // Update date inputs to reflect mock data range
                        if (msg.first_dt) {
                            const mockStartDate = msg.first_dt.split(' ')[0];
                            document.getElementById('start-date').value = mockStartDate;
                        }
                        if (msg.last_dt) {
                            const mockEndDate = msg.last_dt.split(' ')[0];
                            document.getElementById('end-date').value = mockEndDate;
                        }
                    }
                }

            } else if (type === 'bar') {
                // Real-time bar update
                const bar = msg.bar;
                const signals = msg.signals || [];

                if (!bar) return;

                const ticker = msg.ticker || '';

                // Log every 10th bar to avoid console spam
                if (!window._liveBarCount) window._liveBarCount = 0;
                window._liveBarCount++;
                if (window._liveBarCount <= 3 || window._liveBarCount % 10 === 0) {
                    console.log(`[LiveWS] bar #${window._liveBarCount}: ${ticker} close=${bar.close} vol=${bar.volume}`);
                }

                // ── Underlying stock overlay update ──
                if (ticker === liveUnderlyingTicker && liveMode && underlaySeries) {
                    const t = toEasternUnix(bar.datetime);
                    if (underlayMode === 'line') {
                        underlaySeries.update({ time: t, value: bar.close });
                    } else if (underlayMode === 'candle') {
                        underlaySeries.update({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                    }
                    // Also keep underlayBarsData in sync for mode switches
                    underlayBarsData.push({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                    return; // underlying bars don't update the main chart
                }

                // ── Option contract bar update ──
                const chartsContainer = document.querySelector('.charts-container');
                chartsContainer.classList.add('live-refreshing');

                // Update chart
                const t = toEasternUnix(bar.datetime);
                window._chartDataLoading = true;
                candlestickSeries.update({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                volumeSeries.update({ time: t, value: bar.volume, color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)' });
                window._chartDataLoading = false;

                // Track for delta state
                lastBarDatetime = bar.datetime;

                // Append to analysis data
                if (lastAnalysisData) {
                    lastAnalysisData.bars.push(bar);
                    if (signals.length > 0) {
                        lastAnalysisData.signals = (lastAnalysisData.signals || []).concat(signals);
                    }
                }

                // Update contract header price
                document.getElementById('contract-price').textContent = `$${bar.close.toFixed(2)}`;

                // Update markers if new signals
                if (signals.length > 0) {
                    updateFilteredMarkers(lastAnalysisData ? lastAnalysisData.signals : signals);
                    updateAnalysis(lastAnalysisData || { bars: [bar], signals: signals, bias: {} });
                }

                // Update stats
                document.getElementById('stat-bars').textContent = lastAnalysisData ? lastAnalysisData.bars.length : 1;

                setTimeout(() => chartsContainer.classList.remove('live-refreshing'), 200);

            } else if (type === 'analysis') {
                // Server-pushed full re-analysis (composite, greeks, bias, signals)
                console.log('[LiveWS] Analysis update received');

                // Update composite gauge + greeks panel
                if (msg.composite) {
                    const newAction = msg.composite.action;
                    if (lastCompositeAction !== null && newAction !== lastCompositeAction) {
                        showSignalToast(lastCompositeAction, newAction, msg.composite);
                    }
                    lastCompositeAction = newAction;
                    updateComposite(msg.composite);
                }

                // Update bias indicator
                if (msg.bias && msg.bias.bias) {
                    const biasContainer = document.getElementById('bias-container');
                    biasContainer.className = `bias-indicator ${msg.bias.bias}`;
                    biasContainer.innerHTML = `
                        <div class="bias-label">${msg.bias.bias}</div>
                        <div class="bias-strength">Strength: ${Math.round((msg.bias.strength || 0) * 100)}%</div>
                        <div class="bias-reason">${msg.bias.reason || ''}</div>
                    `;
                }

                // Update signal stats from full history
                if (msg.all_signals) {
                    const allSig = msg.all_signals;
                    const BULLISH = ['strong_bullish','accumulation','test_support','no_supply','pin_bar_bull'];
                    const BEARISH = ['strong_bearish','distribution','test_resistance','no_demand','pin_bar_bear'];
                    document.getElementById('stat-signals').textContent = allSig.length;
                    document.getElementById('stat-bullish').textContent = allSig.filter(s => BULLISH.includes(s.signal)).length;
                    document.getElementById('stat-bearish').textContent = allSig.filter(s => BEARISH.includes(s.signal)).length;

                    // Also update markers on chart with full signal set
                    if (lastAnalysisData) {
                        lastAnalysisData.signals = allSig;
                        updateFilteredMarkers(allSig);
                    }
                }

                if (msg.total_bars) {
                    document.getElementById('stat-bars').textContent = msg.total_bars;
                }

                // Update contract price from latest bar close
                if (msg.last_price) {
                    document.getElementById('contract-price').textContent = `$${msg.last_price.toFixed(2)}`;
                }

            } else if (type === 'subscribed') {
                console.log('[LiveWS] Confirmed subscription:', msg.ticker);

            } else if (type === 'unsubscribed') {
                console.log('[LiveWS] Confirmed unsubscription:', msg.ticker);

            } else if (type === 'status') {
                console.log('[LiveWS] Feed status:', msg);

            } else if (type === 'error') {
                console.warn('[LiveWS] Error:', msg.message);

                // Connection-limit or auth errors → show modal, revert live mode
                if (msg.code === 'conn_limit' || msg.code === 'auth_failed') {
                    const modal = document.getElementById('conn-limit-modal');
                    const msgEl = document.getElementById('conn-limit-msg');
                    if (msg.code === 'conn_limit') {
                        msgEl.textContent = 'Polygon\u2019s WebSocket connection limit has been exceeded. The server is backing off and will retry automatically. Please wait ~30 seconds before trying live mode again.';
                    } else {
                        msgEl.textContent = msg.message || 'Authentication failed. Your Polygon plan may not support live WebSocket streaming.';
                    }
                    modal.classList.add('active');

                    // Auto-revert live mode so user isn't stuck
                    stopLiveMode();
                }
            }
        }

        // ===== WATCHLIST WEBSOCKET (dedicated price streaming) =====

        function connectWatchlistWs() {
            if (watchlistWs && (watchlistWs.readyState === WebSocket.OPEN || watchlistWs.readyState === WebSocket.CONNECTING)) {
                return;
            }

            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const url = `${proto}//${location.host}/ws/watchlist`;
            console.log('[WatchlistWS] Connecting to', url);

            watchlistWs = new WebSocket(url);

            watchlistWs.onopen = () => {
                console.log('[WatchlistWS] Connected');
                sendWatchlistSymbols();
            };

            watchlistWs.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleWatchlistMessage(msg);
                } catch (e) {
                    console.warn('[WatchlistWS] Bad message:', e);
                }
            };

            watchlistWs.onclose = (event) => {
                console.log('[WatchlistWS] Disconnected, code:', event.code);
                if (watchlistWsReconnectTimer) clearTimeout(watchlistWsReconnectTimer);
                watchlistWsReconnectTimer = setTimeout(() => {
                    console.log('[WatchlistWS] Reconnecting...');
                    connectWatchlistWs();
                }, 3000);
            };

            watchlistWs.onerror = (err) => {
                console.error('[WatchlistWS] Error:', err);
            };
        }

        function sendWatchlistSymbols() {
            if (!watchlistWs || watchlistWs.readyState !== WebSocket.OPEN) return;
            const symbols = defaultWatchlist.map(w => w.symbol);
            // Always use real API for stock prices (mock mode only affects option WS feed)
            watchlistWs.send(JSON.stringify({ symbols: symbols, mock: false }));
            console.log('[WatchlistWS] Sent', symbols.length, 'symbols (always real prices)');
        }

        function handleWatchlistMessage(msg) {
            const type = msg.type;

            if (type === 'prices') {
                const prices = msg.prices || [];
                for (const price of prices) {
                    const prevPrice = watchlistData[price.symbol]?.price;
                    watchlistData[price.symbol] = {
                        ...price,
                        prevPrice: prevPrice || price.price,
                        direction: prevPrice ? (price.price > prevPrice ? 'up' : price.price < prevPrice ? 'down' : null) : null,
                    };
                }
                renderWatchlist();
                // Update the mobile header underlying price ticker
                updateMobileUnderlyingPrice();

            } else if (type === 'subscribed') {
                console.log('[WatchlistWS] Subscribed:', msg.symbols?.join(', '));
            } else if (type === 'error') {
                console.warn('[WatchlistWS] Error:', msg.message);
            }
        }

        /**
         * Update the mobile header with the currently selected symbol's underlying price.
         * Ticks green/red on price changes.
         */
        function updateMobileUnderlyingPrice() {
            const symEl = document.getElementById('mobile-underlying-symbol');
            const priceEl = document.getElementById('mobile-underlying-price');
            if (!symEl || !priceEl) return;

            symEl.textContent = currentSymbol;
            const data = watchlistData[currentSymbol];
            if (data && data.price != null) {
                priceEl.textContent = `$${data.price.toFixed(2)}`;
                // Flash tick color
                priceEl.classList.remove('tick-up', 'tick-down');
                if (data.direction === 'up') {
                    priceEl.classList.add('tick-up');
                } else if (data.direction === 'down') {
                    priceEl.classList.add('tick-down');
                }
                // Remove tick class after animation
                setTimeout(() => priceEl.classList.remove('tick-up', 'tick-down'), 1000);
            }
        }

        /**
         * Subscribe to the underlying stock for live chart overlay.
         * Uses liveWs (the options feed WS) for real-time bar streaming of the underlying.
         */
        function subscribeUnderlyingLive(symbol) {
            if (liveUnderlyingTicker === symbol) return;

            // Unsubscribe previous underlying
            if (liveUnderlyingTicker) {
                if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                    liveWs.send(JSON.stringify({ action: 'unsubscribe', ticker: liveUnderlyingTicker }));
                }
            }

            liveUnderlyingTicker = symbol;

            // Subscribe via the live options WS (always real for stock data)
            if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                liveWs.send(JSON.stringify({ action: 'subscribe', ticker: symbol, mock: false }));
                console.log(`[LiveWS] Subscribed to underlying: ${symbol} (always real)`);
            }
        }

        function unsubscribeUnderlyingLive() {
            if (!liveUnderlyingTicker) return;

            if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                liveWs.send(JSON.stringify({ action: 'unsubscribe', ticker: liveUnderlyingTicker }));
            }
            liveUnderlyingTicker = null;
        }

        // Live-mode poll: FALLBACK for mock mode (WebSocket not used for mock)
        async function livePoll() {
            const expiration = document.getElementById('expiration').value;
            const strike = document.getElementById('strike').value;
            const right = document.getElementById('right').value;

            if (!currentSymbol || !expiration || !strike) return;

            const chartsContainer = document.querySelector('.charts-container');
            chartsContainer.classList.add('live-refreshing');

            try {
                let url = `/api/analyze/live?symbol=${currentSymbol}&expiration=${expiration}&strike=${strike}&right=${right}`;
                // mock param not needed – live poll always uses real API
                if (lastBarDatetime) url += `&after=${encodeURIComponent(lastBarDatetime)}`;

                const res = await authFetch(url);
                if (!res.ok) return;
                const data = await res.json();

                const newBars = data.bars || [];
                const newSignals = data.signals || [];

                if (newBars.length === 0) return;

                lastBarDatetime = newBars[newBars.length - 1].datetime;

                window._chartDataLoading = true;
                for (const bar of newBars) {
                    const t = toEasternUnix(bar.datetime);
                    candlestickSeries.update({ time: t, open: bar.open, high: bar.high, low: bar.low, close: bar.close });
                    volumeSeries.update({ time: t, value: bar.volume, color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)' });
                }
                window._chartDataLoading = false;

                if (lastAnalysisData) {
                    lastAnalysisData.bars = lastAnalysisData.bars.concat(newBars);
                    lastAnalysisData.signals = (lastAnalysisData.signals || []).concat(newSignals);
                }

                const lastBar = newBars[newBars.length - 1];
                document.getElementById('contract-price').textContent = `$${lastBar.close.toFixed(2)}`;

                if (newSignals.length > 0) {
                    updateFilteredMarkers(lastAnalysisData ? lastAnalysisData.signals : newSignals);
                    updateAnalysis(lastAnalysisData || { bars: newBars, signals: newSignals, bias: {} });
                }

                document.getElementById('stat-bars').textContent = lastAnalysisData ? lastAnalysisData.bars.length : newBars.length;

            } catch (e) {
                console.warn('Live poll error:', e.message);
            } finally {
                chartsContainer.classList.remove('live-refreshing');
                const interval = mockMode ? 1 : 10;
                liveCountdown = interval;
                updateLiveButton();
            }
        }
        
        function toggleLiveMode() {
            if (liveMode) {
                stopLiveMode();
            } else {
                const expiration = document.getElementById('expiration').value;
                const strike = document.getElementById('strike').value;
                const right = document.getElementById('right').value;

                if (!currentSymbol || !expiration || !strike) {
                    alert('Select a contract before going live');
                    return;
                }

                // Start live mode
                liveMode = true;
                
                // Add active class to button
                document.getElementById('live-btn').classList.add('active');
                document.getElementById('summary-live-btn').classList.add('active');
                document.getElementById('summary-live-btn').textContent = 'LIVE ●';
                
                // Track the last bar we already have for delta updates
                if (lastAnalysisData && lastAnalysisData.bars && lastAnalysisData.bars.length > 0) {
                    lastBarDatetime = lastAnalysisData.bars[lastAnalysisData.bars.length - 1].datetime;
                } else {
                    lastBarDatetime = null;
                }

                if (mockMode) {
                    // Mock mode: connect WS and let the SOW (snapshot) populate the chart
                    liveWsTicker = formatOptionTicker(currentSymbol, expiration, parseFloat(strike), right);
                    console.log('[LiveWS] Will subscribe (MOCK) to:', liveWsTicker);

                    // Clear chart + underlay so mock SOW starts clean
                    if (candlestickSeries) candlestickSeries.setData([]);
                    if (volumeSeries) volumeSeries.setData([]);
                    removeUnderlay();
                    underlayBarsData = [];
                    lastAnalysisData = { bars: [], signals: [], bias: {}, composite: {} };
                    window._liveBarCount = 0;

                    // Auto-analyze to populate composite/greeks panels (real API)
                    analyze().catch(() => {});

                    // Start mock WS immediately — backend sends SOW then live bars
                    connectLiveWs();
                    if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                        liveWs.send(JSON.stringify({ action: 'subscribe', ticker: liveWsTicker, mock: true, interval: currentInterval }));
                    }
                    // Subscribe to underlying stock for live overlay chart
                    subscribeUnderlyingLive(currentSymbol);
                    updateLiveButton();
                } else {
                    // Real mode: use WebSocket for live per-second agg feed
                    liveWsTicker = formatOptionTicker(currentSymbol, expiration, parseFloat(strike), right);
                    console.log('[LiveWS] Will subscribe to:', liveWsTicker);
                    
                    connectLiveWs();

                    // If already connected, subscribe now
                    if (liveWs && liveWs.readyState === WebSocket.OPEN) {
                        liveWs.send(JSON.stringify({ action: 'subscribe', ticker: liveWsTicker, mock: false }));
                    }
                    // Otherwise, onopen handler will send the subscribe

                    // Also subscribe to underlying stock for live overlay chart
                    subscribeUnderlyingLive(currentSymbol);
                    
                    updateLiveButton();
                }
            }
        }
        
        function stopLiveMode() {
            if (liveMode) {
                liveMode = false;
                lastBarDatetime = null;
                lastCompositeAction = null;
                lastVpaAction = null;
                
                // Clear polling intervals (mock mode)
                if (liveInterval) {
                    clearInterval(liveInterval);
                    liveInterval = null;
                }
                if (liveCountdownInterval) {
                    clearInterval(liveCountdownInterval);
                    liveCountdownInterval = null;
                }
                // Unsubscribe from WebSocket feed
                if (liveWs && liveWs.readyState === WebSocket.OPEN && liveWsTicker) {
                    liveWs.send(JSON.stringify({ action: 'unsubscribe', ticker: liveWsTicker }));
                    console.log('[LiveWS] Unsubscribed from', liveWsTicker);
                }
                liveWsTicker = null;

                // Unsubscribe from underlying stock overlay
                unsubscribeUnderlyingLive();

                // Close WebSocket after a short delay (let unsub message send)
                if (liveWs) {
                    const ws = liveWs;
                    liveWs = null;
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.OPEN) ws.close();
                    }, 500);
                }
                
                // Remove active class from button
                document.getElementById('live-btn').classList.remove('active');
                document.getElementById('summary-live-btn').classList.remove('active');
                document.getElementById('summary-live-btn').textContent = 'LIVE';
                
                updateLiveButton();
            }
        }
        
        // ===== WATCHLIST FUNCTIONS =====
        async function loadWatchlistPrices() {
            try {
                const symbols = defaultWatchlist.map(w => w.symbol).join(',');
                let url = `/api/watchlist/prices?symbols=${symbols}`;
                // Always use real API for stock prices (mock mode only affects option WS feed)
                const res = await authFetch(url);
                if (!res.ok) throw new Error('Failed to fetch prices');
                
                const data = await res.json();
                data.prices.forEach(price => {
                    const prevPrice = watchlistData[price.symbol]?.price;
                    watchlistData[price.symbol] = {
                        ...price,
                        prevPrice: prevPrice || price.price,
                        direction: prevPrice ? (price.price > prevPrice ? 'up' : price.price < prevPrice ? 'down' : null) : null
                    };
                });
                
                renderWatchlist();
            } catch (e) {
                console.error('Error loading watchlist:', e);
            }
        }
        
        function renderWatchlist() {
            const container = document.getElementById('watchlist-container');
            const searchTerm = document.getElementById('watchlist-search').value.toLowerCase();
            
            const filteredList = defaultWatchlist.filter(item => 
                item.symbol.toLowerCase().includes(searchTerm) ||
                item.name.toLowerCase().includes(searchTerm)
            );
            
            container.innerHTML = filteredList.map(item => {
                const data = watchlistData[item.symbol] || {};
                const isSelected = item.symbol === currentSymbol;
                const changeClass = data.changePct >= 0 ? 'positive' : 'negative';
                const changeSign = data.changePct >= 0 ? '+' : '';
                const priceClass = data.direction === 'up' ? 'price-up' : data.direction === 'down' ? 'price-down' : '';
                const flashClass = data.direction ? 'price-flash' : '';
                
                return `
                    <div class="watchlist-item ${isSelected ? 'selected' : ''}" data-symbol="${item.symbol}">
                        <div class="watchlist-item-info">
                            <div class="watchlist-symbol">${item.symbol}</div>
                            <div class="watchlist-name">${item.name}</div>
                        </div>
                        <div class="watchlist-price-info">
                            <div class="watchlist-price ${priceClass} ${flashClass}">${data.price != null ? data.price.toFixed(2) : '-'}</div>
                            <div class="watchlist-change ${changeClass}">${data.changePct != null ? `${changeSign}${data.changePct.toFixed(2)}%` : '-'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            container.querySelectorAll('.watchlist-item').forEach(item => {
                item.addEventListener('click', () => selectSymbol(item.dataset.symbol));
            });
            
            // Clear direction flags after render
            Object.keys(watchlistData).forEach(sym => {
                watchlistData[sym].direction = null;
            });
        }
        
        function selectSymbol(symbol) {
            currentSymbol = symbol;
            renderWatchlist();
            updateUrlParams();
            loadExpirations(symbol, true);  // autoAnalyze=true
            
            // Update mobile underlying price header
            updateMobileUnderlyingPrice();
            
            // Stop live mode when symbol changes
            stopLiveMode();

            // Clear idea price badge when manually selecting a symbol
            activeIdeaPrice = null;
            const badge = document.getElementById('idea-price-badge');
            if (badge) badge.classList.remove('visible');
            
            // Update contract info
            const data = watchlistData[symbol] || {};
            document.getElementById('contract-symbol').textContent = symbol;
            document.getElementById('contract-details').textContent = 'Loading...';
            
            // Auto-close watchlist on mobile when symbol is selected
            if (isMobile()) {
                closeWatchlist();
            }
        }
        
        // ===== EXPIRATIONS & STRIKES =====
        let cachedExpirations = []; // Store raw exp dates for calendar
        async function loadExpirations(symbol, autoAnalyze = false) {
            const select = document.getElementById('expiration');
            select.innerHTML = '<option value="">Loading...</option>';
            cachedExpirations = [];
            
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const res = await authFetch(`/api/expirations/${symbol}`);
                    if (res.status === 429) {
                        select.innerHTML = '<option value="">Rate limited, retrying...</option>';
                        await new Promise(r => setTimeout(r, (attempt + 1) * 5000));
                        continue;
                    }
                    if (!res.ok) throw new Error('Failed to load');
                    
                    const data = await res.json();
                    const today = new Date();
                    cachedExpirations = data.expirations || [];
                    
                    select.innerHTML = data.expirations.map(exp => {
                        const expDate = new Date(exp + 'T00:00:00');
                        const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                        const label = diffDays === 0 ? '0DTE' : diffDays === 1 ? '1DTE' : `${diffDays}d`;
                        const dateStr = expDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        return `<option value="${exp}">${dateStr} (${label})</option>`;
                    }).join('');
                    
                    if (data.expirations.length > 0) {
                        await loadStrikes(symbol, data.expirations[0], autoAnalyze);
                    }
                    // Init mobile calendar picker
                    if (isMobile()) {
                        initExpCalendar();
                    }
                    return;  // success
                } catch (e) {
                    if (attempt === maxRetries - 1) {
                        select.innerHTML = '<option value="">Error loading</option>';
                        // Show retry button next to expiration dropdown
                        showRetryButton(symbol);
                    }
                }
            }
        }

        function showRetryButton(symbol) {
            // Remove existing retry button if any
            const existing = document.getElementById('retry-exp-btn');
            if (existing) existing.remove();

            const btn = document.createElement('button');
            btn.id = 'retry-exp-btn';
            btn.textContent = '↻ Retry';
            btn.style.cssText = 'margin-left:6px;padding:4px 10px;background:#2962ff;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px;';
            btn.addEventListener('click', () => {
                btn.remove();
                loadExpirations(symbol);
            });
            document.getElementById('expiration').parentNode.appendChild(btn);
        }

        // ===== EXP CALENDAR PICKER (Mobile) =====
        let calViewDate = new Date(); // Current month being shown in calendar

        function initExpCalendar() {
            if (!isMobile()) return;
            const select = document.getElementById('expiration');
            const trigger = document.getElementById('exp-calendar-trigger');
            if (!trigger) return;
            // On mobile, hide the native select, show calendar trigger
            select.style.display = 'none';
            trigger.style.display = 'flex';
            // Sync display text with current select value
            syncExpCalDisplay();
        }

        function syncExpCalDisplay() {
            const select = document.getElementById('expiration');
            const display = document.getElementById('exp-cal-display');
            if (!display) return;
            const opt = select.options[select.selectedIndex];
            if (opt && opt.value) {
                display.textContent = opt.textContent;
            } else {
                display.textContent = 'Select date';
            }
        }

        function openExpCalendar() {
            const overlay = document.getElementById('exp-calendar-overlay');
            // Set view month to current selection or today
            const select = document.getElementById('expiration');
            if (select.value) {
                calViewDate = new Date(select.value + 'T00:00:00');
            } else {
                calViewDate = new Date();
            }
            renderExpCalendar();
            overlay.classList.add('open');
        }

        function closeExpCalendar() {
            document.getElementById('exp-calendar-overlay').classList.remove('open');
        }

        function renderExpCalendar() {
            const container = document.getElementById('exp-cal-days');
            const label = document.getElementById('exp-cal-month-label');
            const year = calViewDate.getFullYear();
            const month = calViewDate.getMonth();
            const today = new Date();
            today.setHours(0,0,0,0);
            const selectedVal = document.getElementById('expiration').value;

            label.textContent = calViewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Build set of valid dates in this month
            const validDates = new Set();
            cachedExpirations.forEach(exp => {
                const d = new Date(exp + 'T00:00:00');
                if (d.getFullYear() === year && d.getMonth() === month) {
                    validDates.add(d.getDate());
                }
            });

            // First day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';
            // Empty cells for offset
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="exp-cal-day empty"></div>';
            }
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isValid = validDates.has(d);
                const isSelected = dateStr === selectedVal;
                const isToday = (d === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                let cls = 'exp-cal-day';
                if (isValid) cls += ' valid';
                if (isSelected) cls += ' selected';
                if (isToday) cls += ' today';
                html += `<div class="${cls}" data-date="${dateStr}">${d}</div>`;
            }
            container.innerHTML = html;

            // Attach click handlers to valid days
            container.querySelectorAll('.exp-cal-day.valid').forEach(el => {
                el.addEventListener('click', () => {
                    const date = el.dataset.date;
                    const select = document.getElementById('expiration');
                    select.value = date;
                    select.dispatchEvent(new Event('change'));
                    syncExpCalDisplay();
                    closeExpCalendar();
                });
            });
        }

        // Calendar trigger and nav button event setup (called after DOM ready)
        function setupExpCalendarEvents() {
            const trigger = document.getElementById('exp-calendar-trigger');
            if (trigger) {
                trigger.addEventListener('click', () => openExpCalendar());
            }
            const overlay = document.getElementById('exp-calendar-overlay');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeExpCalendar();
                });
            }
            document.getElementById('exp-cal-prev')?.addEventListener('click', () => {
                calViewDate.setMonth(calViewDate.getMonth() - 1);
                renderExpCalendar();
            });
            document.getElementById('exp-cal-next')?.addEventListener('click', () => {
                calViewDate.setMonth(calViewDate.getMonth() + 1);
                renderExpCalendar();
            });
        }
        
        // Sync strike matrix selection to match the hidden select value
        function syncStrikeMatrix(scrollIntoView = true) {
            const select = document.getElementById('strike');
            const val = select?.value;
            const matrixInner = document.getElementById('strike-matrix-inner');
            // Update trigger button display
            const triggerDisplay = document.getElementById('strike-trigger-display');
            if (triggerDisplay) {
                triggerDisplay.textContent = val || '-';
            }
            if (!matrixInner || !val) return;
            matrixInner.querySelectorAll('.strike-cell').forEach(c => c.classList.remove('selected'));
            const target = matrixInner.querySelector(`.strike-cell[data-strike="${val}"]`);
            if (target) {
                target.classList.add('selected');
                if (scrollIntoView) {
                    requestAnimationFrame(() => {
                        const wrapper = document.getElementById('strike-matrix');
                        if (wrapper) {
                            const offset = target.offsetTop - wrapper.offsetHeight / 2 + target.offsetHeight / 2;
                            wrapper.scrollTo({ top: Math.max(0, offset), behavior: 'smooth' });
                        }
                    });
                }
            }
        }

        async function loadStrikes(symbol, expiration, autoAnalyze = false) {
            const select = document.getElementById('strike');
            select.innerHTML = '<option value="">Loading...</option>';
            const matrixInner = document.getElementById('strike-matrix-inner');
            if (matrixInner) matrixInner.innerHTML = '';
            
            try {
                // Use watchlistData price if available (no extra API call)
                let underlyingPrice = watchlistData[symbol]?.price || 0;
                
                // If no cached price, try API as fallback
                if (!underlyingPrice) {
                    try {
                        const priceRes = await authFetch(`/api/underlying/${symbol}`);
                        const priceData = await priceRes.json();
                        underlyingPrice = priceData.price || 0;
                    } catch (e) {
                        console.warn('Could not fetch underlying price');
                    }
                }
                
                const res = await authFetch(`/api/strikes/${symbol}/${expiration}`);
                if (!res.ok) throw new Error('Failed to load');
                
                const data = await res.json();
                const right = document.getElementById('right')?.value || 'C';
                
                // Find ATM strike
                let atmStrike = data.strikes.reduce((prev, curr) => 
                    Math.abs(curr - underlyingPrice) < Math.abs(prev - underlyingPrice) ? curr : prev
                );
                
                select.innerHTML = data.strikes.map(strike => {
                    const isATM = strike === atmStrike;
                    return `<option value="${strike}" ${isATM ? 'selected' : ''}>${strike}${isATM ? ' (ATM)' : ''}</option>`;
                }).join('');

                // Update trigger display
                const triggerDisplay = document.getElementById('strike-trigger-display');
                if (triggerDisplay) {
                    triggerDisplay.textContent = atmStrike || '-';
                }

                // Build strike matrix for mobile
                if (matrixInner) {
                    matrixInner.innerHTML = data.strikes.map(strike => {
                        const isATM = strike === atmStrike;
                        const isITM = right === 'C' ? strike < underlyingPrice : strike > underlyingPrice;
                        const isOTM = right === 'C' ? strike > underlyingPrice : strike < underlyingPrice;
                        let tag = isATM ? 'ATM' : (isITM ? 'ITM' : 'OTM');
                        let cls = isATM ? 'atm selected' : (isITM ? 'itm' : 'otm');
                        return `<div class="strike-cell ${cls}" data-strike="${strike}">
                            <span class="strike-val">${strike}</span>
                            <span class="strike-tag">${tag}</span>
                        </div>`;
                    }).join('');
                    
                    // Scroll ATM into center of grid
                    requestAnimationFrame(() => {
                        const wrapper = document.getElementById('strike-matrix');
                        const atmCell = matrixInner.querySelector('.strike-cell.atm');
                        if (wrapper && atmCell) {
                            const offset = atmCell.offsetTop - wrapper.offsetHeight / 2 + atmCell.offsetHeight / 2;
                            wrapper.scrollTop = Math.max(0, offset);
                        }
                    });
                }

                // Auto-analyze with ATM strike + default settings
                if (autoAnalyze && atmStrike) {
                    analyze().catch(e => console.warn('Auto-analyze failed:', e));
                }
                
            } catch (e) {
                select.innerHTML = '<option value="">Error</option>';
                if (matrixInner) matrixInner.innerHTML = '<div style="color:#787b86;font-size:12px;padding:8px;">Error loading strikes</div>';
            }
        }
        
        // ===== CHART FUNCTIONS =====
        function initCharts() {
            const priceContainer = document.getElementById('price-chart');
            const stockContainer = document.getElementById('stock-chart');
            const volumeContainer = document.getElementById('volume-chart');
            
            priceChart = LightweightCharts.createChart(priceContainer, {
                layout: {
                    background: { color: '#131722' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: { color: '#758696', width: 1, style: 2 },
                    horzLine: { color: '#758696', width: 1, style: 2 },
                },
                rightPriceScale: { borderColor: '#2a2e39', minimumWidth: 80 },
                timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
            });
            
            candlestickSeries = priceChart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderUpColor: '#26a69a',
                borderDownColor: '#ef5350',
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });

            // ── Underlay toggle buttons ──
            document.querySelectorAll('.underlay-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.underlay-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    underlayMode = btn.dataset.underlay;
                    // Collapse/expand stock chart section based on mode
                    const stockEl = document.getElementById('stock-chart');
                    if (stockEl) {
                        if (underlayMode === 'off') {
                            stockEl.style.display = 'none';
                        } else {
                            stockEl.style.display = '';
                        }
                    }
                    applyUnderlay();
                });
            });

            // ── Stock chart (separate narrow chart for underlying) ──
            stockChart = LightweightCharts.createChart(stockContainer, {
                layout: {
                    background: { color: '#131722' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: { color: '#758696', width: 1, style: 2 },
                    horzLine: { color: '#758696', width: 1, style: 2 },
                },
                rightPriceScale: { borderColor: '#2a2e39', minimumWidth: 80 },
                timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
            });
            
            volumeChart = LightweightCharts.createChart(volumeContainer, {
                layout: {
                    background: { color: '#131722' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                rightPriceScale: {
                    borderColor: '#2a2e39',
                    minimumWidth: 80,
                    autoScale: true,
                    scaleMargins: { top: 0.05, bottom: 0 },
                },
                timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
            });
            
            volumeSeries = volumeChart.addHistogramSeries({
                priceFormat: { type: 'volume' },
            });
            
            // ── Sync timescales: LOGICAL RANGE (official TradingView pattern) ──
            // subscribeVisibleLogicalRangeChange + setVisibleLogicalRange is the
            // canonical way to sync multiple Lightweight Charts instances.
            // Unlike setVisibleRange (time-based), setVisibleLogicalRange works by
            // bar index and can extrapolate beyond available data, preventing the
            // "zoom on pan" artifact.  All datasets are unified to share the same
            // timestamps (see unifyTimestamps) so index N = same time on all charts.
            window._chartDataLoading = false;
            let _syncingChart = false;
            function syncLogicalRange(source, logicalRange) {
                if (window._chartDataLoading || _syncingChart) return;
                if (!logicalRange) return;
                _syncingChart = true;
                [priceChart, stockChart, volumeChart].forEach(c => {
                    if (c !== source) {
                        try { c.timeScale().setVisibleLogicalRange(logicalRange); } catch(_) {}
                    }
                });
                _syncingChart = false;
            }
            priceChart.timeScale().subscribeVisibleLogicalRangeChange(r => syncLogicalRange(priceChart, r));
            stockChart.timeScale().subscribeVisibleLogicalRangeChange(r => syncLogicalRange(stockChart, r));
            volumeChart.timeScale().subscribeVisibleLogicalRangeChange(r => syncLogicalRange(volumeChart, r));

            // ── Sync crosshairs across all three charts ──
            let _syncingCrosshair = false;
            function syncCrosshairFromChart(sourceChart, sourceSeries, param) {
                if (_syncingCrosshair) return;
                _syncingCrosshair = true;
                const time = param.time;
                if (time) {
                    // Sync each OTHER chart's crosshair using its own series + data
                    const targets = [
                        { chart: priceChart,  series: candlestickSeries, lookup: null },
                        { chart: stockChart,  series: underlaySeries,    lookup: _underlayByTime },
                        { chart: volumeChart, series: volumeSeries,      lookup: _volumeByTime },
                    ];
                    for (const t of targets) {
                        if (t.chart === sourceChart || !t.series) continue;
                        try {
                            // Look up the value at this time for the target series
                            const dp = t.lookup ? t.lookup.get(time) : null;
                            const val = dp ? (dp.value !== undefined ? dp.value : dp.close) : 0;
                            t.chart.setCrosshairPosition(val, time, t.series);
                        } catch(_) {}
                    }
                } else {
                    // Clear crosshairs on the other charts
                    [priceChart, stockChart, volumeChart].forEach(c => {
                        if (c !== sourceChart) {
                            try { c.clearCrosshairPosition(); } catch(_) {}
                        }
                    });
                }
                _syncingCrosshair = false;
            }
            priceChart.subscribeCrosshairMove(p => syncCrosshairFromChart(priceChart, candlestickSeries, p));
            stockChart.subscribeCrosshairMove(p => syncCrosshairFromChart(stockChart, underlaySeries, p));
            volumeChart.subscribeCrosshairMove(p => syncCrosshairFromChart(volumeChart, volumeSeries, p));
            
            // Resize handler
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const { width, height } = entry.contentRect;
                    if (width === 0 || height === 0) continue;
                    if (entry.target === priceContainer) {
                        priceChart.applyOptions({ width, height });
                    } else if (entry.target === stockContainer) {
                        stockChart.applyOptions({ width, height });
                    } else if (entry.target === volumeContainer) {
                        volumeChart.applyOptions({ width, height });
                    }
                }
            });
            resizeObserver.observe(priceContainer);
            resizeObserver.observe(stockContainer);
            resizeObserver.observe(volumeContainer);
        }
        
        // ===== ANALYSIS =====
        async function analyze() {
            const expiration = document.getElementById('expiration').value;
            const strike = document.getElementById('strike').value;
            const right = document.getElementById('right').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!currentSymbol || !expiration || !strike) {
                alert('Please select expiration and strike');
                return;
            }
            
            const btn = document.getElementById('analyze-btn');
            
            // In live mode, don't disable button, just show visual feedback
            if (liveMode) {
                const chartsContainer = document.querySelector('.charts-container');
                chartsContainer.classList.add('live-refreshing');
            } else {
                btn.disabled = true;
                btn.textContent = 'Loading...';
            }
            
            try {
                let url = `/api/analyze?symbol=${currentSymbol}&expiration=${expiration}&strike=${strike}&right=${right}&interval=${currentInterval}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
                // mock param not needed – analysis always uses real API data
                
                const res = await authFetch(url);
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Analysis failed');
                }
                
                const data = await res.json();
                
                // Track last bar datetime so live mode can send delta requests
                if (data.bars && data.bars.length > 0) {
                    lastBarDatetime = data.bars[data.bars.length - 1].datetime;
                }
                
                // Update contract header
                document.getElementById('contract-symbol').textContent = `${currentSymbol} $${strike} ${right === 'C' ? 'Call' : 'Put'}`;
                document.getElementById('contract-details').textContent = `Exp: ${expiration}`;
                
                if (data.bars.length > 0) {
                    const lastBar = data.bars[data.bars.length - 1];
                    const firstBar = data.bars[0];
                    const change = lastBar.close - firstBar.open;
                    const changePct = (change / firstBar.open * 100);
                    
                    document.getElementById('contract-price').textContent = `$${lastBar.close.toFixed(2)}`;
                    document.getElementById('contract-change').textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%)`;
                    document.getElementById('contract-change').className = `contract-change ${change >= 0 ? 'positive' : 'negative'}`;
                }
                
                // Update fair value banner
                updateFairValue(data.fair_value);
                
                // In mock-live mode, only update analysis panels — chart is fed by WS SOW/bars
                if (!(liveMode && mockMode)) {
                    updateCharts(data);
                }
                updateAnalysis(data);
                
                // Update summary text after analyze
                updateSummaryText();
                updateUrlParams();
                if (isMobile() && !hasAnalyzed) {
                    hasAnalyzed = true;
                }
                // Auto-collapse controls on mobile after analyze
                if (isMobile()) {
                    collapseControls();
                    setActiveNav('nav-chart');
                }
                
            } catch (e) {
                document.getElementById('signals-container').innerHTML = `<div class="error-message">${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '▶ Analyze';
                if (liveMode) {
                    const chartsContainer = document.querySelector('.charts-container');
                    chartsContainer.classList.remove('live-refreshing');
                }
            }
        }
        
        // Update fair value card in sidebar
        function updateFairValue(fv) {
            const card = document.getElementById('fv-card');
            if (!fv) {
                card.style.display = 'none';
                return;
            }
            card.style.display = 'block';
            
            let cls = 'fair';
            if (fv.verdict === 'CHEAP') cls = 'cheap';
            else if (fv.verdict === 'EXPENSIVE') cls = 'expensive';
            else if (fv.verdict === 'NO MARKET') cls = 'nomarket';
            
            // Verdict badge
            const verdictEl = document.getElementById('fv-verdict');
            verdictEl.textContent = fv.verdict;
            verdictEl.className = `fv-verdict-badge ${cls}`;
            
            // Main prices
            document.getElementById('fv-theo').textContent = `$${fv.theoretical_price.toFixed(2)}`;
            document.getElementById('fv-market').textContent = fv.market_price > 0 ? `$${fv.market_price.toFixed(2)}` : '-';
            
            const diffEl = document.getElementById('fv-diff');
            if (fv.market_price > 0) {
                const sign = fv.pct_difference >= 0 ? '+' : '';
                diffEl.textContent = `${sign}${fv.pct_difference.toFixed(1)}%`;
                diffEl.className = `fv-card-value ${fv.pct_difference >= 0 ? 'positive' : 'negative'}`;
            } else {
                diffEl.textContent = '-';
                diffEl.className = 'fv-card-value';
            }
            
            // Volatility row
            document.getElementById('fv-hv').textContent = `${(fv.historical_vol * 100).toFixed(1)}%`;
            document.getElementById('fv-iv').textContent = `${(fv.market_iv * 100).toFixed(1)}%`;
            const hvivEl = document.getElementById('fv-hviv');
            hvivEl.textContent = `${fv.hv_vs_iv >= 0 ? '+' : ''}${(fv.hv_vs_iv * 100).toFixed(1)}%`;
            hvivEl.className = `fv-card-value ${fv.hv_vs_iv >= 0 ? 'positive' : 'negative'}`;
            
            // Detail text
            document.getElementById('fv-details').textContent = fv.detail;
            
            // Extra details
            const dte = fv.time_to_expiry > 0 ? Math.round(fv.time_to_expiry * 365.25) : 0;
            document.getElementById('fv-d1').textContent = fv.d1.toFixed(4);
            document.getElementById('fv-d2').textContent = fv.d2.toFixed(4);
            document.getElementById('fv-dte').textContent = `${dte}d`;
            document.getElementById('fv-bid').textContent = `$${fv.bid.toFixed(2)}`;
            document.getElementById('fv-ask').textContent = `$${fv.ask.toFixed(2)}`;
            document.getElementById('fv-spread').textContent = `$${fv.spread.toFixed(2)}`;
        }
        
        function updateCharts(data) {
          try {
            const candleData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                open: bar.open,
                high: bar.high,
                low: bar.low,
                close: bar.close,
            }));
            
            const volumeData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                value: bar.volume,
                color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)',
            }));

            // ── Underlying underlay ──
            underlayBarsData = (data.underlying_bars || []).map(bar => ({
                time: toEasternUnix(bar.datetime),
                open: bar.open,
                high: bar.high,
                low: bar.low,
                close: bar.close,
                volume: bar.volume || 0,
            }));

            // Unify timestamps across all three datasets so logical bar indices
            // stay aligned (enables pixel-perfect pan/zoom/scroll sync).
            const unified = unifyTimestamps(candleData, volumeData, underlayBarsData);
            _unifiedCandleData   = unified.candle;
            _unifiedVolumeData   = unified.volume;
            _unifiedUnderlayData = unified.underlay;

            // Suppress timescale sync during bulk data load
            window._chartDataLoading = true;
            candlestickSeries.setData(_unifiedCandleData);
            volumeSeries.setData(_unifiedVolumeData);

            // Store S/R data before applying underlay (which draws the lines)
            _srData = data.support_resistance || null;

            applyUnderlay();

            // Store for re-filtering and update markers
            lastAnalysisData = data;
            updateFilteredMarkers(data.signals || []);
            
            // Scroll to show last ~100 bars using logical range (index-based)
            if (candleData.length > 0) {
                const totalBars = _unifiedCandleData.length;
                const barsToShow = Math.min(100, totalBars);
                const fromIdx = totalBars - barsToShow;
                priceChart.timeScale().setVisibleLogicalRange({
                    from: fromIdx,
                    to: totalBars - 1,
                });
                stockChart.timeScale().setVisibleLogicalRange({
                    from: fromIdx,
                    to: totalBars - 1,
                });
                volumeChart.timeScale().setVisibleLogicalRange({
                    from: fromIdx,
                    to: totalBars - 1,
                });
            } else {
                priceChart.timeScale().fitContent();
                stockChart.timeScale().fitContent();
                volumeChart.timeScale().fitContent();
            }
            window._chartDataLoading = false;
          } catch(chartErr) { console.warn('Chart update warning:', chartErr.message); }
        }
        
        function updateChartsIncremental(data) {
          try {
            const candleData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                open: bar.open,
                high: bar.high,
                low: bar.low,
                close: bar.close,
            }));
            
            const volumeData = data.bars.map(bar => ({
                time: toEasternUnix(bar.datetime),
                value: bar.volume,
                color: bar.close >= bar.open ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)',
            }));
            
            // Build new set of timestamps
            const newTimestamps = new Set(candleData.map(d => d.time));
            
            // Suppress timescale sync during updates
            window._chartDataLoading = true;
            
            // Update bars (lightweight-charts update() handles both existing and new bars)
            for (let i = 0; i < candleData.length; i++) {
                candlestickSeries.update(candleData[i]);
                volumeSeries.update(volumeData[i]);
            }

            // Update underlying underlay in live mode
            if (data.underlying_bars && data.underlying_bars.length) {
                underlayBarsData = data.underlying_bars.map(bar => ({
                    time: toEasternUnix(bar.datetime),
                    open: bar.open, high: bar.high, low: bar.low, close: bar.close,
                }));
                applyUnderlay();
            }
            
            window._chartDataLoading = false;
            
            // Update tracked timestamps
            currentBarTimestamps = newTimestamps;
            
            // Store for re-filtering and update markers
            lastAnalysisData = data;
            updateFilteredMarkers(data.signals || []);
            
          } catch(chartErr) { console.warn('Chart incremental update warning:', chartErr.message); }
        }

        // ===== STOCK CHART MANAGEMENT =====
        function removeUnderlay() {
            if (underlaySeries) {
                try { stockChart.removeSeries(underlaySeries); } catch(_) {}
                underlaySeries = null;
            }
        }

        // Calculate Point of Control: the price level with the highest traded volume.
        // We bucket prices by rounding to a sensible tick size and sum volume per bucket.
        function calculatePOC(bars) {
            if (!bars || bars.length === 0) return null;
            // Determine tick size based on price magnitude
            const avgPrice = bars.reduce((s, b) => s + (b.close || 0), 0) / bars.length;
            let tick;
            if (avgPrice >= 500) tick = 1;
            else if (avgPrice >= 100) tick = 0.5;
            else if (avgPrice >= 20) tick = 0.25;
            else tick = 0.1;

            const volumeByPrice = new Map();
            for (const bar of bars) {
                if (bar.volume === undefined || bar.close === undefined) continue;
                // Use the typical price (H+L+C)/3 for a more representative level
                const typical = (bar.high + bar.low + bar.close) / 3;
                const bucket = Math.round(typical / tick) * tick;
                const key = bucket.toFixed(4);
                volumeByPrice.set(key, (volumeByPrice.get(key) || 0) + bar.volume);
            }
            if (volumeByPrice.size === 0) return null;

            let maxVol = 0, pocPrice = 0;
            for (const [price, vol] of volumeByPrice) {
                if (vol > maxVol) {
                    maxVol = vol;
                    pocPrice = parseFloat(price);
                }
            }
            return pocPrice;
        }

        function applyUnderlay() {
            removeUnderlay();
            // Remove previous POC line
            if (pocLine) {
                try { stockChart.removeSeries(pocLine); } catch(_) {}
                pocLine = null;
            }
            if (underlayMode === 'off' || !underlayBarsData.length || !stockChart) return;

            // Use unified underlay data (padded with whitespace bars) so that
            // the stockChart has the same logical index -> time mapping as the
            // priceChart and volumeChart.
            const dataToSet = _unifiedUnderlayData.length > 0 ? _unifiedUnderlayData : underlayBarsData;

            // Pre-calculate POC so autoscaleInfoProvider can include it
            currentPOC = calculatePOC(underlayBarsData);

            // autoscaleInfoProvider ensures the POC price line is always
            // within the visible Y-axis range (prevents off-screen POC)
            const pocAutoscale = (original) => {
                const res = original();
                if (res !== null && currentPOC !== null) {
                    res.priceRange.minValue = Math.min(res.priceRange.minValue, currentPOC);
                    res.priceRange.maxValue = Math.max(res.priceRange.maxValue, currentPOC);
                }
                return res;
            };

            if (underlayMode === 'line') {
                underlaySeries = stockChart.addLineSeries({
                    color: 'rgba(100, 130, 180, 0.6)',
                    lineWidth: 2,
                    lineStyle: 0,
                    lastValueVisible: true,
                    priceLineVisible: false,
                    crosshairMarkerVisible: true,
                    autoscaleInfoProvider: pocAutoscale,
                });
                // For line series, convert OHLC to { time, value } — whitespace
                // entries (time-only) pass through as-is for alignment.
                underlaySeries.setData(dataToSet.map(b => b.close !== undefined ? { time: b.time, value: b.close } : { time: b.time }));
            } else if (underlayMode === 'candle') {
                underlaySeries = stockChart.addCandlestickSeries({
                    upColor: 'rgba(38, 166, 154, 0.7)',
                    downColor: 'rgba(239, 83, 80, 0.7)',
                    borderUpColor: '#26a69a',
                    borderDownColor: '#ef5350',
                    wickUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                    lastValueVisible: true,
                    priceLineVisible: false,
                    autoscaleInfoProvider: pocAutoscale,
                });
                underlaySeries.setData(dataToSet);
            }

            // ── Point of Control (POC) ──
            // Draw a horizontal line at the price with the highest volume
            if (currentPOC !== null && underlaySeries) {
                const poc = currentPOC;
                underlaySeries.createPriceLine({
                    price: poc,
                    color: '#ffeb3b',
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: 'POC',
                });
            }

            // ── S/R, Fibonacci, Volume Profile levels ──
            applySRLines();
        }

        function applySRLines() {
            // Remove previous S/R price lines
            _srPriceLines.forEach(pl => {
                try { if (underlaySeries) underlaySeries.removePriceLine(pl); } catch(_) {}
            });
            _srPriceLines = [];

            if (!_srData || !_srData.levels || !underlaySeries) return;

            // Color scheme per source
            const sourceColors = {
                swing:   { support: '#26a69a', resistance: '#ef5350' },
                fib_ret: { support: '#42a5f5', resistance: '#ab47bc' },
                fib_ext: { support: '#29b6f6', resistance: '#8e24aa' },
                poc:     { support: '#ffeb3b', resistance: '#ffeb3b' },
                round:   { support: 'rgba(255,255,255,0.25)', resistance: 'rgba(255,255,255,0.25)' },
            };
            const lineStyles = {
                swing:   LightweightCharts.LineStyle.Solid,
                fib_ret: LightweightCharts.LineStyle.Dashed,
                fib_ext: LightweightCharts.LineStyle.Dotted,
                poc:     LightweightCharts.LineStyle.Dashed,
                round:   LightweightCharts.LineStyle.Dotted,
            };

            // Show up to 15 most relevant levels (sorted by proximity in API)
            const levels = _srData.levels.slice(0, 15);

            for (const lvl of levels) {
                const colors = sourceColors[lvl.source] || sourceColors.swing;
                const color = colors[lvl.kind] || '#787b86';
                const style = lineStyles[lvl.source] || LightweightCharts.LineStyle.Dashed;
                // Only show axis label for strong levels to reduce clutter
                const showLabel = lvl.strength >= 0.5;

                try {
                    const pl = underlaySeries.createPriceLine({
                        price: lvl.price,
                        color: color,
                        lineWidth: lvl.strength >= 0.7 ? 2 : 1,
                        lineStyle: style,
                        axisLabelVisible: showLabel,
                        title: showLabel ? lvl.label : '',
                    });
                    _srPriceLines.push(pl);
                } catch(e) { /* ignore if chart not ready */ }
            }

            // Draw server-side POC if available and different from client POC
            if (_srData.poc && Math.abs(_srData.poc - (currentPOC || 0)) > 0.5) {
                try {
                    const pl = underlaySeries.createPriceLine({
                        price: _srData.poc,
                        color: '#ffa726',
                        lineWidth: 2,
                        lineStyle: LightweightCharts.LineStyle.Dashed,
                        axisLabelVisible: true,
                        title: 'POC (20d)',
                    });
                    _srPriceLines.push(pl);
                } catch(e) {}
            }

            // VAH / VAL lines
            if (_srData.vah) {
                try {
                    const pl = underlaySeries.createPriceLine({
                        price: _srData.vah,
                        color: 'rgba(255, 167, 38, 0.5)',
                        lineWidth: 1,
                        lineStyle: LightweightCharts.LineStyle.Dotted,
                        axisLabelVisible: false,
                        title: 'VAH',
                    });
                    _srPriceLines.push(pl);
                } catch(e) {}
            }
            if (_srData.val) {
                try {
                    const pl = underlaySeries.createPriceLine({
                        price: _srData.val,
                        color: 'rgba(255, 167, 38, 0.5)',
                        lineWidth: 1,
                        lineStyle: LightweightCharts.LineStyle.Dotted,
                        axisLabelVisible: false,
                        title: 'VAL',
                    });
                    _srPriceLines.push(pl);
                } catch(e) {}
            }
        }

        function updateAnalysis(data) {
            // Bias - with null check
            const biasContainer = document.getElementById('bias-container');
            if (data.bias && data.bias.bias) {
                biasContainer.className = `bias-indicator ${data.bias.bias}`;
                biasContainer.innerHTML = `
                    <div class="bias-label">${data.bias.bias}</div>
                    <div class="bias-strength">Strength: ${Math.round((data.bias.strength || 0) * 100)}%</div>
                    <div class="bias-reason">${data.bias.reason || ''}</div>
                `;
            } else {
                biasContainer.className = 'bias-indicator neutral';
                biasContainer.innerHTML = `
                    <div class="bias-label">neutral</div>
                    <div class="bias-strength">Not enough data</div>
                `;
            }
            
            // Stats
            const signals = data.signals || [];
            const bullishSignals = signals.filter(s => BULLISH_SIGNALS.includes(s.signal));
            const bearishSignals = signals.filter(s => BEARISH_SIGNALS.includes(s.signal));
            
            document.getElementById('stat-bars').textContent = (data.bars || []).length;
            document.getElementById('stat-signals').textContent = signals.length;
            document.getElementById('stat-bullish').textContent = bullishSignals.length;
            document.getElementById('stat-bearish').textContent = bearishSignals.length;
            
            // Signals list
            const signalsContainer = document.getElementById('signals-container');
            if (signals.length === 0) {
                signalsContainer.innerHTML = '<div class="loading">No significant signals</div>';
                return;
            }
            
            const filteredSignals = filterSignals(signals);
            if (filteredSignals.length === 0) {
                signalsContainer.innerHTML = '<div class="loading">No signals match active filters</div>';
                // still update stats with unfiltered counts
            } else {
            const signalHtml = [...filteredSignals]
                .reverse()
                .slice(0, 30)
                .map(signal => {
                    const isBullish = BULLISH_SIGNALS.includes(signal.signal);
                    return `
                        <div class="signal-item ${isBullish ? 'bullish' : 'bearish'}">
                            <div class="signal-time">${toEasternString(signal.datetime)} ET</div>
                            <div class="signal-name">${signal.signal.replace(/_/g, ' ').toUpperCase()}</div>
                            <div class="signal-desc">${signal.description}</div>
                            <div class="signal-meta">
                                <span>$${signal.price.toFixed(2)}</span>
                                <span>Vol: ${signal.volume.toLocaleString()}</span>
                                <span>${signal.volume_ratio}x avg</span>
                            </div>
                        </div>
                    `;
                }).join('');
            signalsContainer.innerHTML = signalHtml;
            // Also update the full signals tab
            const fullContainer = document.getElementById('signals-container-full');
            if (fullContainer) fullContainer.innerHTML = signalHtml;
            }
            
            // Update signal peek
            updateSignalPeek(signals);
            
            // Composite signal
            if (data.composite) {
                updateComposite(data.composite);
            }

            // S/R card
            updateSRCard(data.support_resistance);
        }
        
        // ===== TOAST NOTIFICATIONS =====
        function showToast(html, cssClass, duration = 5000) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast ' + cssClass;
            el.innerHTML = html;
            el.onclick = () => { el.classList.add('fade-out'); setTimeout(() => el.remove(), 300); };
            container.appendChild(el);
            setTimeout(() => {
                if (el.parentNode) { el.classList.add('fade-out'); setTimeout(() => el.remove(), 300); }
            }, duration);
        }

        function showSignalToast(oldAction, newAction, comp) {
            const icons = { 'STRONG BUY': '🟢', 'BUY': '🟢', 'HOLD': '⚪', 'SELL': '🔴', 'STRONG SELL': '🔴' };
            const cls = newAction.includes('BUY') ? 'buy' : newAction.includes('SELL') ? 'sell' : 'hold';
            const icon = icons[newAction] || '⚪';
            const score = (comp.score >= 0 ? '+' : '') + comp.score.toFixed(3);
            const conf = Math.round(comp.confidence * 100) + '%';
            showToast(
                `<span class="toast-icon">${icon}</span>` +
                `<div class="toast-body">` +
                `<span class="toast-title">Signal Changed: ${oldAction} → ${newAction}</span>` +
                `<span class="toast-detail">Score ${score} · Conf ${conf} · ${comp.trade_archetype.replace(/_/g, ' ')}</span>` +
                `</div>`,
                cls, 6000
            );
        }

        function showVpaActionToast(oldAction, newAction, signal) {
            const icons = { 'BUY': '🟢', 'HOLD': '⚪', 'SELL': '🔴' };
            const cls = newAction === 'BUY' ? 'buy' : newAction === 'SELL' ? 'sell' : 'hold';
            const icon = icons[newAction] || '⚪';
            const conf = Math.round(signal.confidence * 100) + '%';
            const sigName = signal.signal.replace(/_/g, ' ').toUpperCase();
            showToast(
                `<span class="toast-icon">${icon}</span>` +
                `<div class="toast-body">` +
                `<span class="toast-title">Signal: ${oldAction} → ${newAction}</span>` +
                `<span class="toast-detail">${sigName} · Conf ${conf} · $${signal.price.toFixed(2)}</span>` +
                `</div>`,
                cls, 6000
            );
        }

        function updateSRCard(sr) {
            const card = document.getElementById('sr-card');
            const summary = document.getElementById('sr-summary');
            const list = document.getElementById('sr-levels-list');
            if (!sr || !sr.levels || sr.levels.length === 0) {
                card.style.display = 'none';
                return;
            }
            card.style.display = 'block';

            // Summary row: nearest S/R + proximity
            const proxCls = sr.proximity_score > 0.1 ? 'positive' : sr.proximity_score < -0.1 ? 'negative' : '';
            const proxSign = sr.proximity_score >= 0 ? '+' : '';
            summary.innerHTML = `
                <div class="chain-grid" style="grid-template-columns:1fr 1fr 1fr">
                    <div class="chain-item">
                        <div class="chain-value" style="color:#26a69a">${sr.nearest_support ? '$' + sr.nearest_support.toFixed(2) : '—'}</div>
                        <div class="chain-label">Support</div>
                    </div>
                    <div class="chain-item">
                        <div class="chain-value" style="color:#ef5350">${sr.nearest_resistance ? '$' + sr.nearest_resistance.toFixed(2) : '—'}</div>
                        <div class="chain-label">Resistance</div>
                    </div>
                    <div class="chain-item">
                        <div class="chain-value ${proxCls}">${proxSign}${sr.proximity_score.toFixed(2)}</div>
                        <div class="chain-label">S/R Score</div>
                    </div>
                </div>
                ${sr.poc ? `<div style="font-size:11px;color:#787b86;margin-top:6px">POC $${sr.poc.toFixed(2)}${sr.vah ? ' · VAH $' + sr.vah.toFixed(2) : ''}${sr.val ? ' · VAL $' + sr.val.toFixed(2) : ''}</div>` : ''}
                <div style="font-size:11px;color:#5d606b;margin-top:4px">${sr.proximity_detail}</div>
            `;

            // Key levels list (top 8)
            const keyLevels = sr.levels
                .filter(l => l.strength >= 0.4)
                .slice(0, 8);
            if (keyLevels.length === 0) {
                list.innerHTML = '';
                return;
            }
            const sourceIcon = { swing: '📊', fib_ret: '📐', fib_ext: '📐', poc: '🎯', round: '🔵' };
            list.innerHTML = keyLevels.map(l => {
                const color = l.kind === 'support' ? '#26a69a' : '#ef5350';
                const icon = sourceIcon[l.source] || '•';
                return `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:11px;border-bottom:1px solid #1e222d">
                    <span>${icon} <span style="color:${color};font-weight:600">$${l.price.toFixed(2)}</span> <span style="color:#787b86">${l.label}</span></span>
                    <span style="color:#5d606b">${Math.round(l.strength * 100)}%</span>
                </div>`;
            }).join('');
        }

        function updateComposite(comp) {
            if (!comp) return;

            // Gauge – color based on ACTION (BUY=green, SELL=red) not underlying direction
            // This way buying a put still shows green because the action is BUY
            const actionClass = {
                'STRONG BUY': 'strong_buy', 'BUY': 'buy',
                'HOLD': 'neutral',
                'SELL': 'sell', 'STRONG SELL': 'strong_sell',
            }[comp.action] || 'neutral';
            const gauge = document.getElementById('composite-gauge');
            gauge.className = 'composite-signal-gauge ' + actionClass;
            const isCall = document.getElementById('dcp-call')?.classList?.contains('call-active');
            const rightLabel = isCall ? 'CALLS' : 'PUTS';
            const actionSuffix = comp.action !== 'HOLD' ? ' ' + rightLabel : '';
            document.getElementById('comp-action').textContent = comp.action + actionSuffix;
            document.getElementById('comp-signal-sub').textContent = comp.signal.replace(/_/g, ' ');
            document.getElementById('comp-score').textContent = (comp.score >= 0 ? '+' : '') + comp.score.toFixed(3);
            document.getElementById('comp-conf').textContent = Math.round(comp.confidence * 100) + '%';

            // Archetype
            const archDiv = document.getElementById('comp-archetype');
            archDiv.innerHTML = `
                <span class="archetype-badge">${comp.trade_archetype.replace(/_/g, ' ')}</span>
                <div class="archetype-desc">${comp.archetype_description}</div>
            `;

            // Greeks
            const g = comp.greeks;
            setGreek('g-delta', g.delta, true);
            setGreek('g-gamma', g.gamma, false);
            setGreek('g-theta', g.theta, true);
            setGreek('g-vega', g.vega, false);
            document.getElementById('g-iv').textContent = (g.iv * 100).toFixed(1) + '%';
            document.getElementById('g-oi').textContent = g.open_interest.toLocaleString();

            // Chain metrics
            const cm = comp.chain_metrics;
            document.getElementById('cm-ivr').textContent = cm.iv_rank.toFixed(0) + '%';
            const gexEl = document.getElementById('cm-gex');
            gexEl.textContent = cm.gex_regime.charAt(0).toUpperCase() + cm.gex_regime.slice(1);
            gexEl.style.color = cm.gex_regime === 'positive' ? '#26a69a' : cm.gex_regime === 'negative' ? '#ef5350' : '#787b86';
            document.getElementById('cm-pcr').textContent = cm.put_call_oi_ratio.toFixed(2);
            document.getElementById('cm-maxpain').textContent = '$' + cm.max_pain.toFixed(0);
            document.getElementById('cm-calloi').textContent = formatCompact(cm.total_call_oi);
            document.getElementById('cm-putoi').textContent = formatCompact(cm.total_put_oi);

            // UOA
            const uoaDiv = document.getElementById('uoa-container');
            if (cm.uoa_detected && cm.uoa_details.length > 0) {
                uoaDiv.innerHTML = `
                    <div class="uoa-alert">
                        <div class="uoa-alert-header">⚡ Unusual Options Activity</div>
                        ${cm.uoa_details.slice(0, 5).map(u => `
                            <div class="uoa-strike">
                                <span>$${u.strike} ${u.type}</span>
                                <span>Vol: ${u.volume.toLocaleString()}</span>
                                <span class="uoa-ratio">${u.vol_oi_ratio}x V/OI</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                uoaDiv.innerHTML = '';
            }

            // Factor breakdown
            const factorList = document.getElementById('factor-list');
            factorList.innerHTML = comp.factors.map(f => {
                const cls = f.score > 0.05 ? 'positive' : f.score < -0.05 ? 'negative' : 'zero';
                const barPct = Math.abs(f.score) * 50; // 0-50% from center
                const barLeft = f.score >= 0 ? '50%' : (50 - barPct) + '%';
                return `
                    <div class="factor-item">
                        <div class="factor-header">
                            <span class="factor-name">${f.name}</span>
                            <span class="factor-score-badge ${cls}">${f.score >= 0 ? '+' : ''}${f.score.toFixed(2)}</span>
                        </div>
                        <div class="factor-bar-bg">
                            <div class="factor-bar-fill ${cls}" style="left:${barLeft};width:${barPct}%"></div>
                        </div>
                        <div class="factor-detail">${f.detail}</div>
                    </div>
                `;
            }).join('');

            // Recommendation
            document.getElementById('comp-recommendation').textContent = comp.recommendation;

            // Warnings
            const warningsDiv = document.getElementById('comp-warnings');
            if (comp.warnings && comp.warnings.length > 0) {
                warningsDiv.innerHTML = comp.warnings.map(w => `
                    <div style="background:rgba(239,83,80,0.12);border:1px solid #ef5350;border-radius:6px;padding:8px 12px;margin-top:6px;font-size:13px;color:#ef5350;">
                        ${w}
                    </div>
                `).join('');
            } else {
                warningsDiv.innerHTML = '';
            }

            // Add BUY/SELL/HOLD marker on the last bar of the chart
            addCompositeMarker(comp);

            // Update mobile action banner
            if (isMobile()) {
                updateMobileActionBanner(comp);
            }
        }

        // Store the composite result globally so markers can be combined with VPA signals
        let lastCompositeResult = null;

        function addCompositeMarker(comp) {
            if (!candlestickSeries || !lastAnalysisData || !lastAnalysisData.bars.length) return;
            lastCompositeResult = comp;
            rebuildAllMarkers();
        }

        function rebuildAllMarkers() {
            if (!candlestickSeries) return;

            // Collect VPA signal markers (individual signal types)
            const vpaSignals = lastAnalysisData ? (lastAnalysisData.signals || []) : [];
            // VPA dot markers: filtered by BOTH signal type toggles AND confidence
            const filtered = filterSignals(vpaSignals);
            const markers = filtered.map(signal => {
                const isBullish = BULLISH_SIGNALS.includes(signal.signal);
                return {
                    time: toEasternUnix(signal.datetime),
                    position: isBullish ? 'belowBar' : 'aboveBar',
                    color: isBullish ? '#26a69a' : '#ef5350',
                    shape: isBullish ? 'arrowUp' : 'arrowDown',
                    text: signal.signal.replace('_', ' '),
                };
            });

            // BUY/SELL action markers: filtered by confidence ONLY (not signal type toggles)
            // so toggling off e.g. "Strong Bullish" hides the VPA dot but keeps BUY/SELL labels
            const confFiltered = vpaSignals.filter(s => {
                if (minConfidence > 0) {
                    const conf = (s.confidence || 0) * 100;
                    if (conf < minConfidence) return false;
                }
                return true;
            });
            const actionMarkers = buildActionMarkers(confFiltered);
            for (const am of actionMarkers) {
                markers.push(am);
            }

            // Check if the latest VPA-derived action changed → fire toast
            if (vpaSignals.length > 0) {
                const sortedAll = [...vpaSignals].sort((a, b) => {
                    return new Date(a.datetime.replace(' ', 'T') + 'Z') - new Date(b.datetime.replace(' ', 'T') + 'Z');
                });
                const latestAction = classifySignal(sortedAll[sortedAll.length - 1].signal);
                if (lastVpaAction !== null && latestAction !== lastVpaAction) {
                    showVpaActionToast(lastVpaAction, latestAction, sortedAll[sortedAll.length - 1]);
                }
                lastVpaAction = latestAction;
            }

            // Add composite BUY/SELL/HOLD marker on the last bar (from greeks engine)
            if (lastCompositeResult && lastAnalysisData && lastAnalysisData.bars.length > 0) {
                const comp = lastCompositeResult;
                const lastBar = lastAnalysisData.bars[lastAnalysisData.bars.length - 1];
                const action = comp.action;
                const isBuy = action.includes('BUY');
                const isSell = action.includes('SELL');

                if (isBuy || isSell) {
                    const confPct = Math.round(comp.confidence * 100);
                    markers.push({
                        time: toEasternUnix(lastBar.datetime),
                        position: isBuy ? 'belowBar' : 'aboveBar',
                        color: isBuy ? '#00e676' : '#ff1744',
                        shape: isBuy ? 'arrowUp' : 'arrowDown',
                        text: `${action} (${confPct}%)`,
                    });
                }
            }

            markers.sort((a, b) => a.time - b.time);
            candlestickSeries.setMarkers(markers);
        }

        function setGreek(id, value, showSign) {
            const el = document.getElementById(id);
            const formatted = showSign ? ((value >= 0 ? '+' : '') + value.toFixed(4)) : value.toFixed(4);
            el.textContent = formatted;
            el.className = 'greek-value ' + (value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral-val');
        }

        function formatCompact(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
        }
        
        // ===== EVENT LISTENERS =====
        document.getElementById('expiration').addEventListener('change', (e) => {
            if (currentSymbol && e.target.value) {
                loadStrikes(currentSymbol, e.target.value, !isMobile());  // auto-analyze only on desktop
            }
            // Stop live mode when expiration changes
            stopLiveMode();
            // Sync mobile calendar display
            syncExpCalDisplay();
        });
        
        document.getElementById('strike').addEventListener('change', () => {
            // Stop live mode when strike changes
            stopLiveMode();
            // Auto-analyze with new strike (desktop only — mobile waits for Analyze button)
            if (!isMobile() && currentSymbol && document.getElementById('expiration').value && document.getElementById('strike').value) {
                analyze().catch(e => console.warn('Auto-analyze on strike change failed:', e));
            }
        });

        // Strike modal open/close helpers
        function openStrikeModal() {
            const overlay = document.getElementById('strike-modal-overlay');
            if (overlay) {
                overlay.classList.add('open');
                // Delay scroll so the modal is rendered first
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        const val = document.getElementById('strike')?.value;
                        const matrixInner = document.getElementById('strike-matrix-inner');
                        const wrapper = document.getElementById('strike-matrix');
                        if (!matrixInner || !wrapper || !val) return;
                        const target = matrixInner.querySelector(`.strike-cell[data-strike="${val}"]`);
                        if (target) {
                            const offset = target.offsetTop - wrapper.clientHeight / 2 + target.offsetHeight / 2;
                            wrapper.scrollTop = Math.max(0, offset);
                        }
                    }, 50);
                });
            }
        }
        function closeStrikeModal() {
            const overlay = document.getElementById('strike-modal-overlay');
            if (overlay) overlay.classList.remove('open');
        }

        // Trigger button opens modal
        document.getElementById('strike-matrix-trigger')?.addEventListener('click', openStrikeModal);

        // Close button
        document.getElementById('strike-modal-close')?.addEventListener('click', closeStrikeModal);

        // Backdrop click closes modal
        document.getElementById('strike-modal-overlay')?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeStrikeModal();
        });

        // Strike matrix click handler (mobile)
        document.getElementById('strike-matrix-inner')?.addEventListener('click', (e) => {
            const cell = e.target.closest('.strike-cell');
            if (!cell) return;
            const val = cell.dataset.strike;
            // Update hidden select
            const select = document.getElementById('strike');
            select.value = val;
            select.dispatchEvent(new Event('change'));
            // Update matrix selection visuals
            document.querySelectorAll('#strike-matrix-inner .strike-cell').forEach(c => {
                c.classList.remove('selected');
            });
            cell.classList.add('selected');
            // Update trigger display
            const triggerDisplay = document.getElementById('strike-trigger-display');
            if (triggerDisplay) triggerDisplay.textContent = val;
            // Close modal after selection
            closeStrikeModal();
        });

        // (nav buttons removed — modal uses full scroll)
        
        document.getElementById('analyze-btn').addEventListener('click', analyze);
        document.getElementById('summary-analyze-btn').addEventListener('click', analyze);

        // Auto-analyze when date inputs change manually
        document.getElementById('start-date').addEventListener('change', () => {
            if (currentSymbol && document.getElementById('expiration').value && document.getElementById('strike').value) {
                analyze().catch(e => console.warn('Auto-analyze on start-date change failed:', e));
            }
        });
        document.getElementById('end-date').addEventListener('change', () => {
            if (currentSymbol && document.getElementById('expiration').value && document.getElementById('strike').value) {
                analyze().catch(e => console.warn('Auto-analyze on end-date change failed:', e));
            }
        });
        
        // Live mode button
        document.getElementById('live-btn').addEventListener('click', toggleLiveMode);

        // Connection-limit modal dismiss
        document.getElementById('conn-limit-ok').addEventListener('click', () => {
            document.getElementById('conn-limit-modal').classList.remove('active');
        });
        document.getElementById('conn-limit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'conn-limit-modal') {
                e.target.classList.remove('active');
            }
        });
        
        // Mock mode toggle
        document.getElementById('mock-btn').addEventListener('click', () => {
            mockMode = !mockMode;
            const btn = document.getElementById('mock-btn');
            if (mockMode) {
                btn.style.background = '#facc15';
                btn.style.color = '#000';
                btn.textContent = 'MOCK ✓';
            } else {
                btn.style.background = '#2a2e39';
                btn.style.color = '#787b86';
                btn.textContent = 'MOCK';
            }
            // Re-send watchlist symbols with new mock state
            sendWatchlistSymbols();
            // If live mode is running, restart it with new mock state
            if (liveMode) {
                stopLiveMode();
                toggleLiveMode();
            }
        });
        
        // Controls chevron
        document.getElementById('controls-chevron').addEventListener('click', toggleControls);
        
        // Interval buttons - Handle both main and summary interval buttons
        document.querySelectorAll('.interval-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const newInterval = parseInt(btn.dataset.interval);
                if (newInterval === currentInterval) return;
                // Update all interval buttons (both main and summary)
                document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
                currentInterval = newInterval;
                // Set active on all buttons with same interval
                document.querySelectorAll(`.interval-btn[data-interval="${currentInterval}"]`).forEach(b => b.classList.add('active'));
                updateUrlParams();

                // If live mock mode is active, restart with new interval
                if (liveMode && mockMode) {
                    console.log(`[Interval] Changed to ${currentInterval}m while mock-live active — restarting`);
                    stopLiveMode();
                    setTimeout(() => toggleLiveMode(), 300);
                } else {
                    // Auto-analyze with new interval
                    if (currentSymbol && document.getElementById('expiration').value && document.getElementById('strike').value) {
                        analyze().catch(e => console.warn('Auto-analyze on interval change failed:', e));
                    }
                }
            });
        });

        // ===== DATE RANGE BUTTONS (auto-analyze on change) =====
        document.querySelectorAll('.date-range-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Sync all date-range-btn across mobile and desktop
                document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
                // Activate all buttons with the same range value
                const rangeVal = btn.dataset.range;
                document.querySelectorAll(`.date-range-btn[data-range="${rangeVal}"]`).forEach(b => b.classList.add('active'));
                const days = parseInt(rangeVal);
                const today = new Date();
                const from = new Date(today);
                from.setDate(today.getDate() - days);
                document.getElementById('start-date').value = from.toISOString().split('T')[0];
                document.getElementById('end-date').value = today.toISOString().split('T')[0];
                updateUrlParams();
                // Auto-analyze with new date range if a symbol is selected
                if (currentSymbol && document.getElementById('expiration').value && document.getElementById('strike').value) {
                    analyze().catch(e => console.warn('Auto-analyze on date range change failed:', e));
                }
            });
        });

        // ===== CALL/PUT SWITCH (syncs desktop + mobile + hidden select) =====
        function syncCallPut(value) {
            document.getElementById('right').value = value;
            if (value === 'C') {
                document.getElementById('cp-call').className = 'cp-toggle-option call-active';
                document.getElementById('cp-put').className = 'cp-toggle-option';
                document.getElementById('dcp-call').className = 'cp-opt call-active';
                document.getElementById('dcp-put').className = 'cp-opt';
            } else {
                document.getElementById('cp-put').className = 'cp-toggle-option put-active';
                document.getElementById('cp-call').className = 'cp-toggle-option';
                document.getElementById('dcp-put').className = 'cp-opt put-active';
                document.getElementById('dcp-call').className = 'cp-opt';
            }
            stopLiveMode();
            updateUrlParams();
            // Auto-analyze with new call/put (desktop only — mobile waits for Analyze button)
            if (!isMobile() && currentSymbol && document.getElementById('expiration').value && document.getElementById('strike').value) {
                analyze().catch(e => console.warn('Auto-analyze on call/put change failed:', e));
            }
        }
        // Mobile
        document.getElementById('cp-call').addEventListener('click', () => syncCallPut('C'));
        document.getElementById('cp-put').addEventListener('click', () => syncCallPut('P'));
        // Desktop
        document.getElementById('dcp-call').addEventListener('click', () => syncCallPut('C'));
        document.getElementById('dcp-put').addEventListener('click', () => syncCallPut('P'));
        // Hidden select change (fallback)
        document.getElementById('right').addEventListener('change', (e) => syncCallPut(e.target.value));

        // ===== SUMMARY LIVE BUTTON =====
        document.getElementById('summary-live-btn').addEventListener('click', toggleLiveMode);
        
        // ===== MOBILE LIVE BADGE =====
        document.getElementById('mobile-live-badge').addEventListener('click', toggleLiveMode);
        
        // Signal peek click handler
        document.getElementById('signal-peek').addEventListener('click', () => {
            if (isMobile()) {
                openAnalysis();
            }
        });
        
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                // Switch tab content
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                const target = document.getElementById('tab-' + tabName);
                if (target) target.classList.add('active');
            });
        });
        
        document.getElementById('watchlist-search').addEventListener('input', renderWatchlist);

        // ===== SIDEBAR COLLAPSE/EXPAND (DESKTOP) =====
        (function initSidebarCollapse() {
            const sidebar = document.getElementById('watchlist-sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const storageKey = 'watchlist-sidebar-collapsed';

            function collapseSidebar() {
                sidebar.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                localStorage.setItem(storageKey, '1');
            }

            function expandSidebar() {
                sidebar.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                localStorage.setItem(storageKey, '0');
            }

            toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (sidebar.classList.contains('collapsed')) {
                    expandSidebar();
                } else {
                    collapseSidebar();
                }
            });

            // Restore state from localStorage
            if (localStorage.getItem(storageKey) === '1') {
                collapseSidebar();
            }
        })();

        // ===== SIDEBAR TABS (Watchlist / Ideas) =====
        (function initSidebarTabs() {
            const tabs = document.querySelectorAll('.watchlist-tab');
            const searchWrap = document.getElementById('watchlist-search-wrap');
            const watchlistItems = document.getElementById('watchlist-container');
            const ideasPanel = document.getElementById('ideas-panel');
            let ideasLoaded = false;

            function switchTab(tabName) {
                tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
                // Update sidebar header title
                const sidebarTitle = document.querySelector('.watchlist-header h2');
                if (sidebarTitle) {
                    sidebarTitle.textContent = tabName === 'ideas' ? 'Trade Ideas' : 'Watchlist';
                }
                if (tabName === 'watchlist') {
                    searchWrap.style.display = '';
                    watchlistItems.style.display = '';
                    ideasPanel.classList.remove('active');
                } else {
                    searchWrap.style.display = 'none';
                    watchlistItems.style.display = 'none';
                    ideasPanel.classList.add('active');
                    if (!ideasLoaded) {
                        ideasLoaded = true;
                        loadIdeas();
                    }
                }
            }

            tabs.forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab)));

            // ══════════════════════════════════════════════════════
            //  USER ROLE DETECTION + SUBMIT BUTTON VISIBILITY
            // ══════════════════════════════════════════════════════
            async function fetchUserRole() {
                try {
                    const res = await authFetch('/api/me');
                    if (res.ok) {
                        currentUser = await res.json();
                        // Show submit button only for admin
                        const submitBtn = document.getElementById('submit-idea-btn');
                        if (submitBtn && currentUser.role === 'admin') {
                            submitBtn.classList.add('visible');
                        }
                        // Also show mobile submit idea btn for admin
                        const mobileSubmitBtn = document.getElementById('mobile-submit-idea-btn');
                        if (mobileSubmitBtn && currentUser.role === 'admin') {
                            mobileSubmitBtn.style.display = 'inline-flex';
                        }
                    }
                } catch (e) {
                    console.warn('Could not fetch user role:', e);
                }
            }
            fetchUserRole();

            // ══════════════════════════════════════════════════════
            //  IDEA SUBMIT MODAL WIRING
            // ══════════════════════════════════════════════════════
            const submitBtn = document.getElementById('submit-idea-btn');
            const modalOverlay = document.getElementById('idea-modal-overlay');
            const modalClose = document.getElementById('idea-modal-close');
            const actionBtns = document.querySelectorAll('.idea-action-btn');
            const submitFinalBtn = document.getElementById('idea-submit-final');
            const ideaNoteEl = document.getElementById('idea-note');
            let selectedAction = null;

            // Open modal — populate with current contract info
            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    openIdeaModal();
                });
            }
            // Mobile submit idea button — same action
            const mobileSubmitBtnEl = document.getElementById('mobile-submit-idea-btn');
            if (mobileSubmitBtnEl) {
                mobileSubmitBtnEl.addEventListener('click', () => {
                    openIdeaModal();
                });
            }
            function openIdeaModal() {
                    const sym = currentSymbol || '-';
                    const strike = document.getElementById('strike')?.value || '-';
                    const right = document.getElementById('right')?.value || 'C';
                    const exp = document.getElementById('expiration')?.value || '-';
                    const priceText = document.getElementById('contract-price')?.textContent || '0';
                    const price = parseFloat(priceText.replace(/[^0-9.]/g, '')) || 0;

                    document.getElementById('idea-form-symbol').textContent = sym;
                    document.getElementById('idea-form-contract').textContent =
                        `$${strike} ${right === 'C' ? 'CALL' : 'PUT'}`;
                    document.getElementById('idea-form-exp').textContent = exp;
                    document.getElementById('idea-form-price').textContent = `$${price.toFixed(2)}`;

                    // Reset action selection
                    selectedAction = null;
                    actionBtns.forEach(b => b.classList.remove('selected'));
                    submitFinalBtn.disabled = true;
                    ideaNoteEl.value = '';

                    modalOverlay.classList.add('open');
            }

            // Close modal
            if (modalClose) {
                modalClose.addEventListener('click', () => {
                    modalOverlay.classList.remove('open');
                });
            }
            if (modalOverlay) {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) modalOverlay.classList.remove('open');
                });
            }

            // Action toggle (BUY / SELL)
            actionBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    actionBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedAction = btn.dataset.action;
                    submitFinalBtn.disabled = false;
                });
            });

            // Submit idea to backend
            if (submitFinalBtn) {
                submitFinalBtn.addEventListener('click', async () => {
                    if (!selectedAction) return;
                    submitFinalBtn.disabled = true;
                    submitFinalBtn.textContent = 'Submitting...';

                    const strike = parseFloat(document.getElementById('strike')?.value) || 0;
                    const right = document.getElementById('right')?.value || 'C';
                    const exp = document.getElementById('expiration')?.value || '';
                    const priceText = document.getElementById('contract-price')?.textContent || '0';
                    const price = parseFloat(priceText.replace(/[^0-9.]/g, '')) || 0;

                    try {
                        const res = await authFetch('/api/ideas/submit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                symbol: currentSymbol,
                                expiration: exp,
                                strike: strike,
                                right: right,
                                price: price,
                                action: selectedAction,
                                note: ideaNoteEl.value.trim()
                            })
                        });
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({}));
                            throw new Error(err.detail || 'Submit failed');
                        }
                        modalOverlay.classList.remove('open');
                    } catch (err) {
                        console.error('Submit idea error:', err);
                        alert('Failed to submit idea: ' + err.message);
                    } finally {
                        submitFinalBtn.disabled = false;
                        submitFinalBtn.textContent = 'Submit Idea';
                    }
                });
            }

            // ══════════════════════════════════════════════════════
            //  IDEAS STATE + RENDERING
            // ══════════════════════════════════════════════════════
            let allIdeas = [];
            let ideasSearchTerm = '';

            // ── Search box ──
            document.getElementById('ideas-search').addEventListener('input', (e) => {
                ideasSearchTerm = e.target.value.trim().toUpperCase();
                renderIdeas();
            });

            // Format timestamp to nice time (e.g. "2:35 PM")
            function formatIdeaTime(isoStr) {
                try {
                    const d = new Date(isoStr);
                    return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                } catch { return ''; }
            }

            // ── Render user-submitted ideas ──
            function renderIdeas() {
                const list = document.getElementById('ideas-list');
                const empty = document.getElementById('ideas-empty');
                list.innerHTML = '';

                const filtered = allIdeas.filter(idea => {
                    if (ideasSearchTerm && !idea.symbol.includes(ideasSearchTerm)) return false;
                    return true;
                });

                if (filtered.length === 0) {
                    empty.textContent = allIdeas.length > 0
                        ? 'No ideas match search'
                        : 'No trade ideas today';
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';

                // Show newest first
                [...filtered].reverse().forEach(idea => {
                    const el = document.createElement('div');
                    const isBuy = idea.action === 'BUY';
                    const badgeClass = idea.right === 'C' ? 'call' : 'put';

                    el.className = 'idea-item';
                    el.innerHTML = `
                        <div class="idea-top">
                            <span class="idea-ticker">${idea.symbol} $${idea.strike}</span>
                            <span class="idea-badge ${badgeClass}">${idea.type_label}</span>
                        </div>
                        <div class="idea-detail">${idea.exp_label} · $${idea.price}</div>
                        <div class="idea-signal">
                            <span class="idea-signal-dot ${isBuy ? 'buy' : 'sell'}"></span>
                            <span style="color:${isBuy ? '#26a69a' : '#ef5350'};font-weight:600">${idea.action}</span>
                        </div>
                        <div class="idea-meta">
                            <span class="idea-poster">💡 ${idea.posted_by || 'Admin'}</span>
                            <span style="color:#787b86">${formatIdeaTime(idea.timestamp)}</span>
                        </div>
                        ${idea.note ? `<div style="color:#9ca3af;font-size:11px;margin-top:4px;font-style:italic">"${idea.note}"</div>` : ''}
                    `;
                    el.addEventListener('click', () => applyIdea(idea));
                    list.appendChild(el);
                });
            }

            // ── Fetch today's ideas from REST ──
            async function loadIdeas() {
                const loading = document.getElementById('ideas-loading');
                const empty = document.getElementById('ideas-empty');
                const list = document.getElementById('ideas-list');
                loading.style.display = 'block';
                empty.style.display = 'none';
                list.innerHTML = '';

                try {
                    const res = await authFetch('/api/ideas');
                    if (!res.ok) throw new Error('Failed to fetch ideas');
                    const data = await res.json();

                    loading.style.display = 'none';

                    if (!data.ideas || data.ideas.length === 0) {
                        empty.style.display = 'block';
                        allIdeas = [];
                        return;
                    }

                    allIdeas = data.ideas;
                    renderIdeas();
                } catch (err) {
                    loading.style.display = 'none';
                    empty.textContent = 'Failed to load ideas';
                    empty.style.display = 'block';
                    console.error('Ideas fetch error:', err);
                }
            }

            // ══════════════════════════════════════════════════════
            //  IDEAS WEBSOCKET — real-time new idea notifications
            // ══════════════════════════════════════════════════════
            function connectIdeasWs() {
                const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
                const token = document.cookie.split(';')
                    .map(c => c.trim())
                    .find(c => c.startsWith('session='))
                    ?.split('=')[1] || '';
                const url = `${proto}//${location.host}/ws/ideas?token=${token}`;
                ideasWs = new WebSocket(url);

                ideasWs.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'new_idea' && msg.idea) {
                            // Add to local list and re-render
                            allIdeas.push(msg.idea);
                            renderIdeas();
                            // Show toast + sound
                            emitIdeaToast(msg.idea);
                        }
                    } catch (e) { console.warn('Ideas WS parse error:', e); }
                };

                ideasWs.onclose = () => {
                    // Reconnect after 5 seconds
                    setTimeout(connectIdeasWs, 5000);
                };

                ideasWs.onerror = () => {
                    ideasWs.close();
                };
            }
            connectIdeasWs();

            // ── Toast + sound alert for new idea ──
            function emitIdeaToast(idea) {
                // Play two-tone alert sound
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(880, ctx.currentTime);
                    osc.frequency.setValueAtTime(1100, ctx.currentTime + 0.15);
                    osc.frequency.setValueAtTime(880, ctx.currentTime + 0.30);
                    gain.gain.setValueAtTime(0.15, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.45);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.45);
                } catch (e) { /* audio not available */ }

                const isBuy = idea.action === 'BUY';
                const toastContainer = document.getElementById('ideas-toast');
                const toast = document.createElement('div');
                toast.className = 'ideas-toast-item' + (isBuy ? '' : ' sell-toast');
                toast.style.animationDelay = '0s, 4.6s';
                toast.innerHTML = `
                    <div class="ideas-toast-title ${isBuy ? 'buy' : 'sell'}">
                        💡 ${idea.action}: ${idea.symbol} $${idea.strike}
                    </div>
                    <div>${idea.type_label} · ${idea.exp_label} · $${idea.price}</div>
                    <div style="font-size:11px;color:#9ca3af;margin-top:2px">by ${idea.posted_by || 'Admin'}</div>
                `;
                toast.addEventListener('click', () => {
                    applyIdea(idea);
                    toast.remove();
                });
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 5200);
            }

            // ══════════════════════════════════════════════════════
            //  APPLY IDEA — navigate to the contract + track price
            // ══════════════════════════════════════════════════════
            async function applyIdea(idea) {
                // Store idea price for the badge
                activeIdeaPrice = {
                    price: idea.price,
                    action: idea.action,
                    timestamp: idea.timestamp,
                    posted_by: idea.posted_by
                };

                // Show idea price badge in header
                const badge = document.getElementById('idea-price-badge');
                const valEl = document.getElementById('idea-price-value');
                if (badge && valEl) {
                    valEl.textContent = `$${idea.price.toFixed(2)}`;
                    valEl.style.color = idea.action === 'BUY' ? '#26a69a' : '#ef5350';
                    badge.classList.add('visible');
                }

                // Switch to watchlist tab (so chart is focus)
                switchTab('watchlist');

                // Set symbol
                currentSymbol = idea.symbol;
                renderWatchlist();

                // Set call/put
                syncCallPut(idea.right);

                // Load expirations
                await loadExpirations(idea.symbol, false);
                const expSelect = document.getElementById('expiration');
                if (expSelect.querySelector(`option[value="${idea.expiration}"]`)) {
                    expSelect.value = idea.expiration;
                }

                // Load strikes for that exp
                await loadStrikes(idea.symbol, idea.expiration, false);
                const strikeSelect = document.getElementById('strike');
                if (strikeSelect.querySelector(`option[value="${idea.strike}"]`)) {
                    strikeSelect.value = String(idea.strike);
                    syncStrikeMatrix();
                }

                // Analyze
                await analyze();
            }

            // Expose refresh + applyIdea for external use
            window.refreshIdeas = function() { ideasLoaded = false; loadIdeas(); };
            window.applyIdea = applyIdea;
            window.switchSidebarTab = switchTab;
        })();

        // ===== MOBILE EVENT LISTENERS =====
        // Mobile toggle buttons (old, kept for landscape)
        document.getElementById('mobile-menu-toggle').addEventListener('click', toggleWatchlist);
        document.getElementById('mobile-analysis-toggle').addEventListener('click', toggleAnalysis);

        // Mobile close buttons
        document.getElementById('watchlist-done-btn').addEventListener('click', closeWatchlist);
        document.getElementById('analysis-done-btn').addEventListener('click', closeAnalysis);

        // Backdrop click to close
        document.getElementById('backdrop').addEventListener('click', closeAllMobilePanels);

        // Window resize handler
        window.addEventListener('resize', handleResize);

        // ===== MOBILE BOTTOM NAV =====
        document.getElementById('nav-watchlist').addEventListener('click', () => {
            const sidebar = document.getElementById('watchlist-sidebar');
            if (sidebar.classList.contains('mobile-open') && !document.querySelector('.watchlist-tab[data-tab="ideas"].active')) {
                closeWatchlist();
                setActiveNav('nav-chart');
            } else {
                if (window.switchSidebarTab) window.switchSidebarTab('watchlist');
                openWatchlist();
                setActiveNav('nav-watchlist');
            }
        });

        document.getElementById('nav-chart').addEventListener('click', () => {
            closeAllMobilePanels();
            setActiveNav('nav-chart');
            // Collapse controls to maximize chart view
            collapseControls();
        });

        document.getElementById('nav-settings').addEventListener('click', () => {
            if (!controlsCollapsed) {
                collapseControls();
                setActiveNav('nav-chart');
            } else {
                expandControls();
                setActiveNav('nav-settings');
            }
        });

        // Done button in settings sheet header
        document.getElementById('settings-done-btn').addEventListener('click', () => {
            collapseControls();
            setActiveNav('nav-chart');
        });

        // Setup mobile exp calendar
        setupExpCalendarEvents();

        document.getElementById('nav-ideas').addEventListener('click', () => {
            const sidebar = document.getElementById('watchlist-sidebar');
            if (sidebar.classList.contains('mobile-open') && document.querySelector('.watchlist-tab[data-tab="ideas"].active')) {
                closeWatchlist();
                setActiveNav('nav-chart');
            } else {
                if (window.switchSidebarTab) window.switchSidebarTab('ideas');
                openWatchlist();
                setActiveNav('nav-ideas');
            }
        });

        document.getElementById('nav-analysis').addEventListener('click', () => {
            const sidebar = document.getElementById('analysis-sidebar');
            if (sidebar.classList.contains('mobile-open')) {
                closeAnalysis();
                setActiveNav('nav-chart');
            } else {
                openAnalysis();
                setActiveNav('nav-analysis');
            }
        });

        // Mobile action banner tap opens analysis
        document.getElementById('mobile-action-banner').addEventListener('click', () => {
            openAnalysis();
        });
        
        // ===== INITIALIZATION =====
        async function init() {
            const urlP = getUrlParams();

            // Set interval from URL or default 5
            if (urlP.interval) {
                currentInterval = parseInt(urlP.interval) || 5;
                document.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`.interval-btn[data-interval="${currentInterval}"]`).forEach(b => b.classList.add('active'));
            }

            // Set date range from URL or default 5D
            const today = new Date();
            const rangeDays = urlP.range ? parseInt(urlP.range) : 5;
            const startFrom = new Date(today);
            startFrom.setDate(today.getDate() - rangeDays);
            document.getElementById('start-date').value = startFrom.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            // Activate correct range button
            document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll(`.date-range-btn[data-range="${rangeDays}"]`).forEach(b => b.classList.add('active'));

            // Set call/put from URL
            if (urlP.right === 'P' || urlP.right === 'C') {
                syncCallPut(urlP.right);
            }

            // Restore confidence from URL
            if (urlP.conf) {
                const confVal = parseInt(urlP.conf);
                if ([50, 60, 70, 80, 90].includes(confVal)) {
                    minConfidence = confVal;
                    document.querySelectorAll('.conf-btn').forEach(b => {
                        b.classList.toggle('active', parseInt(b.dataset.conf) === confVal);
                    });
                }
            }

            // Restore signal toggles from URL
            if (urlP.signals) {
                const sigs = urlP.signals.split(',');
                sigs.forEach(sig => {
                    const cb = document.getElementById('filter-' + sig);
                    if (cb) {
                        cb.checked = true;
                        const label = document.querySelector(`[data-for="filter-${sig}"]`);
                        if (label) label.classList.add('active');
                    }
                });
            }
            
            // Init charts
            initCharts();
            
            // Initialize mobile controls visibility and state
            if (isMobile()) {
                const controlsSummary = document.getElementById('controls-summary');
                if (controlsSummary) {
                    controlsSummary.classList.add('active');
                    collapseControls();
                }
            }
            
            // Load watchlist prices via REST first (needed for ATM calculation)
            await loadWatchlistPrices();
            
            // Select symbol from URL or default QQQ
            const initSymbol = urlP.symbol || 'QQQ';

            // If URL has full params (exp+strike), do targeted init without auto-analyze
            if (urlP.exp && urlP.strike) {
                currentSymbol = initSymbol;
                renderWatchlist();
                updateMobileUnderlyingPrice();
                // Load expirations, then set the URL exp
                await loadExpirations(initSymbol, false);
                const expSelect = document.getElementById('expiration');
                if (expSelect.querySelector(`option[value="${urlP.exp}"]`)) {
                    expSelect.value = urlP.exp;
                }
                // Load strikes for that exp, then set URL strike
                await loadStrikes(initSymbol, expSelect.value, false);
                const strikeSelect = document.getElementById('strike');
                if (strikeSelect.querySelector(`option[value="${urlP.strike}"]`)) {
                    strikeSelect.value = urlP.strike;
                    syncStrikeMatrix();
                }
                // Now analyze with all params set
                analyze().catch(e => console.warn('URL-param auto-analyze failed:', e));
            } else {
                selectSymbol(initSymbol);
            }
            
            // Start watchlist WebSocket for 1/sec price streaming
            connectWatchlistWs();
        }
        
        init();
    </script>
</body>
</html>
